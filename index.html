
<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏ó‡∏µ‡∏°‡πÄ‡∏ù‡πâ‡∏≤‡∏£‡∏∞‡∏ß‡∏±‡∏á‡∏™‡∏≠‡∏ö‡∏™‡∏ß‡∏ô‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡πá‡∏ß ‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£</title>
    <link href="https://fonts.googleapis.com/css2?family=Anuphan:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- SheetJS library for Excel import -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    
    <!-- Firebase SDK -->
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-analytics.js";
        import { getDatabase, ref, set, get, child, push, update, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        // Your web app's Firebase configuration
        // For Firebase JS SDK v7.20.0 and later, measurementId is optional
        const firebaseConfig = {
            apiKey: "AIzaSyBeCKoVceDGwX0EA3IEPEsmGULkzm3ddnE",
            authDomain: "bmasrrt.firebaseapp.com",
            databaseURL: "https://bmasrrt-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "bmasrrt",
            storageBucket: "bmasrrt.firebasestorage.app",
            messagingSenderId: "91632560633",
            appId: "1:91632560633:web:313015041e20d883dc7528",
            measurementId: "G-N4FC1EJRHJ"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const database = getDatabase(app);
        const auth = getAuth(app);

        // Make Firebase services available globally
        window.firebaseApp = app;
        window.firebaseDatabase = database;
        window.firebaseAuth = auth;
        window.firebaseRef = ref;
        window.firebaseSet = set;
        window.firebaseGet = get;
        window.firebaseChild = child;
        window.firebasePush = push;
        window.firebaseUpdate = update;
        window.firebaseRemove = remove;
        window.firebaseSignInWithEmailAndPassword = signInWithEmailAndPassword;
        window.firebaseCreateUserWithEmailAndPassword = createUserWithEmailAndPassword;
        window.firebaseSignOut = signOut;
    </script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        'anuphan': ['Anuphan', 'sans-serif']
                    },
                    colors: {
                        'dark-green': '#1e3a2e',
                        'medium-green': '#2d5a3d',
                        'light-green': '#4a7c59'
                    }
                }
            }
        }
    </script>
</head>
<body class="font-anuphan bg-gray-100 min-h-screen">
    <!-- Login Page -->
    <div id="loginPage" class="min-h-screen flex items-center justify-center bg-gradient-to-br from-dark-green to-medium-green">
        <div class="bg-white p-8 rounded-lg shadow-2xl w-full max-w-md">
            <div class="text-center mb-8">
                <h1 class="text-2xl font-bold text-dark-green mb-2">‡∏ó‡∏µ‡∏°‡πÄ‡∏ù‡πâ‡∏≤‡∏£‡∏∞‡∏ß‡∏±‡∏á‡∏™‡∏≠‡∏ö‡∏™‡∏ß‡∏ô‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡πá‡∏ß</h1>
                <p class="text-gray-600">‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£</p>
            </div>
            <form id="loginForm" class="space-y-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</label>
                    <input type="text" id="username" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-medium-green" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</label>
                    <input type="password" id="password" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-medium-green" required>
                </div>
                <button type="submit" id="loginBtn" class="w-full bg-medium-green text-white py-2 px-4 rounded-md hover:bg-dark-green transition duration-200">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
            </form>
            
            <!-- Register Form -->
            <form id="registerForm" class="space-y-6 hidden">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</label>
                    <input type="text" id="regUsername" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-medium-green" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</label>
                    <input type="password" id="regPassword" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-medium-green" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</label>
                    <input type="password" id="regConfirmPassword" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-medium-green" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</label>
                    <input type="text" id="regFullName" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-medium-green" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó</label>
                    <select id="regRole" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-medium-green" required>
                        <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó</option>
                        <option value="officer">‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà</option>
                        <option value="admin">‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">‡∏£‡∏´‡∏±‡∏™‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô</label>
                    <input type="text" id="regOrgId" placeholder="‡πÄ‡∏ä‡πà‡∏ô BMA001, BMA002" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-medium-green" required>
                </div>
                <button type="submit" id="registerBtn" class="w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 transition duration-200">‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</button>
            </form>
            
            <div id="loginError" class="mt-4 text-red-600 text-sm text-center hidden"></div>
            
            <!-- Toggle between Login and Register -->
            <div class="mt-6 text-center">
                <button id="toggleToRegister" class="text-medium-green hover:text-dark-green text-sm">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ? ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà</button>
                <button id="toggleToLogin" class="text-medium-green hover:text-dark-green text-sm hidden">‡∏°‡∏µ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÅ‡∏•‡πâ‡∏ß? ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
            </div>
            
            <!-- Firebase Connection Status -->
            <div id="connectionStatus" class="mt-4 text-xs text-center">
                <span class="text-gray-500">üîÑ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠...</span>
            </div>
        </div>
    </div>

    <!-- Main Application -->
    <div id="mainApp" class="hidden">
        <!-- Navigation -->
        <nav class="bg-dark-green text-white shadow-lg">
            <div class="max-w-7xl mx-auto px-4">
                <div class="flex justify-between items-center py-4">
                    <div class="flex items-center space-x-4">
                        <h1 class="text-xl font-bold">‡∏ó‡∏µ‡∏°‡πÄ‡∏ù‡πâ‡∏≤‡∏£‡∏∞‡∏ß‡∏±‡∏á‡∏™‡∏≠‡∏ö‡∏™‡∏ß‡∏ô‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡πá‡∏ß ‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£</h1>
                    </div>
                    <div class="flex items-center space-x-4">
                        <span id="currentUser" class="text-sm"></span>
                        <button id="logoutBtn" class="bg-red-600 hover:bg-red-700 px-3 py-1 rounded text-sm">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
                    </div>
                </div>
                <div class="flex space-x-1 pb-4" id="navTabs">
                    <!-- Navigation tabs will be populated by JavaScript -->
                </div>
            </div>
        </nav>

        <!-- Content Area -->
        <div class="max-w-7xl mx-auto px-4 py-6">
            <!-- Officer Dashboard -->
            <div id="officerDashboard" class="tab-content hidden">
                <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
                    <h2 class="text-xl font-bold text-dark-green mb-6">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Ñ‡∏£‡∏∑‡∏≠‡∏Ç‡πà‡∏≤‡∏¢‡∏ó‡∏µ‡∏° SRRT</h2>
                    <!-- Search and Filter Section -->
                    <div class="mb-6 bg-gray-50 p-4 rounded-lg">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</label>
                                <input type="text" id="officerSearch" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏à‡∏≤‡∏Å‡∏ä‡∏∑‡πà‡∏≠ ‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà ‡∏´‡∏£‡∏∑‡∏≠‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô..." class="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-medium-green" onkeyup="searchOfficers()">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô</label>
                                <select id="orgFilter" class="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-medium-green" onchange="filterOfficers()">
                                    <option value="">‡∏ó‡∏∏‡∏Å‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏≠‡∏ö‡∏£‡∏°</label>
                                <select id="trainingFilter" class="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-medium-green" onchange="filterOfficers()">
                                    <option value="">‡∏ó‡∏∏‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</option>
                                    <option value="trained">‡∏ú‡πà‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏ö‡∏£‡∏°‡πÅ‡∏•‡πâ‡∏ß</option>
                                    <option value="not-trained">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏ö‡∏£‡∏°</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <!-- Organization blocks will be populated by JavaScript -->
                </div>
            </div>

            <!-- Team Management -->
            <div id="teamManagement" class="tab-content hidden">
                <div class="bg-white rounded-lg shadow-lg p-6">
                    <h2 class="text-xl font-bold text-dark-green mb-4">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡∏°</h2>
                    
                    <!-- Team Summary Section -->
                    <div class="bg-gradient-to-r from-blue-50 to-green-50 rounded-lg p-6 mb-6">
                        <h3 class="text-lg font-bold text-dark-green mb-4">‡∏™‡∏£‡∏∏‡∏õ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô</h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div class="bg-white rounded-lg p-4 shadow-sm">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-gray-600 text-sm">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</p>
                                        <p class="text-2xl font-bold text-blue-600" id="teamTotalMembers">-</p>
                                        <p class="text-gray-500 text-sm">‡∏Ñ‡∏ô</p>
                                    </div>
                                    <div class="text-3xl opacity-70">üë•</div>
                                </div>
                            </div>
                            <div class="bg-white rounded-lg p-4 shadow-sm">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-gray-600 text-sm">‡∏ú‡πà‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏ö‡∏£‡∏°‡πÅ‡∏•‡πâ‡∏ß</p>
                                        <p class="text-2xl font-bold text-green-600" id="teamTrainedMembers">-</p>
                                        <p class="text-gray-500 text-sm">‡∏Ñ‡∏ô</p>
                                    </div>
                                    <div class="text-3xl opacity-70">‚úÖ</div>
                                </div>
                            </div>
                            <div class="bg-white rounded-lg p-4 shadow-sm">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-gray-600 text-sm">‡πÄ‡∏õ‡∏≠‡∏£‡πå‡πÄ‡∏ã‡πá‡∏ô‡∏ï‡πå‡∏ó‡∏µ‡πà‡∏ú‡πà‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏ö‡∏£‡∏°</p>
                                        <p class="text-2xl font-bold text-purple-600" id="teamTrainingPercentage">-</p>
                                        <p class="text-gray-500 text-sm">%</p>
                                    </div>
                                    <div class="text-3xl opacity-70">üìä</div>
                                </div>
                            </div>
                        </div>
                        <div class="mt-4">
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-sm text-gray-600">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏Å‡∏≤‡∏£‡∏≠‡∏ö‡∏£‡∏°</span>
                                <span class="text-sm font-medium text-gray-700" id="teamProgressText">-</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-3">
                                <div class="bg-gradient-to-r from-green-400 to-green-600 h-3 rounded-full transition-all duration-500" id="teamProgressBar" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>

                    <!-- SRRT Team Summary Section -->
                    <div class="bg-gradient-to-r from-orange-50 to-red-50 rounded-lg p-6 mb-6">
                        <h3 class="text-lg font-bold text-dark-green mb-4">‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡∏° SRRT</h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div class="bg-white rounded-lg p-4 shadow-sm">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-gray-600 text-sm">‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏ó‡∏µ‡∏° SRRT</p>
                                        <p class="text-2xl font-bold text-blue-600" id="srrtTotalMembers">-</p>
                                        <p class="text-gray-500 text-sm">‡∏Ñ‡∏ô</p>
                                    </div>
                                    <div class="text-3xl opacity-70">üöë</div>
                                </div>
                            </div>
                            <div class="bg-white rounded-lg p-4 shadow-sm">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-gray-600 text-sm">‡∏ú‡πà‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏ö‡∏£‡∏°‡πÅ‡∏•‡πâ‡∏ß</p>
                                        <p class="text-2xl font-bold text-green-600" id="srrtTrainedMembers">-</p>
                                        <p class="text-gray-500 text-sm">‡∏Ñ‡∏ô</p>
                                    </div>
                                    <div class="text-3xl opacity-70">‚úÖ</div>
                                </div>
                            </div>
                            <div class="bg-white rounded-lg p-4 shadow-sm">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-gray-600 text-sm">‡πÄ‡∏õ‡∏≠‡∏£‡πå‡πÄ‡∏ã‡πá‡∏ô‡∏ï‡πå‡∏ó‡∏µ‡πà‡∏ú‡πà‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏ö‡∏£‡∏°</p>
                                        <p class="text-2xl font-bold text-purple-600" id="srrtTrainingPercentage">-</p>
                                        <p class="text-gray-500 text-sm">%</p>
                                    </div>
                                    <div class="text-3xl opacity-70">üìä</div>
                                </div>
                            </div>
                        </div>
                        <div class="mt-4">
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-sm text-gray-600">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏Å‡∏≤‡∏£‡∏≠‡∏ö‡∏£‡∏°‡∏ó‡∏µ‡∏° SRRT</span>
                                <span class="text-sm font-medium text-gray-700" id="srrtProgressText">-</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-3">
                                <div class="bg-gradient-to-r from-orange-400 to-red-600 h-3 rounded-full transition-all duration-500" id="srrtProgressBar" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>

                    <!-- View Mode for Organization Info -->
                    <div id="orgInfoViewMode" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4 mb-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">‡∏£‡∏´‡∏±‡∏™‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô</label>
                            <p class="text-lg font-semibold text-dark-green" id="viewOrgId">BMA001</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô</label>
                            <p class="text-lg font-semibold text-dark-green" id="viewOrgName">‡∏™‡∏≥‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÄ‡∏Ç‡∏ï‡∏ö‡∏≤‡∏á‡∏£‡∏±‡∏Å</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå</label>
                            <p class="text-lg font-semibold text-dark-green" id="viewOrgPhone">02-234-5678</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">‡πÇ‡∏ó‡∏£‡∏™‡∏≤‡∏£</label>
                            <p class="text-lg font-semibold text-dark-green" id="viewOrgFax">02-234-5679</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">‡∏≠‡∏µ‡πÄ‡∏°‡∏•</label>
                            <p class="text-lg font-semibold text-dark-green" id="viewOrgEmail">bangrak@bma.go.th</p>
                        </div>
                    </div>
                    <div class="mb-6">
                        <button onclick="toggleTeamOrgEditMode()" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô</button>
                    </div>
                    
                    <!-- Edit Mode for Organization Info -->
                    <div id="orgInfoEditMode" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4 mb-6" style="display: none;">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">‡∏£‡∏´‡∏±‡∏™‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô</label>
                            <p class="text-lg font-semibold text-dark-green" id="editViewOrgId">BMA001</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô</label>
                            <p class="text-lg font-semibold text-dark-green" id="editViewOrgName">‡∏™‡∏≥‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÄ‡∏Ç‡∏ï‡∏ö‡∏≤‡∏á‡∏£‡∏±‡∏Å</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå</label>
                            <input type="text" id="editPhone" value="02-234-5678" class="w-full px-3 py-1 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-medium-green">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">‡πÇ‡∏ó‡∏£‡∏™‡∏≤‡∏£</label>
                            <input type="text" id="editFax" value="02-234-5679" class="w-full px-3 py-1 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-medium-green">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">‡∏≠‡∏µ‡πÄ‡∏°‡∏•</label>
                            <input type="email" id="editEmail" value="bangrak@bma.go.th" class="w-full px-3 py-1 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-medium-green">
                        </div>
                    </div>
                    <div id="orgEditButtons" class="mb-6" style="display: none;">
                        <button onclick="toggleTeamOrgEditMode()" class="bg-gray-300 text-gray-700 px-4 py-2 rounded hover:bg-gray-400 mr-2">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                        <button onclick="saveOrgInfo()" class="bg-medium-green text-white px-4 py-2 rounded hover:bg-dark-green">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô</button>
                    </div>
                    
                    <!-- SRRT Team Members Table -->
                    <div class="mb-8">
                        <h3 class="text-lg font-bold text-dark-green mb-4">‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏ó‡∏µ‡∏° SRRT</h3>
                        <div class="overflow-x-auto">
                            <table class="min-w-full bg-white border border-gray-200">
                                <thead class="bg-blue-600 text-white">
                                    <tr>
                                        <th class="px-4 py-2 text-left">‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà</th>
                                        <th class="px-4 py-2 text-left">‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•</th>
                                        <th class="px-4 py-2 text-left">‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</th>
                                        <th class="px-4 py-2 text-left">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå</th>
                                        <th class="px-4 py-2 text-left">‡∏≠‡∏µ‡πÄ‡∏°‡∏•</th>
                                        <th class="px-4 py-2 text-center">‡∏Å‡∏≤‡∏£‡∏≠‡∏ö‡∏£‡∏°</th>
                                    </tr>
                                </thead>
                                <tbody id="srrtTeamTableBody">
                                    <!-- SRRT team members will be populated here -->
                                </tbody>
                            </table>
                        </div>
                        <div id="srrtTeamEmpty" class="text-center py-8 text-gray-500 hidden">
                            ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡πÉ‡∏ô‡∏ó‡∏µ‡∏° SRRT
                        </div>
                        
                        <!-- SRRT Position Summary -->
                        <div id="srrtPositionSummary" class="mt-4 p-4 bg-blue-50 rounded-lg border border-blue-200">
                            <h4 class="text-md font-semibold text-blue-800 mb-3 flex items-center">
                                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                                </svg>
                                ‡∏™‡∏£‡∏∏‡∏õ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà SRRT ‡∏ï‡∏≤‡∏°‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á
                            </h4>
                            <div id="srrtPositionSummaryContent" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3">
                                <!-- Position summary will be populated here -->
                            </div>
                        </div>
                    </div>

                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-bold text-dark-green">‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡πÉ‡∏ô‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô</h3>
                        <button onclick="showAddMemberModal()" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡πÉ‡∏´‡∏°‡πà</button>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full bg-white border border-gray-200">
                            <thead class="bg-medium-green text-white">
                                <tr>
                                    <th class="px-4 py-2 text-left">‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà</th>
                                    <th class="px-4 py-2 text-left">‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•</th>
                                    <th class="px-4 py-2 text-left">‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</th>
                                    <th class="px-4 py-2 text-left">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå</th>
                                    <th class="px-4 py-2 text-left">‡∏≠‡∏µ‡πÄ‡∏°‡∏•</th>
                                    <th class="px-4 py-2 text-center">‡∏Å‡∏≤‡∏£‡∏≠‡∏ö‡∏£‡∏°</th>
                                    <th class="px-4 py-2 text-center">‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà SRRT</th>
                                    <th class="px-4 py-2 text-center">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                                </tr>
                            </thead>
                            <tbody id="teamTableBody">
                                <!-- Team members will be populated here -->
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- All Officers Position Summary -->
                    <div id="allOfficersPositionSummary" class="mt-4 p-4 bg-green-50 rounded-lg border border-green-200">
                        <h4 class="text-md font-semibold text-green-800 mb-3 flex items-center">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                            </svg>
                            ‡∏™‡∏£‡∏∏‡∏õ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡πÉ‡∏ô‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô‡∏ï‡∏≤‡∏°‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á
                        </h4>
                        <div id="allOfficersPositionSummaryContent" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3">
                            <!-- Position summary will be populated here -->
                        </div>
                    </div>
                    
                    <!-- Confirmation Section -->
                    <div id="confirmationSection" class="mt-6 p-4 bg-gray-50 rounded-lg">
                        <div class="flex items-center justify-between">
                            <div>
                                <h4 class="text-lg font-semibold text-dark-green">‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h4>
                                <p class="text-sm text-gray-600 mt-1">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡∏°‡πÅ‡∏•‡∏∞‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡πà‡∏á‡πÉ‡∏´‡πâ‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö</p>
                            </div>
                            <div class="flex space-x-3">
                                <div class="text-center">
                                    <div class="text-sm text-gray-600">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡∏°:</div>
                                    <span id="teamConfirmStatus" class="inline-block px-3 py-1 rounded text-sm font-medium">-</span>
                                </div>
                                <div class="text-center">
                                    <div class="text-sm text-gray-600">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô:</div>
                                    <span id="orgConfirmStatus" class="inline-block px-3 py-1 rounded text-sm font-medium">-</span>
                                </div>
                                <button id="confirmTeamDataBtn" onclick="confirmTeamDataEnhanced()" class="bg-green-600 text-white px-6 py-2 rounded hover:bg-green-700 disabled:bg-gray-400 disabled:cursor-not-allowed">
                                    ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏∏‡∏•
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Confirmed Message (Hidden by default) -->
                    <div id="confirmedMessage" class="mt-6 p-4 bg-green-50 border border-green-200 rounded-lg hidden">
                        <div class="flex items-center">
                            <div class="flex-shrink-0">
                                <svg class="h-5 w-5 text-green-400" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
                                </svg>
                            </div>
                            <div class="ml-3">
                                <h4 class="text-sm font-medium text-green-800">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß</h4>
                                <p class="text-sm text-green-700 mt-1">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á‡∏ó‡πà‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏•‡πâ‡∏ß ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏à‡∏≤‡∏Å‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>



            <!-- Admin - Summary Report -->
            <div id="summaryReport" class="tab-content hidden">
                <div class="space-y-6">
                    <!-- ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 1: ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏ó‡∏µ‡∏° SRRT ‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£ -->
                    <div class="bg-white rounded-lg shadow-lg p-6">
                        <h2 class="text-xl font-bold text-dark-green mb-6">‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 1: ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏ó‡∏µ‡∏° SRRT ‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                            <div class="bg-gradient-to-r from-blue-500 to-blue-600 text-white p-6 rounded-lg">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-blue-100 text-sm">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡∏°</p>
                                        <p class="text-3xl font-bold" id="totalTeams">-</p>
                                        <p class="text-blue-100 text-sm">‡∏ó‡∏µ‡∏°</p>
                                    </div>
                                    <div class="text-4xl opacity-80">üè¢</div>
                                </div>
                            </div>
                            <div class="bg-gradient-to-r from-green-500 to-green-600 text-white p-6 rounded-lg">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-green-100 text-sm">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡πÉ‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</p>
                                        <p class="text-3xl font-bold" id="totalOfficers">-</p>
                                        <p class="text-green-100 text-sm">‡∏Ñ‡∏ô</p>
                                    </div>
                                    <div class="text-4xl opacity-80">üë•</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- ‡∏™‡∏£‡∏∏‡∏õ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á -->
                        <div class="bg-gray-50 rounded-lg p-6">
                            <h3 class="text-lg font-semibold text-gray-800 mb-4">üìä ‡∏™‡∏£‡∏∏‡∏õ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÉ‡∏ô‡∏ó‡∏µ‡∏° SRRT</h3>
                            <div id="positionSummaryCards" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                <!-- Position summary cards will be populated here -->
                            </div>
                        </div>
                    </div>

                    <!-- ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 2: ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô -->
                    <div class="bg-white rounded-lg shadow-lg p-6">
                        <h2 class="text-xl font-bold text-dark-green mb-6">‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 2: ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô</h2>
                        <div class="overflow-x-auto">
                            <table class="min-w-full bg-white border border-gray-200">
                                <thead class="bg-medium-green text-white">
                                    <tr>
                                        <th class="px-4 py-2 text-left">‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô</th>
                                        <th class="px-4 py-2 text-center">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡πÉ‡∏ô‡∏ó‡∏µ‡∏°</th>
                                        <th class="px-4 py-2 text-center">‡∏ú‡πà‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏ö‡∏£‡∏°‡πÅ‡∏•‡πâ‡∏ß</th>
                                        <th class="px-4 py-2 text-center">‡πÄ‡∏õ‡∏≠‡∏£‡πå‡πÄ‡∏ã‡πá‡∏ô‡∏ï‡πå‡∏ó‡∏µ‡πà‡∏ú‡πà‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏ö‡∏£‡∏°</th>
                                    </tr>
                                </thead>
                                <tbody id="orgSummaryTableBody">
                                    <!-- Organization summary will be populated here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Admin - All Officers Database -->
            <div id="allOfficersDB" class="tab-content hidden">
                <div class="bg-white rounded-lg shadow-lg p-6">
                    <!-- ‡∏ä‡πà‡∏≠‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÅ‡∏•‡∏∞‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á -->
                    <div class="mb-6 bg-gray-50 p-4 rounded-lg">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</label>
                                <input type="text" id="officerSearchInput" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠, ‡∏£‡∏´‡∏±‡∏™, ‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô..." class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-medium-green focus:border-transparent">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô</label>
                                <select id="officerOrgFilter" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-medium-green focus:border-transparent">
                                    <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏≠‡∏ö‡∏£‡∏°</label>
                                <select id="officerTrainingFilter" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-medium-green focus:border-transparent">
                                    <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                                    <option value="trained">‡∏ú‡πà‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏ö‡∏£‡∏°‡πÅ‡∏•‡πâ‡∏ß</option>
                                    <option value="not-trained">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏≠‡∏ö‡∏£‡∏°</option>
                                </select>
                            </div>
                        </div>
                        <div class="mt-4 flex gap-2">
                            <button onclick="applyOfficerFilters()" class="bg-medium-green text-white px-4 py-2 rounded-lg hover:bg-dark-green transition-colors">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</button>
                            <button onclick="clearOfficerFilters()" class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition-colors">‡∏•‡πâ‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</button>
                        </div>
                    </div>
                    
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-xl font-bold text-dark-green">‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà</h2>
                        <div class="flex space-x-2">
                            <button onclick="exportOfficersToExcel()" class="bg-orange-600 text-white px-4 py-2 rounded hover:bg-orange-700">‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡πÄ‡∏õ‡πá‡∏ô Excel</button>
                            <button onclick="showImportOfficersModal()" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏à‡∏≤‡∏Å Excel</button>
                            <button onclick="showAddOfficerModal()" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡πÉ‡∏´‡∏°‡πà</button>
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full bg-white border border-gray-200">
                            <thead class="bg-medium-green text-white">
                                <tr>
                                    <th class="px-4 py-2 text-left">‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà</th>
                                    <th class="px-4 py-2 text-left">‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•</th>
                                    <th class="px-4 py-2 text-left">‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</th>
                                    <th class="px-4 py-2 text-left">‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô</th>
                                    <th class="px-4 py-2 text-center">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏∑‡πà‡∏ô ‡πÜ</th>
                                    <th class="px-4 py-2 text-center">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ä‡∏∑‡πà‡∏≠</th>
                                    <th class="px-4 py-2 text-center">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</th>
                                    <th class="px-4 py-2 text-center">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                                </tr>
                            </thead>
                            <tbody id="allOfficersTableBody">
                                <!-- All officers will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Admin - Training Database -->
            <div id="trainingDB" class="tab-content hidden">
                <div class="bg-white rounded-lg shadow-lg p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-xl font-bold text-dark-green">‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏≠‡∏ö‡∏£‡∏°</h2>
                        <div class="flex space-x-2">
                            <button onclick="showAddYearModal()" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏õ‡∏µ</button>
                            <button onclick="showDeleteYearModal()" class="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700">‡∏•‡∏ö‡∏õ‡∏µ</button>
                        </div>
                    </div>
                    
                    <!-- ‡∏ä‡πà‡∏≠‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÅ‡∏•‡∏∞‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á -->
                    <div class="mb-6 bg-gray-50 p-4 rounded-lg">
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</label>
                                <input type="text" id="trainingSearchInput" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠, ‡∏£‡∏´‡∏±‡∏™, ‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô..." class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-medium-green focus:border-transparent">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô</label>
                                <select id="trainingOrgFilter" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-medium-green focus:border-transparent">
                                    <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                                    <!-- Organizations will be populated dynamically -->
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏õ‡∏µ</label>
                                <select id="trainingYearFilter" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-medium-green focus:border-transparent">
                                    <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                                    <option value="trained">‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏≠‡∏ö‡∏£‡∏°</option>
                                    <option value="not-trained">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏≠‡∏ö‡∏£‡∏°</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏µ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏î‡∏π</label>
                                <select id="trainingSpecificYearFilter" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-medium-green focus:border-transparent">
                                    <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                                    <!-- Years will be populated dynamically -->
                                </select>
                            </div>
                        </div>
                        <div class="mt-4 flex gap-2">
                            <button onclick="applyTrainingFilters()" class="bg-medium-green text-white px-4 py-2 rounded-lg hover:bg-dark-green transition-colors">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</button>
                            <button onclick="clearTrainingFilters()" class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition-colors">‡∏•‡πâ‡∏≤‡∏á‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á</button>
                            <button onclick="exportTrainingData()" class="bg-orange-600 text-white px-4 py-2 rounded-lg hover:bg-orange-700 transition-colors">‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å Excel</button>
                            <button onclick="showImportTrainingModal()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors">‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤ Excel</button>
                        </div>
                    </div>
                    
                    <!-- ‡πÅ‡∏™‡∏î‡∏á‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå -->
                    <div class="mb-2">
                        <span id="trainingResultInfo" class="text-sm text-gray-600"></span>
                    </div>
                    
                    <div class="overflow-x-auto">
                        <table class="min-w-full bg-white border border-gray-200">
                            <thead class="bg-medium-green text-white" id="trainingTableHeader">
                                <!-- Table header will be populated dynamically -->
                            </thead>
                            <tbody id="trainingTableBody">
                                <!-- Training data will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Admin - Organizations Database -->
            <div id="organizationsDB" class="tab-content hidden">
                <div class="bg-white rounded-lg shadow-lg p-6">
                    <!-- ‡∏ä‡πà‡∏≠‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÅ‡∏•‡∏∞‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á -->
                    <div class="mb-6 bg-gray-50 p-4 rounded-lg">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</label>
                                <input type="text" id="orgSearchInput" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô, ‡∏£‡∏´‡∏±‡∏™..." class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-medium-green focus:border-transparent">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</label>
                                <select id="orgMemberFilter" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-medium-green focus:border-transparent">
                                    <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                                    <option value="1-5">1-5 ‡∏Ñ‡∏ô</option>
                                    <option value="6-10">6-10 ‡∏Ñ‡∏ô</option>
                                    <option value="11-20">11-20 ‡∏Ñ‡∏ô</option>
                                    <option value="21+">21+ ‡∏Ñ‡∏ô</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</label>
                                <select id="orgConfirmFilter" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-medium-green focus:border-transparent">
                                    <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                                    <option value="confirmed">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏•‡πâ‡∏ß</option>
                                    <option value="pending">‡∏£‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</option>
                                </select>
                            </div>
                        </div>
                        <div class="mt-4 flex gap-2">
                            <button onclick="applyOrgFilters()" class="bg-medium-green text-white px-4 py-2 rounded-lg hover:bg-dark-green transition-colors">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</button>
                            <button onclick="clearOrgFilters()" class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition-colors">‡∏•‡πâ‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</button>
                        </div>
                    </div>
                    
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-xl font-bold text-dark-green">‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô</h2>
                        <div class="flex space-x-2">
                            <button onclick="showImportOrganizationsModal()" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏à‡∏≤‡∏Å Excel</button>
                            <button onclick="resetAllConfirmationStatus()" class="bg-orange-600 text-white px-4 py-2 rounded hover:bg-orange-700" title="‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î">‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
                            <button onclick="showAddOrgModal()" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà</button>
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full bg-white border border-gray-200">
                            <thead class="bg-medium-green text-white">
                                <tr>
                                    <th class="px-4 py-2 text-left">‡∏£‡∏´‡∏±‡∏™‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô</th>
                                    <th class="px-4 py-2 text-left">‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô</th>
                                    <th class="px-4 py-2 text-left">‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå</th>
                                    <th class="px-4 py-2 text-left">‡πÇ‡∏ó‡∏£‡∏™‡∏≤‡∏£</th>
                                    <th class="px-4 py-2 text-left">‡∏≠‡∏µ‡πÄ‡∏°‡∏•</th>
                                    <th class="px-4 py-2 text-center">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</th>
                                    <th class="px-4 py-2 text-center">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                                </tr>
                            </thead>
                            <tbody id="organizationsTableBody">
                                <!-- Organizations will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Admin - User Accounts -->
            <div id="userAccounts" class="tab-content hidden">
                <div class="bg-white rounded-lg shadow-lg p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-xl font-bold text-dark-green">‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</h2>
                        <button onclick="showAddUserModal()" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÉ‡∏´‡∏°‡πà</button>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full bg-white border border-gray-200">
                            <thead class="bg-medium-green text-white">
                                <tr>
                                    <th class="px-4 py-2 text-left">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</th>
                                    <th class="px-4 py-2 text-left">‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô</th>
                                    <th class="px-4 py-2 text-left">Username</th>
                                    <th class="px-4 py-2 text-left">Password</th>
                                    <th class="px-4 py-2 text-left">‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á</th>
                                    <th class="px-4 py-2 text-center">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                                </tr>
                            </thead>
                            <tbody id="userAccountsTableBody">
                                <!-- User accounts will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Admin - Positions Database -->
            <div id="positionsDB" class="tab-content hidden">
                <div class="bg-white rounded-lg shadow-lg p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-xl font-bold text-dark-green">‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</h2>
                        <button onclick="showAddPositionModal()" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÉ‡∏´‡∏°‡πà</button>
                    </div>
                    
                    <!-- Search and Filter Section -->
                    <div class="bg-gray-50 p-4 rounded-lg mb-6">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</label>
                                <input type="text" id="positionSearchInput" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á..." class="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-medium-green" oninput="applyPositionFilters()">
                            </div>
                            <div class="flex items-end">
                                <button onclick="clearPositionFilters()" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">‡∏•‡πâ‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏≠‡∏á</button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="overflow-x-auto">
                        <table class="min-w-full bg-white border border-gray-200">
                            <thead class="bg-medium-green text-white">
                                <tr>
                                    <th class="px-4 py-2 text-left">‡∏£‡∏´‡∏±‡∏™‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</th>
                                    <th class="px-4 py-2 text-left">‡∏ä‡∏∑‡πà‡∏≠‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</th>
                                    <th class="px-4 py-2 text-left">‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢</th>
                                    <th class="px-4 py-2 text-center">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                                </tr>
                            </thead>
                            <tbody id="positionsTableBody">
                                <!-- Positions will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Admin - Activity Log -->
            <div id="activityLog" class="tab-content hidden">
                <div class="bg-white rounded-lg shadow-lg p-6">
                    <h2 class="text-xl font-bold text-dark-green mb-6">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h2>
                    <div class="overflow-x-auto">
                        <table class="min-w-full bg-white border border-gray-200">
                            <thead class="bg-medium-green text-white">
                                <tr>
                                    <th class="px-4 py-2 text-left">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
                                    <th class="px-4 py-2 text-left">‡πÄ‡∏ß‡∏•‡∏≤</th>
                                    <th class="px-4 py-2 text-left">‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</th>
                                    <th class="px-4 py-2 text-left">‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥</th>
                                    <th class="px-4 py-2 text-left">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</th>
                                    <th class="px-4 py-2 text-center">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                                </tr>
                            </thead>
                            <tbody id="activityLogTableBody">
                                <!-- Activity log will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div id="modalOverlay" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div id="modalContent" class="bg-white rounded-lg shadow-xl max-w-md w-full p-6">
                <!-- Modal content will be populated by JavaScript -->
            </div>
        </div>
    </div>

    <script>
        // Sample data
        let currentUser = null;
        let userRole = null;
        
        const users = [];

        const organizations = [];

        const officers = [];

        const positions = [];

        const trainingData = {};

        // Training years management
        let trainingYears = []; // Will be loaded from database

        const activityLog = [];

        // Name change history for officers
        const nameHistory = {}; // ‡πÄ‡∏Å‡πá‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•

        // Confirmation status for each organization
        const confirmationStatus = {};

        // Firebase functions
        async function initializeFirebaseData() {
            try {
                console.log('Initializing Firebase data...');
                
                // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô Firebase ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
                const usersSnapshot = await window.firebaseGet(window.firebaseRef(window.firebaseDatabase, 'users'));
                const existingUsers = usersSnapshot.val();
                
                if (!existingUsers || (Array.isArray(existingUsers) && existingUsers.length === 0) || Object.keys(existingUsers).length === 0) {
                    // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÅ‡∏£‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö
                    const defaultUser = { 
                        username: 'admin', 
                        password: 'admin123', 
                        name: '‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö', 
                        role: 'admin', 
                        orgId: 'ADMIN',
                        createdAt: new Date().toISOString()
                    };
                    
                    // ‡πÉ‡∏ä‡πâ push() ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á unique key
                    const userRef = window.firebasePush(window.firebaseRef(window.firebaseDatabase, 'users'));
                    await window.firebaseSet(userRef, defaultUser);
                    await window.firebaseSet(window.firebaseRef(window.firebaseDatabase, 'organizations'), organizations);
                    await window.firebaseSet(window.firebaseRef(window.firebaseDatabase, 'officers'), officers);
                    await window.firebaseSet(window.firebaseRef(window.firebaseDatabase, 'positions'), positions);
                    await window.firebaseSet(window.firebaseRef(window.firebaseDatabase, 'trainingData'), trainingData);
                    await window.firebaseSet(window.firebaseRef(window.firebaseDatabase, 'activityLog'), activityLog);
                    await window.firebaseSet(window.firebaseRef(window.firebaseDatabase, 'confirmationStatus'), confirmationStatus);
                    
                    console.log('Default admin user created in Firebase');
                } else {
                    console.log('Data already exists in Firebase');
                }
                
                // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Firebase
                await loadDataFromFirebase();
                
            } catch (error) {
                console.error('Error initializing Firebase data:', error);
            }
        }
        
        async function loadDataFromFirebase() {
            try {
                console.log('Starting to load data from Firebase...');
                
                // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏à‡∏≤‡∏Å Firebase
                const [usersSnap, orgsSnap, officersSnap, positionsSnap, trainingSnap, trainingYearsSnap, activitySnap, confirmSnap, nameHistorySnap] = await Promise.all([
                    window.firebaseGet(window.firebaseRef(window.firebaseDatabase, 'users')),
                    window.firebaseGet(window.firebaseRef(window.firebaseDatabase, 'organizations')),
                    window.firebaseGet(window.firebaseRef(window.firebaseDatabase, 'officers')),
                    window.firebaseGet(window.firebaseRef(window.firebaseDatabase, 'positions')),
                    window.firebaseGet(window.firebaseRef(window.firebaseDatabase, 'trainingData')),
                    window.firebaseGet(window.firebaseRef(window.firebaseDatabase, 'trainingYears')),
                    window.firebaseGet(window.firebaseRef(window.firebaseDatabase, 'activityLog')),
                    window.firebaseGet(window.firebaseRef(window.firebaseDatabase, 'confirmationStatus')),
                    window.firebaseGet(window.firebaseRef(window.firebaseDatabase, 'nameHistory'))
                ]);
                
                console.log('Firebase snapshots received');
                
                // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï local arrays ‡∏î‡πâ‡∏ß‡∏¢‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Firebase
                if (usersSnap.val()) {
                    users.length = 0;
                    const firebaseUsers = usersSnap.val();
                    if (Array.isArray(firebaseUsers)) {
                        users.push(...firebaseUsers);
                    } else {
                        // Firebase ‡∏Ñ‡∏∑‡∏ô Object, ‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô Array
                        const userArray = Object.values(firebaseUsers);
                        users.push(...userArray);
                    }
                    console.log('Loaded users from Firebase:', users.length, 'users');
                }
                
                if (orgsSnap.val()) {
                    organizations.length = 0;
                    const firebaseOrgs = orgsSnap.val();
                    if (Array.isArray(firebaseOrgs)) {
                        organizations.push(...firebaseOrgs);
                    } else {
                        const orgArray = Object.values(firebaseOrgs);
                        organizations.push(...orgArray);
                    }
                    console.log('Loaded organizations from Firebase:', organizations.length, 'organizations');
                }
                
                if (officersSnap.val()) {
                    officers.length = 0;
                    const firebaseOfficers = officersSnap.val();
                    if (Array.isArray(firebaseOfficers)) {
                        officers.push(...firebaseOfficers);
                    } else {
                        const officerArray = Object.values(firebaseOfficers);
                        officers.push(...officerArray);
                    }
                    console.log('Loaded officers from Firebase:', officers.length, 'officers');
                }
                
                if (positionsSnap.val()) {
                    positions.length = 0;
                    const firebasePositions = positionsSnap.val();
                    if (Array.isArray(firebasePositions)) {
                        positions.push(...firebasePositions);
                    } else {
                        const positionArray = Object.values(firebasePositions);
                        positions.push(...positionArray);
                    }
                    console.log('Loaded positions from Firebase:', positions.length, 'positions');
                }
                
                if (trainingSnap.val()) {
                    // ‡∏•‡πâ‡∏≤‡∏á trainingData ‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏≠‡∏≤‡πÉ‡∏´‡∏°‡πà
                    Object.keys(trainingData).forEach(key => delete trainingData[key]);
                    Object.assign(trainingData, trainingSnap.val());
                    console.log('Loaded training data from Firebase');
                }
                
                if (trainingYearsSnap.val()) {
                    trainingYears.length = 0;
                    const firebaseYears = trainingYearsSnap.val();
                    if (Array.isArray(firebaseYears)) {
                        trainingYears.push(...firebaseYears);
                    } else {
                        const yearsArray = Object.values(firebaseYears);
                        trainingYears.push(...yearsArray);
                    }
                    trainingYears.sort(); // Sort years
                    console.log('Loaded training years from Firebase:', trainingYears.length, 'years');
                }
                
                if (activitySnap.val()) {
                    activityLog.length = 0;
                    const firebaseActivity = activitySnap.val();
                    if (Array.isArray(firebaseActivity)) {
                        activityLog.push(...firebaseActivity);
                    } else {
                        const activityArray = Object.values(firebaseActivity);
                        activityLog.push(...activityArray);
                    }
                    console.log('Loaded activity log from Firebase:', activityLog.length, 'entries');
                }
                
                if (confirmSnap.val()) {
                    // ‡∏•‡πâ‡∏≤‡∏á confirmationStatus ‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏≠‡∏≤‡πÉ‡∏´‡∏°‡πà
                    Object.keys(confirmationStatus).forEach(key => delete confirmationStatus[key]);
                    Object.assign(confirmationStatus, confirmSnap.val());
                    console.log('Loaded confirmation status from Firebase');
                }
                
                if (nameHistorySnap.val()) {
                    // ‡∏•‡πâ‡∏≤‡∏á nameHistory ‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏≠‡∏≤‡πÉ‡∏´‡∏°‡πà
                    Object.keys(nameHistory).forEach(key => delete nameHistory[key]);
                    Object.assign(nameHistory, nameHistorySnap.val());
                    console.log('Loaded name history from Firebase:', Object.keys(nameHistory).length, 'officers');
                }
                
                console.log('All data loaded from Firebase successfully');
                console.log('Final data counts:', {
                    users: users.length,
                    organizations: organizations.length,
                    officers: officers.length,
                    positions: positions.length,
                    trainingData: Object.keys(trainingData).length,
                    activityLog: activityLog.length,
                    confirmationStatus: Object.keys(confirmationStatus).length,
                    nameHistory: Object.keys(nameHistory).length
                });
                
                // Populate dropdowns after data is loaded
                populateOrganizationDropdowns();
                
            } catch (error) {
                console.error('Error loading data from Firebase:', error);
                throw error;
            }
        }
        
        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
        async function refreshAllData() {
            console.log('Refreshing all UI data...');
            try {
                // ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä dropdown ‡∏ï‡πà‡∏≤‡∏á‡πÜ
                populateOrganizationDropdowns();
                
                // ‡∏à‡∏∞‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏Å tab ‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á
                console.log('Data refresh completed');
            } catch (error) {
                console.error('Error refreshing data:', error);
            }
        }
        
        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏™‡πà‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô‡πÉ‡∏ô dropdown ‡∏ï‡πà‡∏≤‡∏á‡πÜ (‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°‡∏•‡∏≥‡∏î‡∏±‡∏ö‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô)
        function populateOrganizationDropdowns() {
            // ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÅ‡∏•‡∏∞‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ó‡∏µ‡πà‡πÅ‡∏™‡∏î‡∏á‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô
            const sortedOrganizations = [...organizations].filter(org => org && org.id && org.name);
            
            const selectors = [
                '#officerOrgFilter',
                '#regOrgId',
                '#officerOrgId',
                '#trainingOrgFilter',
                '#newOrgId',
                '#editOrgId',
                '#orgFilter',
                '#addUserOrgId',
                '#editMemberOrgId'
            ];
            
            selectors.forEach(selector => {
                const element = document.querySelector(selector);
                if (element) {
                    // ‡πÄ‡∏Å‡πá‡∏ö option ‡πÅ‡∏£‡∏Å‡πÑ‡∏ß‡πâ
                    const firstOption = element.querySelector('option:first-child');
                    element.innerHTML = '';
                    if (firstOption) {
                        element.appendChild(firstOption.cloneNode(true));
                    }
                    
                    // ‡πÄ‡∏û‡∏¥‡πà‡∏° option ‡πÉ‡∏´‡∏°‡πà‡∏ï‡∏≤‡∏°‡∏•‡∏≥‡∏î‡∏±‡∏ö‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                    sortedOrganizations.forEach(org => {
                        const option = document.createElement('option');
                        option.value = org.id;
                        option.textContent = org.name;
                        element.appendChild(option);
                    });
                }
            });
        }
        
        async function saveToFirebase(path, data) {
            try {
                console.log(`Attempting to save to Firebase path: ${path}`, data);
                await window.firebaseSet(window.firebaseRef(window.firebaseDatabase, path), data);
                console.log(`Data saved to Firebase successfully: ${path}`);
                return true;
            } catch (error) {
                console.error(`Error saving to Firebase (${path}):`, error);
                console.error('Error details:', error.message);
                throw error;
            }
        }

        // Helper functions
        function showError(message) {
            document.getElementById('loginError').textContent = message;
            document.getElementById('loginError').classList.remove('hidden');
        }
        
        function clearError() {
            document.getElementById('loginError').classList.add('hidden');
        }
        
        function resetButton(button, originalText) {
            button.textContent = originalText;
            button.disabled = false;
        }

        // Toggle between login and register forms
        document.getElementById('toggleToRegister').addEventListener('click', function() {
            clearError();
            document.getElementById('loginForm').classList.add('hidden');
            document.getElementById('registerForm').classList.remove('hidden');
            document.getElementById('toggleToRegister').classList.add('hidden');
            document.getElementById('toggleToLogin').classList.remove('hidden');
            document.getElementById('loginError').classList.add('hidden');
        });
        
        document.getElementById('toggleToLogin').addEventListener('click', function() {
            document.getElementById('registerForm').classList.add('hidden');
            document.getElementById('loginForm').classList.remove('hidden');
            document.getElementById('toggleToLogin').classList.add('hidden');
            document.getElementById('toggleToRegister').classList.remove('hidden');
            clearError();
        });

        // Register functionality
        document.getElementById('registerForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // Show loading state
            const registerBtn = document.getElementById('registerBtn');
            const originalText = registerBtn.textContent;
            registerBtn.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô...';
            registerBtn.disabled = true;
            
            const username = document.getElementById('regUsername').value.trim();
            const password = document.getElementById('regPassword').value;
            const confirmPassword = document.getElementById('regConfirmPassword').value;
            const fullName = document.getElementById('regFullName').value.trim();
            const role = document.getElementById('regRole').value;
            const orgId = document.getElementById('regOrgId').value.trim().toUpperCase();
            
            // Clear previous errors
            document.getElementById('loginError').classList.add('hidden');
            
            // Enhanced Validation
            if (!username || !password || !fullName || !role || !orgId) {
                showError('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô');
                resetButton(registerBtn, originalText);
                return;
            }
            
            if (username.length < 3) {
                showError('‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 3 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£');
                resetButton(registerBtn, originalText);
                return;
            }
            
            if (password !== confirmPassword) {
                showError('‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô');
                resetButton(registerBtn, originalText);
                return;
            }
            
            if (password.length < 6) {
                showError('‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 6 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£');
                resetButton(registerBtn, originalText);
                return;
            }
            
            try {
                // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏à‡∏≤‡∏Å Firebase
                await loadDataFromFirebase();
                
                // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ username ‡∏ã‡πâ‡∏≥‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
                const existingUser = users.find(u => u.username === username);
                if (existingUser) {
                    document.getElementById('loginError').textContent = '‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏Ñ‡∏ô‡πÉ‡∏ä‡πâ‡πÅ‡∏•‡πâ‡∏ß';
                    document.getElementById('loginError').classList.remove('hidden');
                    return;
                }
                
                // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÉ‡∏´‡∏°‡πà
                const newUser = {
                    username: username,
                    password: password,
                    name: fullName,
                    role: role,
                    orgId: orgId,
                    createdAt: new Date().toISOString()
                };
                
                // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏ô local array
                users.push(newUser);
                
                // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á Firebase ‡πÇ‡∏î‡∏¢‡πÉ‡∏ä‡πâ push() ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á unique key
                const userRef = window.firebasePush(window.firebaseRef(window.firebaseDatabase, 'users'));
                await window.firebaseSet(userRef, newUser);
                
                console.log('User registered and saved to Firebase:', newUser);
                
                // ‡∏™‡∏£‡πâ‡∏≤‡∏á confirmation status ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà
                if (role === 'officer' && !confirmationStatus[orgId]) {
                    confirmationStatus[orgId] = { teamConfirmed: false, orgConfirmed: false };
                    await saveToFirebase('confirmationStatus', confirmationStatus);
                }
                
                await logActivity('‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô', `‡∏°‡∏µ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÉ‡∏´‡∏°‡πà‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô: ${fullName} (${username})`);
                
                alert('‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏î‡πâ‡πÅ‡∏•‡πâ‡∏ß');
                
                // ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤ login
                document.getElementById('registerForm').classList.add('hidden');
                document.getElementById('loginForm').classList.remove('hidden');
                document.getElementById('toggleToLogin').classList.add('hidden');
                document.getElementById('toggleToRegister').classList.remove('hidden');
                
                // ‡∏•‡πâ‡∏≤‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°
                document.getElementById('registerForm').reset();
                
            } catch (error) {
                console.error('Registration error:', error);
                if (error.message && error.message.includes('permission')) {
                    showError('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Firebase');
                } else {
                    showError('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô');
                }
            } finally {
                resetButton(registerBtn, originalText);
            }
        });

        // Helper functions
        function showError(message) {
            document.getElementById('loginError').textContent = message;
            document.getElementById('loginError').classList.remove('hidden');
        }
        
        function clearError() {
            document.getElementById('loginError').classList.add('hidden');
        }
        
        function resetButton(button, originalText) {
            button.textContent = originalText;
            button.disabled = false;
        }

        // Login functionality
        document.getElementById('loginForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // Show loading state
            const loginBtn = document.getElementById('loginBtn');
            const originalText = loginBtn.textContent;
            loginBtn.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö...';
            loginBtn.disabled = true;
            
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value;
            
            // Clear previous errors
            document.getElementById('loginError').classList.add('hidden');
            
            try {
                // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏à‡∏≤‡∏Å Firebase
                console.log('Loading data from Firebase...');
                await loadDataFromFirebase();
                console.log('Data loaded. Current data:', {
                    users: users.length,
                    organizations: organizations.length,
                    officers: officers.length
                });
                
                const user = users.find(u => u.username === username && u.password === password);
                
                if (user) {
                    currentUser = user;
                    userRole = user.role;
                    console.log('üöÄ Login successful, initializing application...');
                    
                    document.getElementById('loginPage').classList.add('hidden');
                    document.getElementById('mainApp').classList.remove('hidden');
                    document.getElementById('currentUser').textContent = user.name;
                    setupNavigation();
                    
                    console.log('üì• Loading all data from Firebase...');
                    // ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Å‡πà‡∏≠‡∏ô‡πÅ‡∏™‡∏î‡∏á
                    await refreshAllData();
                    
                    console.log('üè† Showing default tab with auto-loaded data...');
                    showDefaultTab();
                    
                    // ‡πÄ‡∏£‡∏¥‡πà‡∏° auto-refresh ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• real-time
                    console.log('‚è∞ Starting auto-refresh...');
                    startAutoRefresh();
                    
                    await logActivity('‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö', '‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
                    console.log('‚úÖ Application initialization completed');
                    
                    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏Å‡∏≤‡∏£‡∏¢‡πâ‡∏≤‡∏¢‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£
                    setTimeout(() => checkPendingTransferNotifications(), 1000);
                } else {
                    showError('‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
                }
            } catch (error) {
                console.error('Login error:', error);
                showError('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö');
            } finally {
                resetButton(loginBtn, originalText);
            }
        });

        // Logout functionality
        document.getElementById('logoutBtn').addEventListener('click', function() {
            // ‡∏´‡∏¢‡∏∏‡∏î auto-refresh ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö
            stopAutoRefresh();
            
            logActivity('‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö', '‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö');
            currentUser = null;
            userRole = null;
            document.getElementById('mainApp').classList.add('hidden');
            document.getElementById('loginPage').classList.remove('hidden');
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
            document.getElementById('loginError').classList.add('hidden');
        });

        // Setup navigation based on user role
        function setupNavigation() {
            const navTabs = document.getElementById('navTabs');
            navTabs.innerHTML = '';
            
            if (userRole === 'officer') {
                navTabs.innerHTML = `
                    <button id="officerDashboardTab" onclick="showTab('officerDashboard')" class="nav-tab px-4 py-2 text-white hover:bg-medium-green rounded">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Ñ‡∏£‡∏∑‡∏≠‡∏Ç‡πà‡∏≤‡∏¢‡∏ó‡∏µ‡∏° SRRT</button>
                    <button onclick="showTab('teamManagement')" class="nav-tab px-4 py-2 text-white hover:bg-medium-green rounded">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡∏°</button>
                `;
            } else if (userRole === 'admin') {
                navTabs.innerHTML = `
                    <button id="summaryReportTab" onclick="showTab('summaryReport')" class="nav-tab px-4 py-2 text-white hover:bg-medium-green rounded">‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
                    <button onclick="showTab('allOfficersDB')" class="nav-tab px-4 py-2 text-white hover:bg-medium-green rounded">‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà</button>
                    <button onclick="showTab('trainingDB')" class="nav-tab px-4 py-2 text-white hover:bg-medium-green rounded">‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏≠‡∏ö‡∏£‡∏°</button>
                    <button onclick="showTab('organizationsDB')" class="nav-tab px-4 py-2 text-white hover:bg-medium-green rounded">‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô</button>
                    <button onclick="showTab('positionsDB')" class="nav-tab px-4 py-2 text-white hover:bg-medium-green rounded">‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</button>
                    <button onclick="showTab('userAccounts')" class="nav-tab px-4 py-2 text-white hover:bg-medium-green rounded">‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</button>
                    <button onclick="showTab('activityLog')" class="nav-tab px-4 py-2 text-white hover:bg-medium-green rounded">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
                `;
            }
        }

        // Show tab functionality
        function showTab(tabId) {
            console.log('üîÑ Switching to tab:', tabId);
            
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.add('hidden');
            });
            
            // Remove active class from all nav tabs
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('bg-medium-green');
            });
            
            // Show selected tab
            const targetTab = document.getElementById(tabId);
            if (targetTab) {
                targetTab.classList.remove('hidden');
                console.log('‚úÖ Tab shown successfully:', tabId);
                
                // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô
                loadTabData(tabId);
            } else {
                console.error('‚ùå Tab not found:', tabId);
                return;
            }
            
            // Highlight the corresponding navigation button
            const navButtons = document.querySelectorAll('.nav-tab');
            navButtons.forEach(button => {
                const buttonText = button.textContent.trim();
                let shouldHighlight = false;
                
                switch(tabId) {
                    case 'summaryReport':
                        shouldHighlight = buttonText.includes('‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•');
                        break;
                    case 'officerDashboard':
                        shouldHighlight = buttonText.includes('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Ñ‡∏£‡∏∑‡∏≠‡∏Ç‡πà‡∏≤‡∏¢‡∏ó‡∏µ‡∏°');
                        break;
                    case 'teamManagement':
                        shouldHighlight = buttonText.includes('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡∏°');
                        break;
                    case 'allOfficersDB':
                        shouldHighlight = buttonText.includes('‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà');
                        break;
                    case 'organizationsDB':
                        shouldHighlight = buttonText.includes('‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô');
                        break;
                    case 'positionsDB':
                        shouldHighlight = buttonText.includes('‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á');
                        break;
                    case 'userAccounts':
                        shouldHighlight = buttonText.includes('‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô');
                        break;
                    case 'activityLog':
                        shouldHighlight = buttonText.includes('‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£');
                        break;
                    case 'trainingDB':
                        shouldHighlight = buttonText.includes('‡∏Å‡∏≤‡∏£‡∏≠‡∏ö‡∏£‡∏°');
                        break;
                }
                
                if (shouldHighlight) {
                    button.classList.add('bg-medium-green');
                    console.log('üü¢ Highlighted navigation button:', buttonText);
                }
            });
            
            console.log('üè† Tab switching completed for:', tabId);
        }

        // Show default tab based on user role
        function showDefaultTab() {
            console.log('üè† Showing default tab for role:', userRole);
            
            if (userRole === 'officer') {
                console.log('üë• Loading officer dashboard with data...');
                showTab('officerDashboard');
                // ‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° tab ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Ñ‡∏£‡∏∑‡∏≠‡∏Ç‡πà‡∏≤‡∏¢‡∏ó‡∏µ‡∏°‡πÉ‡∏´‡πâ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
                setTimeout(() => {
                    console.log('ÔøΩ Auto-clicking officer dashboard tab...');
                    const officerTabButton = document.getElementById('officerDashboardTab');
                    if (officerTabButton) {
                        console.log('‚úÖ Found officer tab button, clicking it programmatically...');
                        officerTabButton.click();
                        console.log('üéâ Officer dashboard tab clicked successfully!');
                    } else {
                        console.error('‚ùå Officer tab button not found, loading data directly...');
                        loadOfficerDashboardData();
                    }
                }, 1000);
                
            } else if (userRole === 'admin') {
                console.log('üëë Loading admin summary with data...');
                console.log('üìä Switching to summaryReport tab...');
                showTab('summaryReport');
                
                // ‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° tab ‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
                setTimeout(() => {
                    console.log('ÔøΩ Auto-clicking summary report tab...');
                    const summaryTabButton = document.querySelector('button[onclick="showTab(\'summaryReport\')"]');
                    if (summaryTabButton) {
                        console.log('‚úÖ Found summary tab button, clicking...');
                        summaryTabButton.click();
                    } else {
                        console.error('‚ùå Summary tab button not found');
                        // Fallback: ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á
                        loadSummaryReportDataWithRetry();
                    }
                }, 800);
            }
        }

        // Load data for specific tabs
        function loadTabData(tabId) {
            console.log('üì• Loading data for tab:', tabId);
            
            // ‡πÄ‡∏û‡∏¥‡πà‡∏° delay ‡πÄ‡∏•‡πá‡∏Å‡πÜ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ DOM ‡∏û‡∏£‡πâ‡∏≠‡∏°
            setTimeout(() => {
                switch(tabId) {
                    case 'summaryReport':
                        console.log('üìä Loading summary report with retry...');
                        loadSummaryReportDataWithRetry();
                        break;
                    case 'officerDashboard':
                        console.log('üìÑ Loading officer dashboard...');
                        loadOfficerDashboardData();
                        break;
                    case 'teamManagement':
                        console.log('üë• Loading team management...');
                        loadTeamData();
                        break;
                    case 'allOfficersDB':
                        console.log('üìã Loading all officers database...');
                        loadAllOfficersData();
                        break;
                    case 'trainingDB':
                        console.log('üéì Loading training database...');
                        loadTrainingData();
                        break;
                    case 'organizationsDB':
                        console.log('üè¢ Loading organizations database...');
                        loadOrganizationsData();
                        break;
                    case 'positionsDB':
                        console.log('üè∑Ô∏è Loading positions database...');
                        loadPositionsData();
                        break;
                    case 'userAccounts':
                        console.log('üë§ Loading user accounts...');
                        loadUserAccountsData();
                        break;
                    case 'activityLog':
                        console.log('üìú Loading activity log...');
                        loadActivityLogData();
                        break;
                    default:
                        console.log('‚ö†Ô∏è Unknown tab:', tabId);
                }
            }, 100);
        }

        // Load summary report data with retry
        function loadSummaryReportDataWithRetry(retryCount = 0) {
            console.log('üîÑ Attempting to load summary report data (attempt:', retryCount + 1, ')');
            
            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ element ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÅ‡∏•‡πâ‡∏ß‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á
            const totalTeamsElement = document.getElementById('totalTeams');
            const totalOfficersElement = document.getElementById('totalOfficers');
            const tbody = document.getElementById('orgSummaryTableBody');
            
            if (!totalTeamsElement || !totalOfficersElement || !tbody) {
                if (retryCount < 5) {
                    console.log('‚ö†Ô∏è Elements not ready, retrying in 200ms...');
                    setTimeout(() => {
                        loadSummaryReportDataWithRetry(retryCount + 1);
                    }, 200);
                    return;
                } else {
                    console.error('‚ùå Failed to load summary elements after 5 attempts');
                    return;
                }
            }
            
            console.log('‚úÖ Elements found, loading data...');
            loadSummaryReportData();
        }
        
        // Load summary report data
        function loadSummaryReportData() {
            console.log('üìä Loading summary report data automatically...');
            console.log('üìã Organizations count:', organizations.length);
            console.log('üë• Officers count:', officers.length);
            
            // ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 1: ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏ó‡∏µ‡∏° SRRT ‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£
            const totalTeams = organizations.length;
            const totalOfficers = officers.length;
            
            console.log('üî¢ Setting totalTeams to:', totalTeams);
            console.log('üî¢ Setting totalOfficers to:', totalOfficers);
            
            const totalTeamsElement = document.getElementById('totalTeams');
            const totalOfficersElement = document.getElementById('totalOfficers');
            
            if (totalTeamsElement) {
                totalTeamsElement.textContent = totalTeams;
                console.log('‚úÖ totalTeams updated successfully');
            } else {
                console.error('‚ùå totalTeams element not found');
            }
            
            if (totalOfficersElement) {
                totalOfficersElement.textContent = totalOfficers;
                console.log('‚úÖ totalOfficers updated successfully');
            } else {
                console.error('‚ùå totalOfficers element not found');
            }
            
            // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏£‡∏∏‡∏õ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á
            updatePositionSummary();
            
            // ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 2: ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô
            const tbody = document.getElementById('orgSummaryTableBody');
            if (!tbody) {
                console.error('orgSummaryTableBody element not found');
                return;
            }
            
            console.log('Populating summary table with', organizations.length, 'organizations');
            
            if (organizations.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="px-4 py-8 text-center text-gray-500">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô</td></tr>';
                return;
            }
            
            tbody.innerHTML = organizations.map(org => {
                const orgOfficers = officers.filter(officer => officer.orgId === org.id);
                const totalMembers = orgOfficers.length;
                
                // ‡∏ô‡∏±‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡∏ú‡πà‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏ö‡∏£‡∏° (‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏≠‡∏ö‡∏£‡∏°‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£‡πÉ‡∏ô‡∏õ‡∏µ‡πÉ‡∏î‡∏õ‡∏µ‡∏´‡∏ô‡∏∂‡πà‡∏á)
                let trainedMembers = 0;
                orgOfficers.forEach(officer => {
                    const training = trainingData[officer.id];
                    if (training) {
                        const hasTraining = Object.values(training).some(courses => courses && courses.length > 0);
                        if (hasTraining) {
                            trainedMembers++;
                        }
                    }
                });
                
                const trainingPercentage = totalMembers > 0 ? Math.round((trainedMembers / totalMembers) * 100) : 0;
                
                return `
                    <tr class="border-b hover:bg-gray-50">
                        <td class="px-4 py-2">${org.name}</td>
                        <td class="px-4 py-2 text-center">${totalMembers}</td>
                        <td class="px-4 py-2 text-center">${trainedMembers}</td>
                        <td class="px-4 py-2 text-center">
                            <div class="flex items-center justify-center">
                                <div class="w-16 bg-gray-200 rounded-full h-2 mr-2">
                                    <div class="bg-green-500 h-2 rounded-full" style="width: ${trainingPercentage}%"></div>
                                </div>
                                <span class="text-sm font-medium">${trainingPercentage}%</span>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }
        
        // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏£‡∏∏‡∏õ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÉ‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏ó‡∏µ‡∏° SRRT
        function updatePositionSummary() {
            console.log('üìä Updating position summary...');
            
            const container = document.getElementById('positionSummaryCards');
            if (!container) {
                console.error('‚ùå Position summary container not found');
                return;
            }
            
            // ‡∏ô‡∏±‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á
            const positionCounts = {};
            const totalOfficers = officers.length;
            
            officers.forEach(officer => {
                if (officer.position_id) {
                    if (!positionCounts[officer.position_id]) {
                        positionCounts[officer.position_id] = 0;
                    }
                    positionCounts[officer.position_id]++;
                }
            });
            
            console.log('Position counts:', positionCounts);
            
            if (Object.keys(positionCounts).length === 0) {
                container.innerHTML = '<div class="col-span-full text-center text-gray-500">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</div>';
                return;
            }
            
            // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á
            const cards = Object.entries(positionCounts)
                .sort(([,a], [,b]) => b - a) // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏ô ‡∏°‡∏≤‡∏Å‡πÑ‡∏õ‡∏ô‡πâ‡∏≠‡∏¢
                .map(([positionId, count]) => {
                    const position = positions.find(p => p.id === positionId);
                    const positionName = position ? position.name : `‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á ${positionId}`;
                    const percentage = totalOfficers > 0 ? Math.round((count / totalOfficers) * 100) : 0;
                    
                    // ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏µ‡∏ï‡∏≤‡∏°‡∏•‡∏≥‡∏î‡∏±‡∏ö
                    const colors = [
                        'bg-gradient-to-r from-blue-500 to-blue-600',
                        'bg-gradient-to-r from-green-500 to-green-600', 
                        'bg-gradient-to-r from-purple-500 to-purple-600',
                        'bg-gradient-to-r from-orange-500 to-orange-600',
                        'bg-gradient-to-r from-teal-500 to-teal-600',
                        'bg-gradient-to-r from-pink-500 to-pink-600',
                        'bg-gradient-to-r from-indigo-500 to-indigo-600',
                        'bg-gradient-to-r from-red-500 to-red-600'
                    ];
                    
                    const colorIndex = Object.keys(positionCounts).indexOf(positionId) % colors.length;
                    const bgColor = colors[colorIndex];
                    
                    return `
                        <div class="${bgColor} text-white p-4 rounded-lg">
                            <div class="flex items-center justify-between">
                                <div class="flex-1">
                                    <p class="text-white/80 text-sm font-medium">${positionName}</p>
                                    <div class="flex items-baseline gap-2 mt-1">
                                        <p class="text-2xl font-bold">${count}</p>
                                        <p class="text-white/80 text-sm">‡∏Ñ‡∏ô</p>
                                    </div>
                                    <p class="text-white/70 text-xs mt-1">${percentage}% ‡∏Ç‡∏≠‡∏á‡∏ó‡∏µ‡∏°</p>
                                </div>
                                <div class="text-2xl opacity-80">üë®‚Äçüíº</div>
                            </div>
                        </div>
                    `;
                }).join('');
            
            container.innerHTML = cards;
            console.log('‚úÖ Position summary updated successfully');
        }

        // Load officer dashboard data
        function loadOfficerDashboardData() {
            console.log('üîÑ Loading officer dashboard data automatically...');
            const container = document.querySelector('#officerDashboard .bg-white');
            
            if (!container) {
                console.error('‚ùå Officer dashboard container not found');
                return;
            }
            
            console.log('‚úÖ Officer dashboard container found, loading data...');
            
            // Clear existing content except the header and search section
            const header = container.querySelector('h2');
            const searchSection = container.querySelector('.mb-6.bg-gray-50');
            container.innerHTML = '';
            if (header) container.appendChild(header);
            
            // Re-add search section if it exists
            if (searchSection) {
                container.appendChild(searchSection);
            } else {
                // Create search section if it doesn't exist
                const searchDiv = document.createElement('div');
                searchDiv.className = 'mb-6 bg-gray-50 p-4 rounded-lg';
                searchDiv.innerHTML = `
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</label>
                            <input type="text" id="officerSearch" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏à‡∏≤‡∏Å‡∏ä‡∏∑‡πà‡∏≠ ‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà ‡∏´‡∏£‡∏∑‡∏≠‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô..." class="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-medium-green" onkeyup="searchOfficers()">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô</label>
                            <select id="orgFilter" class="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-medium-green" onchange="filterOfficers()">
                                <option value="">‡∏ó‡∏∏‡∏Å‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏≠‡∏ö‡∏£‡∏°</label>
                            <select id="trainingFilter" class="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-medium-green" onchange="filterOfficers()">
                                <option value="">‡∏ó‡∏∏‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</option>
                                <option value="trained">‡∏ú‡πà‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏ö‡∏£‡∏°‡πÅ‡∏•‡πâ‡∏ß</option>
                                <option value="not-trained">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏ö‡∏£‡∏°</option>
                            </select>
                        </div>
                    </div>
                `;
                container.appendChild(searchDiv);
            }
            
            // Populate organization filter dropdown using centralized function
            // (This will be handled by populateOrganizationDropdowns())
            
            // Group SRRT team members by organization
            const officersByOrg = {};
            officers.forEach(officer => {
                // Only include SRRT team members
                if (officer.isSRRT) {
                    if (!officersByOrg[officer.orgId]) {
                        officersByOrg[officer.orgId] = [];
                    }
                    officersByOrg[officer.orgId].push(officer);
                }
            });
            
            // Create blocks for each organization (show all organizations)
            organizations.forEach(org => {
                const srrtMembers = officersByOrg[org.id] || [];
                const hasSRRTMembers = srrtMembers.length > 0;
                
                const orgBlock = document.createElement('div');
                orgBlock.className = 'mb-8';
                
                if (hasSRRTMembers) {
                    // Organization has SRRT members - show them
                    orgBlock.innerHTML = `
                        <div class="bg-medium-green text-white p-4 rounded-t-lg">
                            <h3 class="text-lg font-bold">${org.name}</h3>
                            <p class="text-sm opacity-90 mt-1">‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏ó‡∏µ‡∏° SRRT: ${srrtMembers.length} ‡∏Ñ‡∏ô</p>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-2 text-sm">
                                <div>‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå: ${org.phone}</div>
                                <div>‡πÇ‡∏ó‡∏£‡∏™‡∏≤‡∏£: ${org.fax}</div>
                                <div>‡∏≠‡∏µ‡πÄ‡∏°‡∏•: ${org.email}</div>
                            </div>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="min-w-full bg-white border border-gray-200">
                                <thead class="bg-gray-100">
                                    <tr>
                                        <th class="px-4 py-2 text-left">‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà</th>
                                        <th class="px-4 py-2 text-left">‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•</th>
                                        <th class="px-4 py-2 text-left">‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</th>
                                        <th class="px-4 py-2 text-left">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå</th>
                                        <th class="px-4 py-2 text-left">‡∏≠‡∏µ‡πÄ‡∏°‡∏•</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${srrtMembers.map(officer => {
                                        const position = positions.find(p => p.id === officer.position_id);
                                        const positionName = position ? position.name : '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
                                        return `
                                        <tr class="border-b hover:bg-gray-50">
                                            <td class="px-4 py-2">${officer.id}</td>
                                            <td class="px-4 py-2">${officer.name}</td>
                                            <td class="px-4 py-2">${positionName}</td>
                                            <td class="px-4 py-2">${officer.phone}</td>
                                            <td class="px-4 py-2">${officer.email}</td>
                                        </tr>
                                        `;
                                    }).join('')}
                                </tbody>
                            </table>
                        </div>
                    `;
                } else {
                    // Organization has no SRRT members - show empty message
                    orgBlock.innerHTML = `
                        <div class="bg-gray-400 text-white p-4 rounded-t-lg">
                            <h3 class="text-lg font-bold">${org.name}</h3>
                            <p class="text-sm opacity-90 mt-1">‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏ó‡∏µ‡∏° SRRT: 0 ‡∏Ñ‡∏ô</p>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-2 text-sm">
                                <div>‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå: ${org.phone}</div>
                                <div>‡πÇ‡∏ó‡∏£‡∏™‡∏≤‡∏£: ${org.fax}</div>
                                <div>‡∏≠‡∏µ‡πÄ‡∏°‡∏•: ${org.email}</div>
                            </div>
                        </div>
                        <div class="bg-white border border-gray-200 p-8 text-center text-gray-500 rounded-b-lg">
                            <div class="text-4xl mb-2">üë•</div>
                            <p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏ó‡∏µ‡∏° SRRT ‡πÉ‡∏ô‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ</p>
                        </div>
                    `;
                }
                
                container.appendChild(orgBlock);
            });
        }

        // Load team data
        function loadTeamData() {
            const tbody = document.getElementById('teamTableBody');
            const userOrg = currentUser.orgId;
            const teamMembers = officers.filter(officer => officer.orgId === userOrg);
            const org = organizations.find(o => o.id === userOrg);
            
            // Calculate team summary
            const totalMembers = teamMembers.length;
            let trainedMembers = 0;
            
            teamMembers.forEach(officer => {
                const training = trainingData[officer.id];
                if (training) {
                    const hasTraining = Object.values(training).some(courses => courses && courses.length > 0);
                    if (hasTraining) {
                        trainedMembers++;
                    }
                }
            });
            
            const trainingPercentage = totalMembers > 0 ? Math.round((trainedMembers / totalMembers) * 100) : 0;
            
            // Update summary display
            document.getElementById('teamTotalMembers').textContent = totalMembers;
            document.getElementById('teamTrainedMembers').textContent = trainedMembers;
            document.getElementById('teamTrainingPercentage').textContent = trainingPercentage;
            document.getElementById('teamProgressText').textContent = `${trainedMembers}/${totalMembers} ‡∏Ñ‡∏ô`;
            document.getElementById('teamProgressBar').style.width = `${trainingPercentage}%`;
            
            // Update confirmation status display
            updateConfirmationStatusDisplay();
            
            // Update confirmation status display
            updateConfirmationStatusDisplay();
            
            tbody.innerHTML = teamMembers.map(officer => {
                const position = positions.find(p => p.id === officer.position_id);
                const positionName = position ? position.name : '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
                
                return `
                <tr class="border-b hover:bg-gray-50">
                    <td class="px-4 py-2">${officer.id}</td>
                    <td class="px-4 py-2">${officer.name}</td>
                    <td class="px-4 py-2">${positionName}</td>
                    <td class="px-4 py-2">${officer.phone}</td>
                    <td class="px-4 py-2">${officer.email}</td>
                    <td class="px-4 py-2 text-center">
                        <button onclick="showOfficerTrainingHistory('${officer.id}')" class="bg-green-500 text-white px-2 py-1 rounded text-sm hover:bg-green-600">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏≠‡∏ö‡∏£‡∏°</button>
                    </td>
                    <td class="px-4 py-2 text-center">
                        <input type="checkbox" 
                               id="srrt_${officer.id}" 
                               ${officer.isSRRT ? 'checked' : ''} 
                               onchange="toggleSRRTMember('${officer.id}')"
                               class="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500">
                    </td>
                    <td class="px-4 py-2 text-center">
                        <button onclick="editMember('${officer.id}')" class="bg-blue-500 text-white px-2 py-1 rounded text-sm hover:bg-blue-600 mr-1">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                        <button onclick="deleteMember('${officer.id}')" class="bg-red-500 text-white px-2 py-1 rounded text-sm hover:bg-red-600" title="${userRole === 'admin' ? '‡∏•‡∏ö‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö' : '‡∏•‡∏ö‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô'}">‡∏•‡∏ö</button>
                    </td>
                </tr>
                `;
            }).join('');
            
            // Load SRRT team members table
            loadSRRTTeamTable();
            
            // Update all officers position summary
            updateAllOfficersPositionSummary(teamMembers);
            
            // Update SRRT team summary
            updateSRRTTeamSummary();
        }

        // Toggle SRRT member status
        async function toggleSRRTMember(officerId) {
            const officer = officers.find(o => o.id === officerId);
            if (officer) {
                officer.isSRRT = !officer.isSRRT;
                
                try {
                    await saveToFirebase('officers', officers);
                    await logActivity('‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç', `${officer.isSRRT ? '‡πÄ‡∏û‡∏¥‡πà‡∏°' : '‡∏•‡∏ö'} ${officer.name} ${officer.isSRRT ? '‡πÄ‡∏Ç‡πâ‡∏≤' : '‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å'}‡∏ó‡∏µ‡∏° SRRT`);
                    
                    // Refresh displays
                    loadSRRTTeamTable();
                    updateSRRTTeamSummary();
                    
                    // Update position summaries
                    const userOrg = currentUser.orgId;
                    const teamMembers = officers.filter(officer => officer.orgId === userOrg);
                    updateAllOfficersPositionSummary(teamMembers);
                    
                    // If current page is network view, refresh it too
                    if (document.getElementById('networkView') && !document.getElementById('networkView').classList.contains('hidden')) {
                        loadAllOfficersData();
                    }
                    
                } catch (error) {
                    console.error('Error updating SRRT status:', error);
                    alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ó‡∏µ‡∏° SRRT');
                    // Revert checkbox state
                    document.getElementById(`srrt_${officerId}`).checked = !officer.isSRRT;
                    officer.isSRRT = !officer.isSRRT;
                }
            }
        }

        // Load SRRT team members table
        function loadSRRTTeamTable() {
            const tbody = document.getElementById('srrtTeamTableBody');
            const emptyMessage = document.getElementById('srrtTeamEmpty');
            const userOrg = currentUser.orgId;
            const srrtMembers = officers.filter(officer => officer.orgId === userOrg && officer.isSRRT);
            const org = organizations.find(o => o.id === userOrg);
            
            if (srrtMembers.length === 0) {
                tbody.innerHTML = '';
                emptyMessage.classList.remove('hidden');
                updateSRRTPositionSummary([]);
                return;
            }
            
            emptyMessage.classList.add('hidden');
            tbody.innerHTML = srrtMembers.map(officer => {
                const position = positions.find(p => p.id === officer.position_id);
                const positionName = position ? position.name : '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
                
                return `
                <tr class="border-b hover:bg-gray-50">
                    <td class="px-4 py-2">${officer.id}</td>
                    <td class="px-4 py-2">${officer.name}</td>
                    <td class="px-4 py-2">${positionName}</td>
                    <td class="px-4 py-2">${officer.phone}</td>
                    <td class="px-4 py-2">${officer.email}</td>
                    <td class="px-4 py-2 text-center">
                        <button onclick="showOfficerTrainingHistory('${officer.id}')" class="bg-green-500 text-white px-2 py-1 rounded text-sm hover:bg-green-600">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏≠‡∏ö‡∏£‡∏°</button>
                    </td>
                </tr>
                `;
            }).join('');
            
            // Update SRRT position summary
            updateSRRTPositionSummary(srrtMembers);
        }
        
        // Update SRRT position summary
        function updateSRRTPositionSummary(srrtMembers) {
            const summaryContent = document.getElementById('srrtPositionSummaryContent');
            if (!summaryContent) return;
            
            if (srrtMembers.length === 0) {
                summaryContent.innerHTML = '<div class="col-span-full text-center text-gray-500">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡πÉ‡∏ô‡∏ó‡∏µ‡∏° SRRT</div>';
                return;
            }
            
            // Count officers by position
            const positionCounts = {};
            srrtMembers.forEach(officer => {
                const position = positions.find(p => p.id === officer.position_id);
                const positionName = position ? position.name : '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
                positionCounts[positionName] = (positionCounts[positionName] || 0) + 1;
            });
            
            // Create summary cards
            const summaryCards = Object.entries(positionCounts)
                .sort(([,a], [,b]) => b - a) // Sort by count descending
                .map(([positionName, count]) => `
                    <div class="bg-white border border-blue-200 rounded-lg p-3 text-center hover:shadow-md transition-shadow duration-200">
                        <div class="text-2xl font-bold text-blue-600 mb-1">${count}</div>
                        <div class="text-xs text-gray-600 leading-tight">${positionName}</div>
                        <div class="text-xs text-blue-500 mt-1">‡∏Ñ‡∏ô</div>
                    </div>
                `).join('');
            
            summaryContent.innerHTML = summaryCards;
        }
        
        // Update all officers position summary
        function updateAllOfficersPositionSummary(teamMembers) {
            const summaryContent = document.getElementById('allOfficersPositionSummaryContent');
            if (!summaryContent) return;
            
            if (teamMembers.length === 0) {
                summaryContent.innerHTML = '<div class="col-span-full text-center text-gray-500">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡πÉ‡∏ô‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô</div>';
                return;
            }
            
            // Count officers by position
            const positionCounts = {};
            teamMembers.forEach(officer => {
                const position = positions.find(p => p.id === officer.position_id);
                const positionName = position ? position.name : '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
                positionCounts[positionName] = (positionCounts[positionName] || 0) + 1;
            });
            
            // Create summary cards
            const summaryCards = Object.entries(positionCounts)
                .sort(([,a], [,b]) => b - a) // Sort by count descending
                .map(([positionName, count]) => `
                    <div class="bg-white border border-green-200 rounded-lg p-3 text-center hover:shadow-md transition-shadow duration-200">
                        <div class="text-2xl font-bold text-green-600 mb-1">${count}</div>
                        <div class="text-xs text-gray-600 leading-tight">${positionName}</div>
                        <div class="text-xs text-green-500 mt-1">‡∏Ñ‡∏ô</div>
                    </div>
                `).join('');
            
            summaryContent.innerHTML = summaryCards;
        }

        // Update SRRT team summary
        function updateSRRTTeamSummary() {
            const userOrg = currentUser.orgId;
            const srrtMembers = officers.filter(officer => officer.orgId === userOrg && officer.isSRRT);
            
            const totalSRRTMembers = srrtMembers.length;
            let trainedSRRTMembers = 0;
            
            srrtMembers.forEach(officer => {
                const training = trainingData[officer.id];
                if (training) {
                    const hasTraining = Object.values(training).some(courses => courses && courses.length > 0);
                    if (hasTraining) {
                        trainedSRRTMembers++;
                    }
                }
            });
            
            const srrtTrainingPercentage = totalSRRTMembers > 0 ? Math.round((trainedSRRTMembers / totalSRRTMembers) * 100) : 0;
            
            // Update SRRT summary display
            document.getElementById('srrtTotalMembers').textContent = totalSRRTMembers;
            document.getElementById('srrtTrainedMembers').textContent = trainedSRRTMembers;
            document.getElementById('srrtTrainingPercentage').textContent = srrtTrainingPercentage;
            document.getElementById('srrtProgressText').textContent = `${trainedSRRTMembers}/${totalSRRTMembers} ‡∏Ñ‡∏ô`;
            document.getElementById('srrtProgressBar').style.width = `${srrtTrainingPercentage}%`;
        }

        // Apply officer filters
        function applyOfficerFilters() {
            const searchTerm = document.getElementById('officerSearchInput').value.toLowerCase();
            const orgFilter = document.getElementById('officerOrgFilter').value;
            const trainingFilter = document.getElementById('officerTrainingFilter').value;
            
            console.log('üîç Applying officer filters:', { searchTerm, orgFilter, trainingFilter });
            
            const filteredOfficers = officers.filter(officer => {
                // ‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ï‡∏≤‡∏°‡∏Ñ‡∏≥‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
                const org = organizations.find(o => o.id === officer.orgId);
                const orgName = org ? org.name : officer.organization;
                
                const searchMatch = !searchTerm || 
                    officer.name.toLowerCase().includes(searchTerm) ||
                    officer.id.toLowerCase().includes(searchTerm) ||
                    orgName.toLowerCase().includes(searchTerm);
                
                // ‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô - ‡πÉ‡∏ä‡πâ‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô‡∏à‡∏≤‡∏Å organizations array
                const orgMatch = !orgFilter || orgName === orgFilter;
                
                // ‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏≠‡∏ö‡∏£‡∏° (‡πÉ‡∏ä‡πâ‡∏õ‡∏µ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
                let trainingMatch = true;
                if (trainingYears.length > 0 && (trainingFilter === 'trained' || trainingFilter === 'not-trained')) {
                    const latestYear = trainingYears[trainingYears.length - 1];
                    if (trainingFilter === 'trained') {
                        trainingMatch = trainingData[officer.id] && trainingData[officer.id][latestYear] && trainingData[officer.id][latestYear].length > 0;
                    } else if (trainingFilter === 'not-trained') {
                        trainingMatch = !trainingData[officer.id] || !trainingData[officer.id][latestYear] || trainingData[officer.id][latestYear].length === 0;
                    }
                }
                
                console.log(`üîç Filtering officer ${officer.name}: search=${searchMatch}, org=${orgMatch} (${orgName} vs ${orgFilter}), training=${trainingMatch}`);
                
                return searchMatch && orgMatch && trainingMatch;
            });
            
            displayFilteredOfficers(filteredOfficers);
        }
        
        function clearOfficerFilters() {
            document.getElementById('officerSearchInput').value = '';
            document.getElementById('officerOrgFilter').value = '';
            document.getElementById('officerTrainingFilter').value = '';
            loadAllOfficersData();
        }
        
        function displayFilteredOfficers(filteredOfficers) {
            const tbody = document.getElementById('allOfficersTableBody');
            if (!tbody) {
                console.error('‚ùå All officers table body not found');
                return;
            }
            
            tbody.innerHTML = '';
            
            if (filteredOfficers.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="px-4 py-8 text-center text-gray-500">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç</td></tr>';
                return;
            }
            
            console.log('üë• Displaying filtered officers:', filteredOfficers.length);
            console.log('Current officers array:', officers.map(o => ({ id: o.id, name: o.name, orgId: o.orgId, organization: o.organization })));
            console.log('Current organizations array:', organizations.map(o => ({ id: o.id, name: o.name })));
            
            const rows = filteredOfficers.map(officer => {
                console.log('üìã Officer data:', officer);
                
                // ‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô
                const org = organizations.find(o => o.id === officer.orgId || o.name === officer.organization);
                const confirmStatus = confirmationStatus[officer.orgId || org?.id];
                
                // ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô
                let statusDisplay = '';
                if (confirmStatus && confirmStatus.teamConfirmed) {
                    statusDisplay = '<span class="bg-green-100 text-green-800 px-2 py-1 rounded text-xs">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏•‡πâ‡∏ß</span>';
                } else {
                    statusDisplay = '<span class="bg-gray-100 text-gray-600 px-2 py-1 rounded text-xs">‡∏£‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</span>';
                }
                
                // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏≤‡∏° header: ‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà, ‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•, ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á, ‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô, ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏∑‡πà‡∏ô ‡πÜ, ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ä‡∏∑‡πà‡∏≠, ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô, ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£
                const officerId = officer.id || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
                const officerName = officer.name || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
                
                // ‡∏´‡∏≤‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏à‡∏≤‡∏Å positions array
                const position = positions && positions.find ? positions.find(pos => pos && pos.id === officer.position_id) : null;
                const officerPosition = position ? position.name : '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
                
                const officerOrg = org ? org.name : (officer.organization || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏');
                
                // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏≤‡∏Å nameHistory global variable
                const hasNameHistory = nameHistory[officerId] && nameHistory[officerId].length > 0;
                const nameHistoryButton = hasNameHistory ? 
                    `<button onclick="showNameHistoryModal('${officerId}')" class="bg-indigo-500 text-white px-2 py-1 rounded text-xs hover:bg-indigo-600">‡∏î‡∏π‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</button>` :
                    '<span class="text-gray-400 text-xs">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</span>';
                
                return `
                    <tr class="hover:bg-gray-50">
                        <td class="px-4 py-2">${officerId}</td>
                        <td class="px-4 py-2">${officerName}</td>
                        <td class="px-4 py-2">${officerPosition}</td>
                        <td class="px-4 py-2">${officerOrg}</td>
                        <td class="px-4 py-2 text-center">
                            <button onclick="showOfficerDetailsModal('${officerId}')" class="bg-blue-500 text-white px-2 py-1 rounded text-xs hover:bg-blue-600">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°</button>
                        </td>
                        <td class="px-4 py-2 text-center">${nameHistoryButton}</td>
                        <td class="px-4 py-2 text-center">${statusDisplay}</td>
                        <td class="px-4 py-2">
                            <div class="flex gap-2">
                                <button onclick="editOfficer('${officerId}')" class="bg-blue-500 text-white px-2 py-1 rounded text-sm hover:bg-blue-600">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                                ${userRole === 'admin' ? `<button onclick="deleteOfficerPermanently('${officerId}')" class="bg-red-500 text-white px-2 py-1 rounded text-sm hover:bg-red-600">‡∏•‡∏ö‡∏ñ‡∏≤‡∏ß‡∏£</button>` : ''}
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
            
            tbody.innerHTML = rows;
            console.log(`‚úÖ Displayed ${filteredOfficers.length} filtered officers`);
        }
        
        // Apply organization filters
        function applyOrgFilters() {
            const searchTerm = document.getElementById('orgSearchInput').value.toLowerCase();
            const memberFilter = document.getElementById('orgMemberFilter').value;
            const confirmFilter = document.getElementById('orgConfirmFilter').value;
            
            console.log('üîç Applying organization filters:', { searchTerm, memberFilter, confirmFilter });
            
            const filteredOrgs = organizations.filter(org => {
                // ‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ï‡∏≤‡∏°‡∏Ñ‡∏≥‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
                const searchMatch = !searchTerm || 
                    org.name.toLowerCase().includes(searchTerm) ||
                    org.id.toLowerCase().includes(searchTerm);
                
                // ‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å
                let memberMatch = true;
                if (memberFilter) {
                    const memberCount = officers.filter(officer => officer.organization === org.name).length;
                    switch(memberFilter) {
                        case '1-5':
                            memberMatch = memberCount >= 1 && memberCount <= 5;
                            break;
                        case '6-10':
                            memberMatch = memberCount >= 6 && memberCount <= 10;
                            break;
                        case '11-20':
                            memberMatch = memberCount >= 11 && memberCount <= 20;
                            break;
                        case '21+':
                            memberMatch = memberCount >= 21;
                            break;
                    }
                }
                
                // ‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô
                let confirmMatch = true;
                if (confirmFilter) {
                    const confirmStatus = confirmationStatus[org.id];
                    const isConfirmed = confirmStatus?.orgConfirmed && confirmStatus?.teamConfirmed;
                    confirmMatch = (confirmFilter === 'confirmed' && isConfirmed) || (confirmFilter === 'pending' && !isConfirmed);
                }
                
                return searchMatch && memberMatch && confirmMatch;
            });
            
            displayFilteredOrganizations(filteredOrgs);
        }
        
        function clearOrgFilters() {
            document.getElementById('orgSearchInput').value = '';
            document.getElementById('orgMemberFilter').value = '';
            document.getElementById('orgConfirmFilter').value = '';
            loadOrganizationsData();
        }
        
        function displayFilteredOrganizations(filteredOrgs) {
            const tbody = document.getElementById('organizationsTableBody');
            if (!tbody) {
                console.error('‚ùå Organizations table body not found');
                return;
            }
            
            tbody.innerHTML = '';
            
            if (filteredOrgs.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="px-4 py-8 text-center text-gray-500">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç</td></tr>';
                return;
            }
            
            console.log('üè¢ Displaying organizations:', filteredOrgs.length);
            
            const rows = filteredOrgs.map(org => {
                console.log('üîç Organization data:', org);
                
                const confirmStatus = confirmationStatus[org.id];
                const isConfirmed = confirmStatus?.orgConfirmed && confirmStatus?.teamConfirmed;
                const confirmBadge = isConfirmed ? 
                    '<span class="bg-green-100 text-green-800 px-2 py-1 rounded text-xs">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏•‡πâ‡∏ß</span>' :
                    '<span class="bg-gray-100 text-gray-600 px-2 py-1 rounded text-xs">‡∏£‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</span>';
                
                // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
                const orgId = org.id || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
                const orgName = org.name || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
                const orgPhone = org.phone || org.contact || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
                const orgFax = org.fax || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
                const orgEmail = org.email || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
                
                return `
                    <tr class="hover:bg-gray-50">
                        <td class="px-4 py-2">${orgId}</td>
                        <td class="px-4 py-2">${orgName}</td>
                        <td class="px-4 py-2">${orgPhone}</td>
                        <td class="px-4 py-2">${orgFax}</td>
                        <td class="px-4 py-2">${orgEmail}</td>
                        <td class="px-4 py-2 text-center">${confirmBadge}</td>
                        <td class="px-4 py-2">
                            <div class="flex gap-2">
                                <button onclick="editOrganization('${orgId}')" class="bg-blue-500 text-white px-2 py-1 rounded text-sm hover:bg-blue-600">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                                ${userRole === 'admin' ? `
                                    <button onclick="resetConfirmationStatus('${orgId}')" class="bg-orange-500 text-white px-2 py-1 rounded text-sm hover:bg-orange-600" title="‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô">‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï</button>
                                    <button onclick="deleteOrganization('${orgId}')" class="bg-red-500 text-white px-2 py-1 rounded text-sm hover:bg-red-600">‡∏•‡∏ö</button>` : ''}
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
            
            tbody.innerHTML = rows;
            console.log(`‚úÖ Displayed ${filteredOrgs.length} filtered organizations`);
        }
        
        // Apply officer filters
        function applyOfficerFilters() {
            const searchTerm = document.getElementById('officerSearchInput').value.toLowerCase();
            const orgFilter = document.getElementById('officerOrgFilter').value;
            const trainingFilter = document.getElementById('officerTrainingFilter').value;
            
            console.log('üîç Applying officer filters:', { searchTerm, orgFilter, trainingFilter });
            
            const filteredOfficers = officers.filter(officer => {
                const org = organizations.find(o => o.id === officer.orgId);
                const orgName = org ? org.name : '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
                
                // ‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ï‡∏≤‡∏°‡∏Ñ‡∏≥‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
                const searchMatch = !searchTerm || 
                    officer.name.toLowerCase().includes(searchTerm) ||
                    officer.id.toLowerCase().includes(searchTerm) ||
                    orgName.toLowerCase().includes(searchTerm) ||
                    officer.phone.toLowerCase().includes(searchTerm);
                
                // ‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô
                const orgMatch = !orgFilter || orgName === orgFilter;
                
                // ‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏≠‡∏ö‡∏£‡∏° (‡πÉ‡∏ä‡πâ‡∏õ‡∏µ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
                let trainingMatch = true;
                if (trainingYears.length > 0 && (trainingFilter === 'trained' || trainingFilter === 'not-trained')) {
                    const latestYear = trainingYears[trainingYears.length - 1];
                    if (trainingFilter === 'trained') {
                        trainingMatch = trainingData[officer.id] && trainingData[officer.id][latestYear] && trainingData[officer.id][latestYear].length > 0;
                    } else if (trainingFilter === 'not-trained') {
                        trainingMatch = !trainingData[officer.id] || !trainingData[officer.id][latestYear] || trainingData[officer.id][latestYear].length === 0;
                    }
                }
                
                return searchMatch && orgMatch && trainingMatch;
            });
            
            displayFilteredOfficers(filteredOfficers);
        }
        
        function clearOfficerFilters() {
            document.getElementById('officerSearchInput').value = '';
            document.getElementById('officerOrgFilter').value = '';
            document.getElementById('officerTrainingFilter').value = '';
            loadAllOfficersData();
        }
        
        // Legacy function - removed duplicate
        
        function populateOfficerOrgFilter() {
            const orgFilter = document.getElementById('officerOrgFilter');
            if (!orgFilter) return;
            
            console.log('üè¢ Populating officer org filter...');
            console.log('Officers count:', officers.length);
            console.log('Organizations count:', organizations.length);
            
            // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏¢‡∏π‡πà‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
            const currentValue = orgFilter.value;
            
            // ‡πÄ‡∏Å‡πá‡∏ö‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏ã‡πâ‡∏≥
            const orgNames = [...new Set(officers.map(officer => {
                const org = organizations.find(o => o.id === officer.orgId);
                const orgName = org ? org.name : '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
                console.log(`Officer ${officer.name}: orgId=${officer.orgId}, orgName=${orgName}`);
                return orgName;
            }))].sort();
            
            console.log('Available org names:', orgNames);
            
            orgFilter.innerHTML = '<option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>';
            orgNames.forEach(orgName => {
                const selected = orgName === currentValue ? 'selected' : '';
                orgFilter.innerHTML += `<option value="${orgName}" ${selected}>${orgName}</option>`;
            });
        }
        
        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
        function refreshOfficerTableImmediate() {
            console.log('‚ö° IMMEDIATE table refresh started...');
            console.log('Current officers data:', officers.map(o => ({ 
                id: o.id, 
                name: o.name, 
                orgId: o.orgId, 
                organization: o.organization 
            })));
            
            // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï dropdown ‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
            populateOfficerOrgFilter();
            
            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö filter ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
            const currentSearch = document.getElementById('officerSearchInput')?.value || '';
            const currentOrgFilter = document.getElementById('officerOrgFilter')?.value || '';
            const currentTrainingFilter = document.getElementById('officerTrainingFilter')?.value || '';
            
            console.log('Current filters:', { currentSearch, currentOrgFilter, currentTrainingFilter });
            
            // ‡∏™‡∏£‡πâ‡∏≤‡∏á filtered officers ‡∏ï‡∏≤‡∏°‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
            let filteredOfficers = officers;
            
            if (currentSearch || currentOrgFilter || currentTrainingFilter) {
                filteredOfficers = officers.filter(officer => {
                    const org = organizations.find(o => o.id === officer.orgId);
                    const orgName = org ? org.name : officer.organization;
                    
                    const searchMatch = !currentSearch || 
                        officer.name.toLowerCase().includes(currentSearch.toLowerCase()) ||
                        officer.id.toLowerCase().includes(currentSearch.toLowerCase()) ||
                        orgName.toLowerCase().includes(currentSearch.toLowerCase());
                    
                    const orgMatch = !currentOrgFilter || orgName === currentOrgFilter;
                    
                    let trainingMatch = true;
                    if (trainingYears.length > 0 && (currentTrainingFilter === 'trained' || currentTrainingFilter === 'not-trained')) {
                        const latestYear = trainingYears[trainingYears.length - 1];
                        if (currentTrainingFilter === 'trained') {
                            trainingMatch = trainingData[officer.id] && trainingData[officer.id][latestYear] && trainingData[officer.id][latestYear].length > 0;
                        } else if (currentTrainingFilter === 'not-trained') {
                            trainingMatch = !trainingData[officer.id] || !trainingData[officer.id][latestYear] || trainingData[officer.id][latestYear].length === 0;
                        }
                    }
                    
                    return searchMatch && orgMatch && trainingMatch;
                });
            }
            
            console.log(`Filtered officers count: ${filteredOfficers.length} from total: ${officers.length}`);
            
            // ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
            displayFilteredOfficers(filteredOfficers);
            
            console.log('‚ö° IMMEDIATE table refresh completed!');
        }
        
        // Load all officers data (all officers)
        function loadAllOfficersData() {
            console.log('üìÑ Loading all officers data...');
            populateOfficerOrgFilter();
            // Show all officers
            displayFilteredOfficers(officers);
        }
        
        // Export officers database to Excel
        function exportOfficersToExcel() {
            console.log('üìä Starting officers export to Excel...');
            
            try {
                if (!officers || officers.length === 0) {
                    alert('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡πÉ‡∏´‡πâ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å');
                    return;
                }
                
                // Get current filters to export only filtered data
                const searchTerm = document.getElementById('officerSearchInput')?.value?.toLowerCase() || '';
                const orgFilter = document.getElementById('officerOrgFilter')?.value || '';
                const trainingFilter = document.getElementById('officerTrainingFilter')?.value || '';
                
                let dataToExport = officers;
                
                // Apply same filters as display if any filters are active
                if (searchTerm || orgFilter || trainingFilter) {
                    dataToExport = officers.filter(officer => {
                        const org = organizations.find(o => o.id === officer.orgId);
                        const orgName = org ? org.name : '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
                        
                        const searchMatch = !searchTerm || 
                            officer.name.toLowerCase().includes(searchTerm) ||
                            officer.id.toLowerCase().includes(searchTerm) ||
                            orgName.toLowerCase().includes(searchTerm);
                        
                        const orgMatch = !orgFilter || orgName === orgFilter;
                        
                        let trainingMatch = true;
                        if (trainingFilter) {
                            const hasTraining = trainingData[officer.id] && 
                                Object.values(trainingData[officer.id]).some(yearData => yearData.length > 0);
                            trainingMatch = (trainingFilter === 'trained' && hasTraining) || 
                                           (trainingFilter === 'not-trained' && !hasTraining);
                        }
                        
                        return searchMatch && orgMatch && trainingMatch;
                    });
                }
                
                // Create Excel headers
                const headers = [
                    '‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà',
                    '‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•', 
                    '‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á',
                    '‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô',
                    '‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå',
                    '‡∏≠‡∏µ‡πÄ‡∏°‡∏•',
                    '‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô',
                    '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏£‡πâ‡∏≤‡∏á',
                    '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î'
                ];
                
                // Create Excel data
                const excelData = dataToExport.map(officer => {
                    const org = organizations.find(o => o.id === officer.orgId);
                    const orgName = org ? org.name : '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
                    
                    const position = positions.find(p => p.id === officer.position_id);
                    const positionName = position ? position.name : '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
                    
                    const confirmStatus = confirmationStatus[officer.orgId];
                    const statusText = (confirmStatus && confirmStatus.teamConfirmed) ? '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏•‡πâ‡∏ß' : '‡∏£‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô';
                    
                    // Format dates
                    const createdDate = officer.createdAt ? new Date(officer.createdAt).toLocaleDateString('th-TH') : '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
                    const updatedDate = officer.updatedAt ? new Date(officer.updatedAt).toLocaleDateString('th-TH') : '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
                    
                    return [
                        officer.id || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏',
                        officer.name || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏',
                        positionName,
                        orgName,
                        officer.phone || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏',
                        officer.email || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏',
                        statusText,
                        createdDate,
                        updatedDate
                    ];
                });
                
                // Create workbook
                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.aoa_to_sheet([headers, ...excelData]);
                
                // Set column widths
                const colWidths = [
                    { wch: 15 }, // ‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà
                    { wch: 25 }, // ‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•
                    { wch: 20 }, // ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á
                    { wch: 30 }, // ‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô
                    { wch: 15 }, // ‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå
                    { wch: 25 }, // ‡∏≠‡∏µ‡πÄ‡∏°‡∏•
                    { wch: 15 }, // ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô
                    { wch: 15 }, // ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏£‡πâ‡∏≤‡∏á
                    { wch: 15 }  // ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
                ];
                ws['!cols'] = colWidths;
                
                XLSX.utils.book_append_sheet(wb, ws, '‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà');
                
                // Generate filename with current date
                const now = new Date();
                const dateStr = now.toLocaleDateString('th-TH').replace(/\//g, '-');
                const timeStr = now.toLocaleTimeString('th-TH', { hour12: false }).replace(/:/g, '-');
                const filename = `officers_database_${dateStr}_${timeStr}.xlsx`;
                
                XLSX.writeFile(wb, filename);
                
                console.log('Officers database exported:', filename);
                alert(`‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ ${dataToExport.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£\n‡πÑ‡∏ü‡∏•‡πå: ${filename}`);
                
            } catch (error) {
                console.error('Error exporting officers database:', error);
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: ' + error.message);
            }
        }
        
        // Legacy function kept for compatibility
        function loadAllOfficersDataOld() {
            const tbody = document.getElementById('allOfficersTableBody');
            if (!tbody) {
                console.error('allOfficersTableBody element not found');
                return;
            }
            
            console.log('Found', officers.length, 'officers to display');
            
            if (officers.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" class="px-4 py-8 text-center text-gray-500">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà</td></tr>';
                return;
            }
            
            tbody.innerHTML = officers.map(officer => {
                const org = organizations.find(o => o.id === officer.orgId);
                const confirmStatus = confirmationStatus[officer.orgId];
                let statusDisplay = '';
                let statusAction = '';
                
                if (confirmStatus && confirmStatus.teamConfirmed) {
                    statusDisplay = '<span class="bg-green-100 text-green-800 px-2 py-1 rounded text-xs">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏•‡πâ‡∏ß</span>';
                    statusAction = `<button onclick="resetTeamConfirmationEnhanced('${officer.orgId}')" class="bg-orange-500 text-white px-2 py-1 rounded text-xs hover:bg-orange-600 ml-1">‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï</button>`;
                } else {
                    statusDisplay = '<span class="bg-gray-100 text-gray-600 px-2 py-1 rounded text-xs">‡∏£‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</span>';
                }
                
                const position = positions.find(p => p.id === officer.position_id);
                const positionName = position ? position.name : '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
                
                // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ä‡∏∑‡πà‡∏≠
                const hasNameHistory = nameHistory[officer.id] && nameHistory[officer.id].length > 0;
                const nameHistoryDisplay = hasNameHistory ? 
                    `<button onclick="showNameHistoryModal('${officer.id}')" class="bg-yellow-500 text-white px-3 py-1 rounded-full text-xs font-medium hover:bg-yellow-600 transition-colors flex items-center justify-center min-w-[80px]">
                        <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                        ‡∏î‡∏π‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥
                    </button>` :
                    '<span class="text-gray-400 text-xs px-3 py-1 bg-gray-50 rounded-full min-w-[80px] text-center">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</span>';
                
                return `
                    <tr class="border-b hover:bg-gray-50">
                        <td class="px-4 py-2">${officer.id}</td>
                        <td class="px-4 py-2">${officer.name}</td>
                        <td class="px-4 py-2">${positionName}</td>
                        <td class="px-4 py-2">${org ? org.name : '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}</td>
                        <td class="px-4 py-2">${officer.phone}</td>
                        <td class="px-4 py-2">${officer.email}</td>
                        <td class="px-4 py-2 text-center">
                            ${nameHistoryDisplay}
                        </td>
                        <td class="px-4 py-2 text-center">
                            ${statusDisplay}
                            ${statusAction}
                        </td>
                        <td class="px-4 py-2 text-center">
                            <button onclick="editOfficer('${officer.id}')" class="bg-blue-500 text-white px-2 py-1 rounded text-sm hover:bg-blue-600 mr-1">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                            <button onclick="deleteOfficer('${officer.id}')" class="bg-red-500 text-white px-2 py-1 rounded text-sm hover:bg-red-600">‡∏•‡∏ö</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Load training data
        function loadTrainingData() {
            // Populate filter dropdowns
            populateTrainingFilters();
            
            // Display all officers initially
            displayFilteredTrainingData(officers);
        }
        
        // Populate training filter dropdowns
        function populateTrainingFilters() {
            // Populate organizations dropdown
            const orgFilter = document.getElementById('trainingOrgFilter');
            const orgOptions = organizations.map(org => 
                `<option value="${org.id}">${org.name}</option>`
            ).join('');
            orgFilter.innerHTML = `<option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>${orgOptions}`;
            
            // Populate specific year filter dropdown
            const yearFilter = document.getElementById('trainingSpecificYearFilter');
            const yearOptions = trainingYears.map(year => 
                `<option value="${year}">${year}</option>`
            ).join('');
            yearFilter.innerHTML = `<option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>${yearOptions}`;
        }
        
        // Display filtered training data
        function displayFilteredTrainingData(filteredOfficers) {
            console.log('Displaying training data. Years:', trainingYears, 'Officers:', filteredOfficers.length);
            console.log('Training data keys:', Object.keys(trainingData));
            
            // Create table header dynamically
            const thead = document.getElementById('trainingTableHeader');
            const yearHeaders = trainingYears.length > 0 ? 
                trainingYears.map(year => `<th class="px-4 py-2 text-center">${year}</th>`).join('') :
                '<th class="px-4 py-2 text-center text-gray-500">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏µ‡∏Å‡∏≤‡∏£‡∏≠‡∏ö‡∏£‡∏°</th>';
            
            thead.innerHTML = `
                <tr>
                    <th class="px-4 py-2 text-left">‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà</th>
                    <th class="px-4 py-2 text-left">‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•</th>
                    <th class="px-4 py-2 text-left">‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</th>
                    <th class="px-4 py-2 text-left">‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô</th>
                    ${yearHeaders}
                </tr>
            `;
            
            // Create table body
            const tbody = document.getElementById('trainingTableBody');
            tbody.innerHTML = filteredOfficers.map(officer => {
                const org = organizations.find(o => o.id === officer.orgId);
                
                // Debug: log training data for first few officers
                if (filteredOfficers.indexOf(officer) < 3) {
                    console.log(`Officer ${officer.id} training data:`, trainingData[officer.id]);
                }
                
                const yearCells = trainingYears.length > 0 ? 
                    trainingYears.map(year => {
                        const hasTraining = trainingData[officer.id]?.[year]?.length > 0;
                        const trainingList = trainingData[officer.id]?.[year] || [];
                        const displayText = hasTraining ? '‚úì' : '';
                        const bgColor = hasTraining ? 'bg-green-100' : '';
                        
                        // ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° tooltip ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ä‡∏∑‡πà‡∏≠
                        let tooltip = '';
                        if (hasTraining) {
                            const formattedTraining = trainingList.map(course => {
                                // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô object ‡∏ó‡∏µ‡πà‡∏°‡∏µ timestamp ‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÉ‡∏´‡∏°‡πà
                                if (typeof course === 'object' && course.course) {
                                    const officialName = course.officialName || course.officerNameAtTime || officer.name;
                                    return `‡∏õ‡∏µ ${year} | ‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£: ${course.course} | ‡∏ä‡∏∑‡πà‡∏≠‡∏ï‡∏≤‡∏°‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á: ${officialName}`;
                                }
                                // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô string ‡∏ò‡∏£‡∏£‡∏°‡∏î‡∏≤ ‡πÉ‡∏´‡πâ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏Å‡∏±‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Å‡πà‡∏≤
                                const nameAtTime = getOfficerNameAtTime(officer.id, `${year}-12-31`);
                                const officialName = nameAtTime || officer.name;
                                return `‡∏õ‡∏µ ${year} | ‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£: ${course} | ‡∏ä‡∏∑‡πà‡∏≠‡∏ï‡∏≤‡∏°‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á: ${officialName}`;
                            });
                            tooltip = `title="${formattedTraining.join(' | ')}"`;
                        }
                        
                        return `<td class="px-4 py-2 text-center cursor-pointer hover:bg-blue-100 ${bgColor}" ${tooltip} onclick="showTrainingModal('${officer.id}', '${year}')">${displayText}</td>`;
                    }).join('') :
                    '<td class="px-4 py-2 text-center text-gray-500">-</td>';
                
                const position = positions.find(p => p.id === officer.position_id);
                const positionName = position ? position.name : '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
                
                return `
                    <tr class="border-b hover:bg-gray-50">
                        <td class="px-4 py-2">${officer.id}</td>
                        <td class="px-4 py-2">${officer.name}</td>
                        <td class="px-4 py-2">${positionName}</td>
                        <td class="px-4 py-2">${org ? org.name : '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}</td>
                        ${yearCells}
                    </tr>
                `;
            }).join('');
            
            // Update result count
            const resultInfo = document.getElementById('trainingResultInfo');
            if (resultInfo) {
                resultInfo.textContent = `‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏• ${filteredOfficers.length} ‡∏à‡∏≤‡∏Å ${officers.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`;
            }
        }
        
        // Apply training filters
        function applyTrainingFilters() {
            const searchTerm = document.getElementById('trainingSearchInput').value.toLowerCase();
            const orgFilter = document.getElementById('trainingOrgFilter').value;
            const yearFilter = document.getElementById('trainingYearFilter').value;
            const specificYearFilter = document.getElementById('trainingSpecificYearFilter').value;
            
            console.log('üîç Applying training filters:', { searchTerm, orgFilter, yearFilter, specificYearFilter });
            
            const filteredOfficers = officers.filter(officer => {
                const org = organizations.find(o => o.id === officer.orgId);
                const orgName = org ? org.name : '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
                
                // ‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ï‡∏≤‡∏°‡∏Ñ‡∏≥‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
                const searchMatch = !searchTerm || 
                    officer.name.toLowerCase().includes(searchTerm) ||
                    officer.id.toLowerCase().includes(searchTerm) ||
                    orgName.toLowerCase().includes(searchTerm);
                
                // ‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô
                const orgMatch = !orgFilter || officer.orgId === orgFilter;
                
                // ‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏≠‡∏ö‡∏£‡∏°
                let yearMatch = true;
                if (yearFilter) {
                    if (specificYearFilter) {
                        // ‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏õ‡∏µ‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
                        const hasTrainingInYear = trainingData[officer.id]?.[specificYearFilter]?.length > 0;
                        yearMatch = (yearFilter === 'trained' && hasTrainingInYear) || 
                                   (yearFilter === 'not-trained' && !hasTrainingInYear);
                    } else {
                        // ‡∏Å‡∏£‡∏≠‡∏á‡∏ó‡∏∏‡∏Å‡∏õ‡∏µ
                        const hasAnyTraining = trainingYears.some(year => 
                            trainingData[officer.id]?.[year]?.length > 0
                        );
                        yearMatch = (yearFilter === 'trained' && hasAnyTraining) || 
                                   (yearFilter === 'not-trained' && !hasAnyTraining);
                    }
                }
                
                return searchMatch && orgMatch && yearMatch;
            });
            
            displayFilteredTrainingData(filteredOfficers);
        }
        
        // Clear training filters
        function clearTrainingFilters() {
            document.getElementById('trainingSearchInput').value = '';
            document.getElementById('trainingOrgFilter').value = '';
            document.getElementById('trainingYearFilter').value = '';
            document.getElementById('trainingSpecificYearFilter').value = '';
            
            displayFilteredTrainingData(officers);
        }
        
        // Export training data to Excel
        function exportTrainingData() {
            try {
                // Get currently filtered data
                const searchTerm = document.getElementById('trainingSearchInput').value.toLowerCase();
                const orgFilter = document.getElementById('trainingOrgFilter').value;
                const yearFilter = document.getElementById('trainingYearFilter').value;
                const specificYearFilter = document.getElementById('trainingSpecificYearFilter').value;
                
                let dataToExport = officers;
                
                // Apply same filters as display
                if (searchTerm || orgFilter || yearFilter) {
                    dataToExport = officers.filter(officer => {
                        const org = organizations.find(o => o.id === officer.orgId);
                        const orgName = org ? org.name : '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
                        
                        const searchMatch = !searchTerm || 
                            officer.name.toLowerCase().includes(searchTerm) ||
                            officer.id.toLowerCase().includes(searchTerm) ||
                            orgName.toLowerCase().includes(searchTerm);
                        
                        const orgMatch = !orgFilter || officer.orgId === orgFilter;
                        
                        let yearMatch = true;
                        if (yearFilter) {
                            if (specificYearFilter) {
                                const hasTrainingInYear = trainingData[officer.id]?.[specificYearFilter]?.length > 0;
                                yearMatch = (yearFilter === 'trained' && hasTrainingInYear) || 
                                           (yearFilter === 'not-trained' && !hasTrainingInYear);
                            } else {
                                const hasAnyTraining = trainingYears.some(year => 
                                    trainingData[officer.id]?.[year]?.length > 0
                                );
                                yearMatch = (yearFilter === 'trained' && hasAnyTraining) || 
                                           (yearFilter === 'not-trained' && !hasAnyTraining);
                            }
                        }
                        
                        return searchMatch && orgMatch && yearMatch;
                    });
                }
                
                // Create Excel data
                const headers = ['‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà', '‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•', '‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô', ...trainingYears];
                
                const excelData = dataToExport.map(officer => {
                    const org = organizations.find(o => o.id === officer.orgId);
                    const row = [
                        officer.id,
                        officer.name,
                        org ? org.name : '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'
                    ];
                    
                    // Add training status for each year
                    trainingYears.forEach(year => {
                        const trainingList = trainingData[officer.id]?.[year] || [];
                        row.push(trainingList.length > 0 ? trainingList.join(', ') : '');
                    });
                    
                    return row;
                });
                
                // Create workbook
                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.aoa_to_sheet([headers, ...excelData]);
                
                // Set column widths
                const colWidths = [
                    { wch: 15 }, // ID
                    { wch: 25 }, // Name
                    { wch: 30 }, // Organization
                    ...trainingYears.map(() => ({ wch: 20 })) // Training years
                ];
                ws['!cols'] = colWidths;
                
                XLSX.utils.book_append_sheet(wb, ws, '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏≠‡∏ö‡∏£‡∏°');
                
                // Generate filename with current date
                const now = new Date();
                const dateStr = now.toISOString().split('T')[0].replace(/-/g, '');
                const filename = `training_data_${dateStr}.xlsx`;
                
                XLSX.writeFile(wb, filename);
                
                console.log('Training data exported:', filename);
                alert(`‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ ${dataToExport.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£\\n‡πÑ‡∏ü‡∏•‡πå: ${filename}`);
                
            } catch (error) {
                console.error('Error exporting training data:', error);
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•');
            }
        }

        // Apply organization filters
        function applyOrgFilters() {
            const searchTerm = document.getElementById('orgSearchInput').value.toLowerCase();
            const memberFilter = document.getElementById('orgMemberFilter').value;
            const confirmFilter = document.getElementById('orgConfirmFilter').value;
            
            console.log('üîç Applying organization filters:', { searchTerm, memberFilter, confirmFilter });
            
            const filteredOrgs = organizations.filter(org => {
                // ‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ï‡∏≤‡∏°‡∏Ñ‡∏≥‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
                const searchMatch = !searchTerm || 
                    org.name.toLowerCase().includes(searchTerm) ||
                    org.id.toLowerCase().includes(searchTerm) ||
                    org.contact.toLowerCase().includes(searchTerm);
                
                // ‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å
                let memberMatch = true;
                if (memberFilter) {
                    // ‡∏ô‡∏±‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡πÇ‡∏î‡∏¢‡πÉ‡∏ä‡πâ‡∏ó‡∏±‡πâ‡∏á orgId ‡πÅ‡∏•‡∏∞ organization
                    const memberCount = officers.filter(officer => 
                        officer.orgId === org.id || officer.organization === org.name
                    ).length;
                    switch(memberFilter) {
                        case '1-5':
                            memberMatch = memberCount >= 1 && memberCount <= 5;
                            break;
                        case '6-10':
                            memberMatch = memberCount >= 6 && memberCount <= 10;
                            break;
                        case '11-20':
                            memberMatch = memberCount >= 11 && memberCount <= 20;
                            break;
                        case '21+':
                            memberMatch = memberCount >= 21;
                            break;
                    }
                }
                
                // ‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô
                let confirmMatch = true;
                if (confirmFilter) {
                    const confirmStatus = confirmationStatus[org.id];
                    const isConfirmed = confirmStatus?.orgConfirmed && confirmStatus?.teamConfirmed;
                    confirmMatch = (confirmFilter === 'confirmed' && isConfirmed) || (confirmFilter === 'pending' && !isConfirmed);
                }
                
                return searchMatch && memberMatch && confirmMatch;
            });
            
            displayFilteredOrganizations(filteredOrgs);
        }
        
        function clearOrgFilters() {
            document.getElementById('orgSearchInput').value = '';
            document.getElementById('orgMemberFilter').value = '';
            document.getElementById('orgConfirmFilter').value = '';
            loadOrganizationsData();
        }
        
        function displayFilteredOrganizations(filteredOrgs) {
            const tbody = document.getElementById('organizationsTableBody');
            if (!tbody) {
                console.error('‚ùå Organizations table body not found');
                return;
            }
            
            if (filteredOrgs.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="px-4 py-8 text-center text-gray-500">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç</td></tr>';
                return;
            }
            
            tbody.innerHTML = filteredOrgs.map(org => {
                const memberCount = officers.filter(officer => officer.orgId === org.id).length;
                const confirmStatus = confirmationStatus[org.id];
                const isConfirmed = confirmStatus?.orgConfirmed && confirmStatus?.teamConfirmed;
                const confirmBadge = isConfirmed ? 
                    '<span class="bg-green-100 text-green-800 px-2 py-1 rounded text-xs">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏•‡πâ‡∏ß</span>' :
                    '<span class="bg-gray-100 text-gray-600 px-2 py-1 rounded text-xs">‡∏£‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</span>';
                
                // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏° header: ‡∏£‡∏´‡∏±‡∏™‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô, ‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô, ‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå, ‡πÇ‡∏ó‡∏£‡∏™‡∏≤‡∏£, ‡∏≠‡∏µ‡πÄ‡∏°‡∏•, ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô, ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£
                const orgId = org.id || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
                const orgName = org.name || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
                const orgPhone = org.phone || org.contact || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
                const orgFax = org.fax || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
                const orgEmail = org.email || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
                
                console.log('üìã Organization data:', { orgId, orgName, orgPhone, orgFax, orgEmail, org });
                
                return `
                    <tr class="hover:bg-gray-50">
                        <td class="px-4 py-2">${orgId}</td>
                        <td class="px-4 py-2">${orgName}</td>
                        <td class="px-4 py-2">${orgPhone}</td>
                        <td class="px-4 py-2">${orgFax}</td>
                        <td class="px-4 py-2">${orgEmail}</td>
                        <td class="px-4 py-2 text-center">${confirmBadge}</td>
                        <td class="px-4 py-2">
                            <div class="flex gap-2">
                                <button onclick="editOrganization('${orgId}')" class="bg-blue-500 text-white px-2 py-1 rounded text-sm hover:bg-blue-600">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                                ${userRole === 'admin' ? `
                                    <button onclick="resetConfirmationStatus('${orgId}')" class="bg-orange-500 text-white px-2 py-1 rounded text-sm hover:bg-orange-600" title="‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô">‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï</button>
                                    <button onclick="deleteOrganization('${orgId}')" class="bg-red-500 text-white px-2 py-1 rounded text-sm hover:bg-red-600">‡∏•‡∏ö</button>` : ''}
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
            
            console.log(`‚úÖ Displayed ${filteredOrgs.length} filtered organizations`);
        }
        
        // Load organizations data
        function loadOrganizationsData() {
            console.log('üè¢ Loading organizations data...');
            displayFilteredOrganizations(organizations);
        }
        
        // Legacy function kept for compatibility 
        function loadOrganizationsDataOld() {
            console.log('Loading organizations data...');
            const tbody = document.getElementById('organizationsTableBody');
            if (!tbody) {
                console.error('organizationsTableBody element not found');
                return;
            }
            
            console.log('Found', organizations.length, 'organizations to display');
            
            if (organizations.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="px-4 py-8 text-center text-gray-500">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô</td></tr>';
                return;
            }
            
            tbody.innerHTML = organizations.map(org => {
                const confirmStatus = confirmationStatus[org.id];
                let statusDisplay = '';
                let statusAction = '';
                
                if (confirmStatus && confirmStatus.orgConfirmed) {
                    statusDisplay = '<span class="bg-green-100 text-green-800 px-2 py-1 rounded text-xs">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏•‡πâ‡∏ß</span>';
                    statusAction = `<button onclick="resetOrgConfirmationEnhanced('${org.id}')" class="bg-orange-500 text-white px-2 py-1 rounded text-xs hover:bg-orange-600 ml-1">‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï</button>`;
                } else {
                    statusDisplay = '<span class="bg-gray-100 text-gray-600 px-2 py-1 rounded text-xs">‡∏£‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</span>';
                }
                
                return `
                    <tr class="border-b hover:bg-gray-50">
                        <td class="px-4 py-2">${org.id}</td>
                        <td class="px-4 py-2">${org.name}</td>
                        <td class="px-4 py-2">${org.phone}</td>
                        <td class="px-4 py-2">${org.fax}</td>
                        <td class="px-4 py-2">${org.email}</td>
                        <td class="px-4 py-2 text-center">
                            ${statusDisplay}
                            ${statusAction}
                        </td>
                        <td class="px-4 py-2 text-center">
                            <button onclick="editOrganization('${org.id}')" class="bg-blue-500 text-white px-2 py-1 rounded text-sm hover:bg-blue-600 mr-1">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                                                                <button onclick="resetConfirmationStatus('${orgId}')" class="bg-orange-500 text-white px-2 py-1 rounded text-sm hover:bg-orange-600" title="‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô">‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï</button>
                                    <button onclick="deleteOrganization('${org.id}')" class="bg-red-500 text-white px-2 py-1 rounded text-sm hover:bg-red-600">‡∏•‡∏ö</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Load user accounts data
        function loadUserAccountsData() {
            console.log('Loading user accounts data...');
            const tbody = document.getElementById('userAccountsTableBody');
            if (!tbody) {
                console.error('userAccountsTableBody element not found');
                return;
            }
            
            console.log('Found', users.length, 'users to display');
            
            if (users.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="px-4 py-8 text-center text-gray-500">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</td></tr>';
                return;
            }
            
            tbody.innerHTML = users.map(user => {
                const org = organizations.find(o => o.id === user.orgId);
                return `
                    <tr class="border-b hover:bg-gray-50">
                        <td class="px-4 py-2">${user.name}</td>
                        <td class="px-4 py-2">${org ? org.name : '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}</td>
                        <td class="px-4 py-2">${user.username}</td>
                        <td class="px-4 py-2">${user.password}</td>
                        <td class="px-4 py-2">${user.role === 'admin' ? '‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö' : '‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà'}</td>
                        <td class="px-4 py-2 text-center">
                            <button onclick="editUser('${user.username}')" class="bg-blue-500 text-white px-2 py-1 rounded text-sm hover:bg-blue-600 mr-1">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                            <button onclick="deleteUser('${user.username}')" class="bg-red-500 text-white px-2 py-1 rounded text-sm hover:bg-red-600">‡∏•‡∏ö</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Format deletion detail for better readability
        function formatDeletionDetail(detail) {
            if (detail.includes('‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏•‡∏ö:')) {
                const parts = detail.split(' | ');
                let formatted = parts[0]; // Main action
                
                const reasonPart = parts.find(part => part.includes('‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏•‡∏ö:'));
                if (reasonPart) {
                    const reason = reasonPart.replace('‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏•‡∏ö:', '').trim();
                    formatted += `<br><span class="text-red-600 font-semibold">‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•:</span> <span class="text-red-700">${reason}</span>`;
                }
                
                const statusPart = parts.find(part => part.includes('‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏õ‡πá‡∏ô:'));
                if (statusPart) {
                    const status = statusPart.replace('‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏õ‡πá‡∏ô:', '').trim();
                    formatted += `<br><span class="text-gray-600">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÉ‡∏´‡∏°‡πà:</span> <span class="text-gray-700">${status}</span>`;
                }
                
                return formatted;
            }
            return detail;
        }

        // Load activity log data
        function loadActivityLogData() {
            const tbody = document.getElementById('activityLogTableBody');
            // Filter only add, edit, delete, confirm, reset actions
            const filteredLog = activityLog.filter(log => 
                log.action === '‡πÄ‡∏û‡∏¥‡πà‡∏°' || log.action === '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç' || log.action === '‡∏•‡∏ö' || log.action === '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô' || log.action === '‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï'
            );
            
            tbody.innerHTML = filteredLog.map((log, index) => {
                const isDeletion = log.action === '‡∏•‡∏ö';
                const formattedDetail = isDeletion ? formatDeletionDetail(log.detail) : log.detail;
                
                return `
                <tr class="border-b hover:bg-gray-50 ${isDeletion ? 'bg-red-50' : ''}">
                    <td class="px-4 py-2">${log.date}</td>
                    <td class="px-4 py-2">${log.time}</td>
                    <td class="px-4 py-2">${log.user}</td>
                    <td class="px-4 py-2">
                        ${isDeletion ? '<span class="text-red-600 font-semibold">‡∏•‡∏ö</span>' : log.action}
                    </td>
                    <td class="px-4 py-2">
                        <div class="${isDeletion ? 'text-sm' : ''}">
                            ${formattedDetail}
                        </div>
                    </td>
                    <td class="px-4 py-2 text-center">
                        ${log.status === '‡∏£‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô' ? 
                            `<button onclick="acknowledgeActivity(${index})" class="bg-orange-500 text-white px-3 py-1 rounded text-sm hover:bg-orange-600">‡∏£‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</button>` :
                            `<span class="bg-green-100 text-green-800 px-3 py-1 rounded text-sm">‡∏£‡∏±‡∏ö‡∏ó‡∏£‡∏≤‡∏ö</span>`
                        }
                    </td>
                </tr>
            `}).join('');
        }

        // Modal functions
        function showModal(content) {
            document.getElementById('modalContent').innerHTML = content;
            document.getElementById('modalOverlay').classList.remove('hidden');
        }

        function hideModal() {
            document.getElementById('modalOverlay').classList.add('hidden');
        }

        // Click outside modal to close
        document.getElementById('modalOverlay').addEventListener('click', function(e) {
            if (e.target === this) {
                hideModal();
            }
        });

        // Officer training history modal
        function showOfficerTrainingHistory(officerId) {
            const officer = officers.find(o => o.id === officerId);
            const training = trainingData[officerId] || {};
            
            let totalCourses = 0;
            let trainingHistory = [];
            
            Object.keys(training).forEach(year => {
                const courses = training[year];
                if (courses && courses.length > 0) {
                    courses.forEach(course => {
                        totalCourses++;
                        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà (object) ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏Å‡πà‡∏≤ (string)
                        if (typeof course === 'object' && course.course) {
                            const officialName = course.officialName || course.officerNameAtTime || officer.name;
                            trainingHistory.push(`‡∏õ‡∏µ ${year} | ‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£: ${course.course} | ‡∏ä‡∏∑‡πà‡∏≠‡∏ï‡∏≤‡∏°‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á: ${officialName}`);
                        } else {
                            // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô string
                            const nameAtTime = getOfficerNameAtTime(officerId, `${year}-12-31`);
                            const officialName = nameAtTime || officer.name;
                            trainingHistory.push(`‡∏õ‡∏µ ${year} | ‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£: ${course} | ‡∏ä‡∏∑‡πà‡∏≠‡∏ï‡∏≤‡∏°‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á: ${officialName}`);
                        }
                    });
                }
            });
            
            const content = `
                <h3 class="text-lg font-bold text-dark-green mb-4">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏≠‡∏ö‡∏£‡∏°</h3>
                <p class="mb-4"><strong>‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà:</strong> ${officer.name}</p>
                <div class="mb-4 p-4 bg-gray-50 rounded">
                    <p class="text-sm text-gray-700 mb-2">‡∏ó‡πà‡∏≤‡∏ô‡πÄ‡∏Ñ‡∏¢‡πÄ‡∏Ç‡πâ‡∏≤‡∏≠‡∏ö‡∏£‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î <strong>${totalCourses}</strong> ‡∏Ñ‡∏£‡∏±‡πâ‡∏á</p>
                    ${trainingHistory.length > 0 ? `
                        <div class="space-y-2 max-h-60 overflow-y-auto">
                            ${trainingHistory.map(history => `<p class="text-sm text-gray-700 p-2 bg-white rounded border">‚Ä¢ ${history}</p>`).join('')}
                        </div>
                    ` : '<p class="text-sm text-gray-700">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏≠‡∏ö‡∏£‡∏°</p>'}
                </div>
                <div class="flex justify-end">
                    <button onclick="hideModal()" class="px-4 py-2 bg-gray-300 text-gray-700 rounded hover:bg-gray-400">‡∏õ‡∏¥‡∏î</button>
                </div>
            `;
            showModal(content);
        }

        // Training modal
        function showTrainingModal(officerId, year) {
            const officer = officers.find(o => o.id === officerId);
            const courses = trainingData[officerId]?.[year] || [];
            
            // ‡πÅ‡∏™‡∏î‡∏á‡∏ä‡∏∑‡πà‡∏≠ ‡∏ì ‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏≠‡∏ö‡∏£‡∏°
            const nameAtTime = getOfficerNameAtTime(officerId, `${year}-12-31`);
            let nameDisplay = officer.name;
            if (nameAtTime !== officer.name) {
                nameDisplay = `${officer.name} (‡πÄ‡∏î‡∏¥‡∏°‡∏ä‡∏∑‡πà‡∏≠ ${nameAtTime} ‡πÉ‡∏ô‡∏õ‡∏µ ${year})`;
            }
            
            // ‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏µ ‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£‡πÅ‡∏•‡∏∞‡∏ä‡∏∑‡πà‡∏≠‡∏ï‡∏≤‡∏°‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á
            const formattedCourses = courses.map(course => {
                if (typeof course === 'object' && course.course) {
                    const officialName = course.officialName || course.officerNameAtTime || officer.name;
                    return `‡∏õ‡∏µ ${year} | ‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£: ${course.course} | ‡∏ä‡∏∑‡πà‡∏≠‡∏ï‡∏≤‡∏°‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á: ${officialName}`;
                }
                // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô string
                const officialName = nameAtTime || officer.name;
                return `‡∏õ‡∏µ ${year} | ‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£: ${course} | ‡∏ä‡∏∑‡πà‡∏≠‡∏ï‡∏≤‡∏°‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á: ${officialName}`;
            });
            
            const content = `
                <h3 class="text-lg font-bold text-dark-green mb-4">‡∏Å‡∏≤‡∏£‡∏≠‡∏ö‡∏£‡∏°‡∏õ‡∏µ ${year}</h3>
                <p class="mb-4"><strong>‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà:</strong> ${nameDisplay}</p>
                ${formattedCourses.length > 0 ? `
                <div class="mb-4 p-4 bg-blue-50 border border-blue-200 rounded">
                    <h4 class="font-semibold text-blue-800 mb-2">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏≠‡∏ö‡∏£‡∏°:</h4>
                    <ul class="space-y-1">
                        ${formattedCourses.map(course => `<li class="text-sm text-blue-700">‚Ä¢ ${course}</li>`).join('')}
                    </ul>
                </div>` : '<p class="mb-4 text-gray-500">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏≠‡∏ö‡∏£‡∏°</p>'}
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏≠‡∏ö‡∏£‡∏°</label>
                    <textarea id="trainingCourses" class="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-medium-green" rows="4" placeholder="‡πÉ‡∏™‡πà‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏≠‡∏ö‡∏£‡∏° (‡πÅ‡∏¢‡∏Å‡∏î‡πâ‡∏ß‡∏¢‡∏Å‡∏≤‡∏£‡∏Ç‡∏∂‡πâ‡∏ô‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÉ‡∏´‡∏°‡πà)">${courses.map(c => typeof c === 'object' ? c.course : c).join('\n')}</textarea>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">‡∏ä‡∏∑‡πà‡∏≠‡∏ï‡∏≤‡∏°‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á</label>
                    <input type="text" id="officialName" class="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-medium-green" placeholder="‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•‡∏ï‡∏≤‡∏°‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á" value="${courses.length > 0 && typeof courses[0] === 'object' && courses[0].officialName ? courses[0].officialName : (officer ? officer.name : '')}">
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">‡∏ä‡∏∑‡πà‡∏≠‡∏ï‡∏≤‡∏°‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á</label>
                    <input type="text" id="officialName" class="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-medium-green" placeholder="‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•‡∏ï‡∏≤‡∏°‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á" value="${courses.length > 0 && typeof courses[0] === 'object' && courses[0].officialName ? courses[0].officialName : (officer ? officer.name : '')}">
                </div>
                ${formattedCourses.length > 0 && formattedCourses.some(c => c.includes('‡∏Å‡πà‡∏≠‡∏ô‡∏à‡∏∞‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏ö‡∏ö‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô')) ? 
                    `<div class="mb-4 p-3 bg-yellow-50 border border-yellow-200 rounded">
                        <p class="text-sm text-yellow-800"><strong>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏:</strong> ‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£‡∏ó‡∏µ‡πà‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≤‡∏á‡∏ï‡πâ‡∏ô‡πÉ‡∏ä‡πâ‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏• ‡∏ì ‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏≠‡∏ö‡∏£‡∏°</p>
                        <p class="text-xs text-yellow-700 mt-1">‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£: ${formattedCourses.join(', ')}</p>
                    </div>` : ''
                }
                <div class="flex justify-end space-x-2">
                    <button onclick="hideModal()" class="px-4 py-2 bg-gray-300 text-gray-700 rounded hover:bg-gray-400">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                    <button onclick="saveTraining('${officerId}', '${year}')" class="px-4 py-2 bg-medium-green text-white rounded hover:bg-dark-green">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                </div>
            `;
            showModal(content);
        }

        async function saveTraining(officerId, year) {
            const coursesText = document.getElementById('trainingCourses').value.split('\n').filter(course => course.trim() !== '');
            const officialName = document.getElementById('officialName').value.trim();
            
            try {
                // Get old value for logging
                const oldCourses = trainingData[officerId]?.[year] || [];
                const oldValue = oldCourses.length > 0 ? 
                    oldCourses.map(c => typeof c === 'object' ? c.course : c).join(', ') : '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•';
                const newValue = coursesText.length > 0 ? coursesText.join(', ') : '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•';
                
                if (!trainingData[officerId]) {
                    trainingData[officerId] = {};
                }
                
                // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏≠‡∏ö‡∏£‡∏°‡∏û‡∏£‡πâ‡∏≠‡∏° timestamp, ‡∏ä‡∏∑‡πà‡∏≠ ‡∏ì ‡πÄ‡∏ß‡∏•‡∏≤‡∏ô‡∏±‡πâ‡∏ô ‡πÅ‡∏•‡∏∞‡∏ä‡∏∑‡πà‡∏≠‡∏ï‡∏≤‡∏°‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á
                const officer = officers.find(o => o.id === officerId);
                const currentTimestamp = new Date().toISOString();
                
                trainingData[officerId][year] = coursesText.map(course => ({
                    course: course,
                    timestamp: currentTimestamp,
                    officerNameAtTime: officer ? officer.name : '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•',
                    officialName: officialName || (officer ? officer.name : ''),
                    updatedBy: currentUser.username
                }));
                
                // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á Firebase
                await saveToFirebase('trainingData', trainingData);
                
                await logActivity('‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç', `‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏≠‡∏ö‡∏£‡∏° ${officerId} ‡∏õ‡∏µ ${year}`, oldValue, newValue);
                hideModal();
                loadTrainingData();
                
            } catch (error) {
                console.error('Error saving training data:', error);
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•');
            }
        }

        // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
        let nextOfficerNumber = null; // Cache ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ã‡πâ‡∏≥
        
        function generateOfficerId() {
            // ‡∏´‡∏≤‡πÄ‡∏•‡∏Ç‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏à‡∏≤‡∏Å‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà (‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏ï‡πà‡∏≠‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤)
            if (nextOfficerNumber === null) {
                let maxNumber = 0;
                
                officers.forEach(officer => {
                    if (officer.id && officer.id.startsWith('SRRT')) {
                        const numberPart = officer.id.substring(4); // ‡∏ï‡∏±‡∏î‡∏Ñ‡∏≥‡∏ß‡πà‡∏≤ 'SRRT' ‡∏≠‡∏≠‡∏Å
                        const number = parseInt(numberPart);
                        if (!isNaN(number) && number > maxNumber) {
                            maxNumber = number;
                        }
                    }
                });
                
                nextOfficerNumber = maxNumber + 1;
            }
            
            // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏´‡∏±‡∏™‡πÉ‡∏´‡∏°‡πà‡πÅ‡∏•‡∏∞‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏•‡∏Ç‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ñ‡∏±‡∏î‡πÑ‡∏õ
            const currentNumber = nextOfficerNumber;
            nextOfficerNumber++;
            
            const paddedNumber = currentNumber.toString().padStart(4, '0');
            return `SRRT${paddedNumber}`;
        }
        
        // Reset ‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏ö‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
        function resetOfficerIdGenerator() {
            nextOfficerNumber = null;
        }
        
        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏•‡∏±‡∏ö‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á view ‡πÅ‡∏•‡∏∞ edit mode ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡∏°
        function toggleTeamOrgEditMode() {
            const viewMode = document.getElementById('orgInfoViewMode');
            const editMode = document.getElementById('orgInfoEditMode');
            const editButtons = document.getElementById('orgEditButtons');
            const isEditMode = editMode.style.display !== 'none';
            
            if (isEditMode) {
                // ‡∏™‡∏•‡∏±‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ view mode
                viewMode.style.display = 'grid';
                editMode.style.display = 'none';
                editButtons.style.display = 'none';
            } else {
                // ‡∏™‡∏•‡∏±‡∏ö‡πÑ‡∏õ edit mode
                viewMode.style.display = 'none';
                editMode.style.display = 'grid';
                editButtons.style.display = 'block';
            }
        }

        // Save functions
        async function saveOrgInfo() {
            const phone = document.getElementById('editPhone').value;
            const fax = document.getElementById('editFax').value;
            const email = document.getElementById('editEmail').value;
            
            try {
                // Find current organization
                const userOrg = organizations.find(org => org.id === currentUser.orgId);
                
                // Log changes for each field that was modified
                if (userOrg) {
                    if (phone !== userOrg.phone) {
                        await logActivity('‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç', `‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô ${userOrg.id}`, userOrg.phone, phone);
                        userOrg.phone = phone;
                    }
                    if (fax !== userOrg.fax) {
                        await logActivity('‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç', `‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÇ‡∏ó‡∏£‡∏™‡∏≤‡∏£‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô ${userOrg.id}`, userOrg.fax, fax);
                        userOrg.fax = fax;
                    }
                    if (email !== userOrg.email) {
                        await logActivity('‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç', `‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô ${userOrg.id}`, userOrg.email, email);
                        userOrg.email = email;
                    }
                    
                    // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á Firebase
                    await saveToFirebase('organizations', organizations);
                    
                    // Refresh dropdowns after organization change
                    populateOrganizationDropdowns();
                    
                    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô view mode
                    document.getElementById('viewOrgPhone').textContent = phone || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
                    document.getElementById('viewOrgFax').textContent = fax || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
                    document.getElementById('viewOrgEmail').textContent = email || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
                    
                    // ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ view mode
                    toggleTeamOrgEditMode();
                }
                
                alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
                
            } catch (error) {
                console.error('Error saving organization info:', error);
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•');
            }
        }

        // Log activity
        async function logActivity(action, detail, oldValue = null, newValue = null) {
            // Only log add, edit, delete, confirm, reset actions
            if (action === '‡πÄ‡∏û‡∏¥‡πà‡∏°' || action === '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç' || action === '‡∏•‡∏ö' || action === '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô' || action === '‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï') {
                const now = new Date();
                const date = now.toISOString().split('T')[0];
                const time = now.toTimeString().split(' ')[0].substring(0, 5);
                
                let formattedDetail = detail;
                
                // For edit actions, format with old and new values
                if (action === '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç' && oldValue !== null && newValue !== null) {
                    formattedDetail = `${detail} | ‡πÄ‡∏î‡∏¥‡∏°: ${oldValue} | ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô: ${newValue}`;
                }
                
                const logEntry = {
                    date: date,
                    time: time,
                    user: currentUser ? currentUser.username : 'system',
                    action: action,
                    detail: formattedDetail,
                    status: '‡∏£‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô'
                };
                
                activityLog.unshift(logEntry);
                
                // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á Firebase
                try {
                    await saveToFirebase('activityLog', activityLog);
                } catch (error) {
                    console.error('Error saving activity log:', error);
                }
            }
        }

        // Acknowledge activity function
        function acknowledgeActivity(index) {
            const filteredLog = activityLog.filter(log => 
                log.action === '‡πÄ‡∏û‡∏¥‡πà‡∏°' || log.action === '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç' || log.action === '‡∏•‡∏ö' || log.action === '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô' || log.action === '‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï'
            );
            
            if (filteredLog[index] && filteredLog[index].status === '‡∏£‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô') {
                // Find the original log entry and update it
                const originalIndex = activityLog.findIndex(log => 
                    log.date === filteredLog[index].date && 
                    log.time === filteredLog[index].time && 
                    log.detail === filteredLog[index].detail
                );
                
                if (originalIndex !== -1) {
                    activityLog[originalIndex].status = '‡∏£‡∏±‡∏ö‡∏ó‡∏£‡∏≤‡∏ö';
                    loadActivityLogData(); // Refresh the table
                }
            }
        }

        // Search and filter functions
        function searchOfficers() {
            filterOfficers();
        }
        
        function filterOfficers() {
            const searchTerm = document.getElementById('officerSearch')?.value.toLowerCase() || '';
            const orgFilter = document.getElementById('orgFilter')?.value || '';
            const trainingFilter = document.getElementById('trainingFilter')?.value || '';
            
            const orgBlocks = document.querySelectorAll('#officerDashboard .mb-8');
            
            orgBlocks.forEach(block => {
                const rows = block.querySelectorAll('tbody tr');
                let hasVisibleRows = false;
                
                rows.forEach(row => {
                    const officerId = row.cells[0]?.textContent || '';
                    const officerName = row.cells[1]?.textContent || '';
                    const orgName = row.cells[2]?.textContent || '';
                    
                    // Get officer data for training filter
                    const officer = officers.find(o => o.id === officerId);
                    let hasTraining = false;
                    if (officer && trainingData[officer.id]) {
                        hasTraining = Object.values(trainingData[officer.id]).some(courses => courses && courses.length > 0);
                    }
                    
                    // Apply filters
                    let showRow = true;
                    
                    // Search filter
                    if (searchTerm) {
                        const searchText = `${officerId} ${officerName} ${orgName}`.toLowerCase();
                        if (!searchText.includes(searchTerm)) {
                            showRow = false;
                        }
                    }
                    
                    // Organization filter
                    if (orgFilter && officer && officer.orgId !== orgFilter) {
                        showRow = false;
                    }
                    
                    // Training status filter
                    if (trainingFilter) {
                        if (trainingFilter === 'trained' && !hasTraining) {
                            showRow = false;
                        } else if (trainingFilter === 'not-trained' && hasTraining) {
                            showRow = false;
                        }
                    }
                    
                    row.style.display = showRow ? '' : 'none';
                    if (showRow) hasVisibleRows = true;
                });
                
                // Hide/show entire organization block if no visible rows
                block.style.display = hasVisibleRows ? '' : 'none';
            });
        }
        
        // Confirmation functions
        function updateConfirmationStatusDisplay() {
            const userOrg = currentUser.orgId;
            const status = confirmationStatus[userOrg];
            
            // Get elements
            const teamStatusEl = document.getElementById('teamConfirmStatus');
            const orgStatusEl = document.getElementById('orgConfirmStatus');
            const confirmBtn = document.getElementById('confirmTeamDataBtn');
            const confirmationSection = document.getElementById('confirmationSection');
            const confirmedMessage = document.getElementById('confirmedMessage');
            
            // Check if user has confirmed their data
            const userHasConfirmed = status && status.teamConfirmed;
            
            if (userHasConfirmed) {
                // Hide both confirmation section and confirmed message completely
                if (confirmationSection) {
                    confirmationSection.style.display = 'none';
                }
                if (confirmedMessage) {
                    confirmedMessage.style.display = 'none';
                    confirmedMessage.classList.add('hidden');
                }
            } else {
                // Show confirmation section and hide confirmed message
                if (confirmationSection) {
                    confirmationSection.style.display = 'block';
                }
                if (confirmedMessage) {
                    confirmedMessage.style.display = 'none';
                    confirmedMessage.classList.add('hidden');
                }
                
                // Update status displays when section is visible
                if (teamStatusEl) {
                    if (status && status.teamConfirmed) {
                        teamStatusEl.textContent = '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏•‡πâ‡∏ß';
                        teamStatusEl.className = 'inline-block px-3 py-1 rounded text-sm font-medium bg-green-100 text-green-800';
                    } else {
                        teamStatusEl.textContent = '‡∏£‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô';
                        teamStatusEl.className = 'inline-block px-3 py-1 rounded text-sm font-medium bg-gray-100 text-gray-600';
                    }
                }
                
                if (orgStatusEl) {
                    if (status && status.orgConfirmed) {
                        orgStatusEl.textContent = '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏•‡πâ‡∏ß';
                        orgStatusEl.className = 'inline-block px-3 py-1 rounded text-sm font-medium bg-green-100 text-green-800';
                    } else {
                        orgStatusEl.textContent = '‡∏£‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô';
                        orgStatusEl.className = 'inline-block px-3 py-1 rounded text-sm font-medium bg-gray-100 text-gray-600';
                    }
                }
                
                // Update button state
                if (confirmBtn) {
                    if (status && status.teamConfirmed && status.orgConfirmed) {
                        confirmBtn.textContent = '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏•‡πâ‡∏ß';
                        confirmBtn.disabled = true;
                        confirmBtn.className = 'bg-gray-400 text-white px-6 py-2 rounded cursor-not-allowed';
                    } else {
                        confirmBtn.textContent = '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•';
                        confirmBtn.disabled = false;
                        confirmBtn.className = 'bg-green-600 text-white px-6 py-2 rounded hover:bg-green-700';
                    }
                }
            }
        }
        
        function confirmTeamData() {
            const userOrg = currentUser.orgId;
            
            if (confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡∏°‡πÅ‡∏•‡∏∞‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) {
                confirmationStatus[userOrg].teamConfirmed = true;
                confirmationStatus[userOrg].orgConfirmed = true;
                
                logActivity('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô', `‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡∏°‡πÅ‡∏•‡∏∞‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô ${userOrg}`);
                updateConfirmationStatusDisplay();
                
                alert('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏à‡∏≤‡∏Å‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö');
            }
        }
        
        function resetTeamConfirmation(orgId) {
            if (confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡∏°‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) {
                confirmationStatus[orgId].teamConfirmed = false;
                logActivity('‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï', `‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡∏° ${orgId}`);
                loadAllOfficersData();
                updateConfirmationStatusDisplay();
                alert('‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
            }
        }
        
        function resetOrgConfirmation(orgId) {
            if (confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) {
                confirmationStatus[orgId].orgConfirmed = false;
                logActivity('‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï', `‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô ${orgId}`);
                loadOrganizationsData();
                updateConfirmationStatusDisplay();
                alert('‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
            }
        }
        
        // Modal functions for adding new records
        function showAddMemberModal() {
            const content = `
                <h3 class="text-lg font-bold text-dark-green mb-4">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡πÉ‡∏´‡∏°‡πà‡πÉ‡∏ô‡∏ó‡∏µ‡∏°</h3>
                <form id="addMemberForm">
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà</label>
                            <input type="text" id="memberOfficerId" placeholder="‡πÄ‡∏ä‡πà‡∏ô OFF001" class="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-medium-green" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</label>
                            <input type="text" id="memberName" class="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-medium-green" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå</label>
                            <input type="tel" id="memberPhone" placeholder="081-234-5678" class="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-medium-green" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">‡∏≠‡∏µ‡πÄ‡∏°‡∏•</label>
                            <input type="email" id="memberEmail" placeholder="example@bma.go.th" class="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-medium-green" required>
                        </div>
                    </div>
                    <div class="flex justify-end space-x-2 mt-6">
                        <button type="button" onclick="hideModal()" class="px-4 py-2 bg-gray-300 text-gray-700 rounded hover:bg-gray-400">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                        <button type="submit" class="px-4 py-2 bg-medium-green text-white rounded hover:bg-dark-green">‡πÄ‡∏û‡∏¥‡πà‡∏•‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</button>
                    </div>
                </form>
            `;
            showModal(content);
            
            // Add form submit handler
            document.getElementById('addMemberForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                await addNewMember();
            });
        }
        
        async function addNewMember() {
            try {
                const officerId = document.getElementById('memberOfficerId').value.trim().toUpperCase();
                const name = document.getElementById('memberName').value.trim();
                const phone = document.getElementById('memberPhone').value.trim();
                const email = document.getElementById('memberEmail').value.trim();
                
                // Validation
                if (!officerId || !name || !phone || !email) {
                    alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô');
                    return;
                }
                
                // Check if officer ID already exists
                const existingOfficer = officers.find(o => o.id === officerId);
                if (existingOfficer) {
                    alert('‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß');
                    return;
                }
                
                const newOfficer = {
                    id: officerId,
                    name: name,
                    phone: phone,
                    email: email,
                    orgId: currentUser.orgId,
                    createdAt: new Date().toISOString()
                };
                
                // Add to local array
                officers.push(newOfficer);
                
                // Save to Firebase
                const officerRef = window.firebasePush(window.firebaseRef(window.firebaseDatabase, 'officers'));
                await window.firebaseSet(officerRef, newOfficer);
                
                // Initialize training data for new officer
                if (!trainingData[officerId]) {
                    trainingData[officerId] = {};
                    await saveToFirebase('trainingData', trainingData);
                }
                
                await logActivity('‡πÄ‡∏û‡∏¥‡πà‡∏°', `‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡πÉ‡∏´‡∏°‡πà: ${name} (${officerId})`);
                
                hideModal();
                loadTeamData(); // Refresh team data
                alert('‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
                
            } catch (error) {
                console.error('Error adding member:', error);
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å');
            }
        }
        
        // Real-time data refresh function
        async function refreshAllTabsData() {
            console.log('Refreshing all tabs data in real-time...');
            try {
                // ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Firebase
                await loadDataFromFirebase();
                
                // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ó‡∏∏‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡∏¥‡∏î‡∏≠‡∏¢‡∏π‡πà
                const activeTab = document.querySelector('.tab-content:not(.hidden)');
                if (activeTab) {
                    const tabId = activeTab.id;
                    console.log('Refreshing active tab:', tabId);
                    
                    switch(tabId) {
                        case 'summaryReport':
                            loadSummaryReportDataWithRetry();
                            updatePositionSummary(); // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏£‡∏∏‡∏õ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏î‡πâ‡∏ß‡∏¢
                            break;
                        case 'officerDashboard':
                            loadOfficerDashboardData();
                            break;
                        case 'teamManagement':
                            loadTeamData();
                            break;
                        case 'allOfficersDB':
                            loadAllOfficersData();
                            break;
                        case 'organizationsDB':
                            loadOrganizationsData();
                            break;
                        case 'activityLog':
                            loadActivityLogData();
                            break;
                        case 'userAccounts':
                            loadUserAccountsData();
                            break;
                    }
                }
                
                console.log('Real-time refresh completed');
            } catch (error) {
                console.error('Error refreshing data:', error);
            }
        }
        
        // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ auto-refresh ‡∏ó‡∏∏‡∏Å 30 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
        let autoRefreshInterval = null;
        
        function startAutoRefresh() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
            }
            
            autoRefreshInterval = setInterval(async () => {
                console.log('Auto-refreshing data...');
                await refreshAllTabsData();
            }, 30000); // 30 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
            
            console.log('Auto-refresh started (every 30 seconds)');
        }
        
        function stopAutoRefresh() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
                console.log('Auto-refresh stopped');
            }
        }
        
        // Delete officer permanently (Admin only)
        async function deleteOfficerPermanently(officerId) {
            if (userRole !== 'admin') {
                alert('‡πÄ‡∏â‡∏û‡∏≤‡∏∞ Admin ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏ö‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡∏ñ‡∏≤‡∏ß‡∏£‡πÑ‡∏î‡πâ');
                return;
            }
            
            const officer = officers.find(o => o.id === officerId);
            if (!officer) {
                alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö');
                return;
            }
            
            // ‡∏ñ‡∏≤‡∏°‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö
            const reason = prompt('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏ó‡πà‡∏≤‡∏ô‡∏ô‡∏µ‡πâ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡∏ñ‡∏≤‡∏ß‡∏£:');
            if (!reason || reason.trim() === '') {
                alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö');
                return;
            }
            
            if (confirm(`‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö ${officer.name} ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡∏ñ‡∏≤‡∏ß‡∏£‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?\n\n‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•: ${reason.trim()}\n\n‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏î‡πâ`)) {
                try {
                    // ‡∏•‡∏ö‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å array ‡∏ñ‡∏≤‡∏ß‡∏£
                    const index = officers.findIndex(o => o.id === officerId);
                    if (index > -1) {
                        officers.splice(index, 1);
                    }
                    
                    // ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏≠‡∏ö‡∏£‡∏°‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á
                    if (trainingData[officerId]) {
                        delete trainingData[officerId];
                    }
                    
                    // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡πÉ‡∏ô activity log
                    await logActivity('‡∏•‡∏ö‡∏ñ‡∏≤‡∏ß‡∏£', `‡∏•‡∏ö‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡∏ñ‡∏≤‡∏ß‡∏£: ${officer.name} (${officerId}) | ‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•: ${reason.trim()}`);
                    
                    // Save to Firebase
                    await firebase.database().ref('officers').set(officers);
                    await firebase.database().ref('trainingData').set(trainingData);
                    
                    // ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                    loadAllOfficersData();
                    setTimeout(async () => {
                        await refreshAllTabsData();
                    }, 1000);
                    
                    alert(`‡∏•‡∏ö‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡∏ñ‡∏≤‡∏ß‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß`);
                } catch (error) {
                    console.error('Error deleting officer permanently:', error);
                    alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà');
                }
            }
        }
        
        // Enhanced confirmation functions with Firebase sync
        async function confirmTeamDataEnhanced() {
            const userOrg = currentUser.orgId;
            
            if (confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡∏°‡πÅ‡∏•‡∏∞‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) {
                try {
                    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô
                    if (!confirmationStatus[userOrg]) {
                        confirmationStatus[userOrg] = { teamConfirmed: false, orgConfirmed: false };
                    }
                    
                    confirmationStatus[userOrg].teamConfirmed = true;
                    confirmationStatus[userOrg].orgConfirmed = true;
                    confirmationStatus[userOrg].confirmedAt = new Date().toISOString();
                    confirmationStatus[userOrg].confirmedBy = currentUser.username;
                    
                    // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á Firebase
                    await saveToFirebase('confirmationStatus', confirmationStatus);
                    
                    // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å activity log
                    await logActivity('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô', `‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡∏°‡πÅ‡∏•‡∏∞‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô ${userOrg}`);
                    
                    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï display ‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
                    updateConfirmationStatusDisplay();
                    
                    // ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î real-time
                    setTimeout(async () => {
                        await refreshAllTabsData();
                    }, 1000);
                    
                    console.log('Team data confirmed and saved to Firebase for org:', userOrg);
                    alert('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ‡∏ñ‡∏π‡∏Å‡∏™‡πà‡∏á‡πÉ‡∏´‡πâ‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡πâ‡∏ß');
                    
                } catch (error) {
                    console.error('Error confirming team data:', error);
                    alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á');
                }
            }
        }
        
        async function resetTeamConfirmationEnhanced(orgId) {
            if (confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡∏°‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) {
                try {
                    if (!confirmationStatus[orgId]) {
                        confirmationStatus[orgId] = { teamConfirmed: false, orgConfirmed: false };
                    }
                    
                    confirmationStatus[orgId].teamConfirmed = false;
                    confirmationStatus[orgId].resetAt = new Date().toISOString();
                    confirmationStatus[orgId].resetBy = currentUser.username;
                    
                    // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á Firebase
                    await saveToFirebase('confirmationStatus', confirmationStatus);
                    
                    await logActivity('‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï', `‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡∏° ${orgId}`);
                    
                    // ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• real-time
                    loadAllOfficersData();
                    setTimeout(async () => {
                        await refreshAllTabsData();
                    }, 1000);
                    
                    alert('‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
                } catch (error) {
                    console.error('Error resetting team confirmation:', error);
                    alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞');
                }
            }
        }
        
        async function resetOrgConfirmationEnhanced(orgId) {
            if (confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) {
                try {
                    if (!confirmationStatus[orgId]) {
                        confirmationStatus[orgId] = { teamConfirmed: false, orgConfirmed: false };
                    }
                    
                    confirmationStatus[orgId].orgConfirmed = false;
                    confirmationStatus[orgId].resetAt = new Date().toISOString();
                    confirmationStatus[orgId].resetBy = currentUser.username;
                    
                    // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á Firebase
                    await saveToFirebase('confirmationStatus', confirmationStatus);
                    
                    await logActivity('‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï', `‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô ${orgId}`);
                    
                    // ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• real-time
                    loadOrganizationsData();
                    setTimeout(async () => {
                        await refreshAllTabsData();
                    }, 1000);
                    
                    alert('‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
                } catch (error) {
                    console.error('Error resetting org confirmation:', error);
                    alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞');
                }
            }
        }
        
        // Import officers from Excel function
        function showImportOfficersModal() {
            const content = `
                <h3 class="text-lg font-bold text-dark-green mb-4">‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå Excel</h3>
                <div class="space-y-4">
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                        <div class="flex justify-between items-start mb-2">
                            <h4 class="font-medium text-blue-800">‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÑ‡∏ü‡∏•‡πå Excel ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£:</h4>
                            <button onclick="downloadExcelTemplate()" class="bg-blue-600 text-white px-3 py-1 rounded text-sm hover:bg-blue-700">‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î Template</button>
                        </div>
                        <ul class="text-sm text-blue-700 space-y-1">
                            <li>‚Ä¢ ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå A: ‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</li>
                            <li>‚Ä¢ ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå B: ‡∏£‡∏´‡∏±‡∏™‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á (‡πÄ‡∏ä‡πà‡∏ô POS001)</li>
                            <li>‚Ä¢ ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå C: ‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå</li>
                            <li>‚Ä¢ ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå D: ‡∏≠‡∏µ‡πÄ‡∏°‡∏•</li>
                            <li>‚Ä¢ ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå E: ‡∏£‡∏´‡∏±‡∏™‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô (‡πÄ‡∏ä‡πà‡∏ô ORG001)</li>
                            <li>‚Ä¢ ‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏ö‡∏ö SRRT0001, SRRT0002...</li>
                            <li>‚Ä¢ ‡πÅ‡∏ñ‡∏ß‡πÅ‡∏£‡∏Å‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á (‡∏à‡∏∞‡∏Ç‡πâ‡∏≤‡∏°‡πÑ‡∏õ)</li>
                        </ul>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå Excel</label>
                        <input type="file" id="excelFile" accept=".xlsx,.xls" onchange="previewImport()" class="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-medium-green">
                        <p class="text-sm text-gray-500 mt-1">‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå</p>
                    </div>
                    <div id="importPreview" class="hidden">
                        <h4 class="font-medium text-gray-800 mb-2">‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤:</h4>
                        <div class="max-h-60 overflow-y-auto border border-gray-200 rounded">
                            <table class="min-w-full text-sm">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-2 py-1 text-left">‡∏£‡∏´‡∏±‡∏™</th>
                                        <th class="px-2 py-1 text-left">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</th>
                                        <th class="px-2 py-1 text-left">‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</th>
                                        <th class="px-2 py-1 text-left">‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå</th>
                                        <th class="px-2 py-1 text-left">‡∏≠‡∏µ‡πÄ‡∏°‡∏•</th>
                                        <th class="px-2 py-1 text-left">‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô</th>
                                    </tr>
                                </thead>
                                <tbody id="previewTableBody">
                                </tbody>
                            </table>
                        </div>
                        <div class="mt-2 text-sm text-gray-600">
                            <span id="previewCount"></span>
                        </div>
                    </div>
                    <div id="importErrors" class="hidden bg-red-50 border border-red-200 rounded-lg p-4">
                        <h4 class="font-medium text-red-800 mb-2">‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏ó‡∏µ‡πà‡∏û‡∏ö:</h4>
                        <ul id="errorList" class="text-sm text-red-700 space-y-1">
                        </ul>
                    </div>
                </div>
                <div class="flex justify-end space-x-2 mt-6">
                    <button type="button" onclick="hideModal()" class="px-4 py-2 bg-gray-300 text-gray-700 rounded hover:bg-gray-400">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                    <button type="button" id="importOfficersBtn" onclick="importOfficers()" class="px-4 py-2 bg-gray-400 text-white rounded cursor-not-allowed" disabled>‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
                </div>
            `;
            showModal(content);
            
            // Add file change listener
            document.getElementById('excelFile').addEventListener('change', function(e) {
                const file = e.target.files[0];
                const previewBtn = document.getElementById('previewBtn');
                if (file) {
                    previewBtn.disabled = false;
                } else {
                    previewBtn.disabled = true;
                    document.getElementById('importBtn').disabled = true;
                    document.getElementById('importPreview').classList.add('hidden');
                    document.getElementById('importErrors').classList.add('hidden');
                }
            });
        }
        
        let importData = [];
        
        function previewImport() {
            console.log('Starting previewImport function');
            const fileInput = document.getElementById('excelFile');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå Excel');
                return;
            }
            
            console.log('File selected:', file.name, file.type, file.size);
            
            // Check if XLSX library is loaded
            if (typeof XLSX === 'undefined') {
                alert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏•‡∏ö‡∏£‡∏≤‡∏£‡∏µ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏≠‡πà‡∏≤‡∏ô Excel ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏´‡∏ô‡πâ‡∏≤');
                console.error('XLSX library not loaded');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                console.log('File read successfully');
                try {
                    const data = new Uint8Array(e.target.result);
                    console.log('Data length:', data.length);
                    
                    const workbook = XLSX.read(data, { type: 'array' });
                    console.log('Workbook sheets:', workbook.SheetNames);
                    
                    if (workbook.SheetNames.length === 0) {
                        alert('‡πÑ‡∏°‡πà‡∏û‡∏ö sheet ‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå Excel');
                        return;
                    }
                    
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                    console.log('Raw JSON data:', jsonData);
                    
                    // Skip header row and process data
                    const dataRows = jsonData.slice(1).filter(row => {
                        return row && row.length > 0 && row[0] != null && row[0] !== ''; // At least officer ID must exist
                    });
                    
                    console.log('Filtered data rows:', dataRows.length);
                    
                    if (dataRows.length === 0) {
                        alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå Excel ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÑ‡∏ü‡∏•‡πå');
                        return;
                    }
                    
                    importData = [];
                    const errors = [];
                    
                    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ arrays ‡∏ñ‡∏π‡∏Å‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏•‡πâ‡∏ß
                    if (!officers || !Array.isArray(officers)) {
                        alert('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡πÇ‡∏´‡∏•‡∏î ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà');
                        return;
                    }
                    if (!organizations || !Array.isArray(organizations)) {
                        alert('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡πÇ‡∏´‡∏•‡∏î ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà');
                        return;
                    }
                    if (!positions || !Array.isArray(positions)) {
                        alert('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡πÇ‡∏´‡∏•‡∏î ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà');
                        return;
                    }
                    
                    const existingIds = new Set(officers.filter(o => o && o.id).map(o => o.id));
                    const orgIds = new Set(organizations.filter(org => org && org.id).map(org => org.id));
                    const positionIds = new Set(positions.filter(pos => pos && pos.id).map(pos => pos.id));
                    
                    console.log('Existing officer IDs:', Array.from(existingIds));
                    console.log('Existing org IDs:', Array.from(orgIds));
                    console.log('Existing position IDs:', Array.from(positionIds));
                    
                    dataRows.forEach((row, index) => {
                        const rowNum = index + 2; // +2 because we skipped header and arrays are 0-indexed
                        console.log(`Processing row ${rowNum}:`, row);
                        
                        const [name, positionId, phone, email, orgId] = row;
                        
                        // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
                        const officerId = generateOfficerId();
                        
                        // Validation
                        const rowErrors = [];
                        
                        // Convert values to strings and handle empty cells
                        const cleanName = name ? String(name).trim() : '';
                        const cleanPositionId = positionId ? String(positionId).trim() : '';
                        const cleanPhone = phone ? String(phone).trim() : '';
                        const cleanEmail = email ? String(email).trim() : '';
                        const cleanOrgId = orgId ? String(orgId).trim() : '';
                        
                        if (!cleanName) {
                            rowErrors.push(`‡πÅ‡∏ñ‡∏ß ${rowNum}: ‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á`);
                        }
                        
                        if (!cleanPositionId) {
                            rowErrors.push(`‡πÅ‡∏ñ‡∏ß ${rowNum}: ‡∏£‡∏´‡∏±‡∏™‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á`);
                        } else {
                            const upperPositionId = cleanPositionId.toUpperCase();
                            if (!positionIds.has(upperPositionId)) {
                                rowErrors.push(`‡πÅ‡∏ñ‡∏ß ${rowNum}: ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á ${upperPositionId} ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö`);
                            }
                        }
                        
                        if (!cleanPhone) {
                            rowErrors.push(`‡πÅ‡∏ñ‡∏ß ${rowNum}: ‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á`);
                        }
                        
                        if (!cleanEmail || !cleanEmail.includes('@')) {
                            rowErrors.push(`‡πÅ‡∏ñ‡∏ß ${rowNum}: ‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á`);
                        }
                        
                        if (!cleanOrgId) {
                            rowErrors.push(`‡πÅ‡∏ñ‡∏ß ${rowNum}: ‡∏£‡∏´‡∏±‡∏™‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á`);
                        } else {
                            const upperOrgId = cleanOrgId.toUpperCase();
                            if (!orgIds.has(upperOrgId)) {
                                rowErrors.push(`‡πÅ‡∏ñ‡∏ß ${rowNum}: ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô ${upperOrgId} ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö`);
                            }
                        }
                        
                        if (rowErrors.length > 0) {
                            errors.push(...rowErrors);
                        } else {
                            // ‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô‡∏à‡∏≤‡∏Å‡∏£‡∏´‡∏±‡∏™
                            const selectedOrg = organizations.find(org => org.id === cleanOrgId.toUpperCase());
                            
                            importData.push({
                                id: officerId, // ‡πÉ‡∏ä‡πâ‡∏£‡∏´‡∏±‡∏™‡∏ó‡∏µ‡πà‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
                                name: cleanName,
                                position_id: cleanPositionId.toUpperCase(),
                                phone: cleanPhone,
                                email: cleanEmail,
                                orgId: cleanOrgId.toUpperCase(),
                                organization: selectedOrg ? selectedOrg.name : cleanOrgId.toUpperCase(),
                                createdAt: new Date().toISOString()
                            });
                        }
                    });
                    
                    console.log('Import data created:', importData.length, 'items');
                    console.log('Errors found:', errors.length);
                    
                    // Show preview
                    console.log('Showing preview for', importData.length, 'items');
                    const previewDiv = document.getElementById('importPreview');
                    const previewTableBody = document.getElementById('previewTableBody');
                    const previewCount = document.getElementById('previewCount');
                    
                    if (!previewDiv || !previewTableBody || !previewCount) {
                        console.error('Preview elements not found');
                        alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á');
                        return;
                    }
                    
                    previewTableBody.innerHTML = '';
                    importData.forEach((officer, index) => {
                        console.log(`Creating preview row ${index + 1}:`, officer);
                        const org = organizations.find(o => o && o.id === officer.orgId);
                        const position = positions.find(p => p && p.id === officer.position_id);
                        const row = document.createElement('tr');
                        row.className = 'border-b';
                        row.innerHTML = `
                            <td class="px-2 py-1">${officer.id}</td>
                            <td class="px-2 py-1">${officer.name}</td>
                            <td class="px-2 py-1">${position ? position.name : officer.position_id}</td>
                            <td class="px-2 py-1">${officer.phone}</td>
                            <td class="px-2 py-1">${officer.email}</td>
                            <td class="px-2 py-1">${org ? org.name : officer.orgId}</td>
                        `;
                        previewTableBody.appendChild(row);
                    });
                    
                    previewCount.textContent = `‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ${importData.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`;
                    console.log('Making preview visible');
                    previewDiv.classList.remove('hidden');
                    
                    // Show errors if any
                    const errorsDiv = document.getElementById('importErrors');
                    const errorList = document.getElementById('errorList');
                    
                    if (errors.length > 0) {
                        errorList.innerHTML = '';
                        errors.forEach(error => {
                            const li = document.createElement('li');
                            li.textContent = `‚Ä¢ ${error}`;
                            errorList.appendChild(li);
                        });
                        errorsDiv.classList.remove('hidden');
                    } else {
                        errorsDiv.classList.add('hidden');
                    }
                    
                    // Enable import button if there's valid data
                    const importBtn = document.getElementById('importOfficersBtn');
                    if (importBtn) {
                        if (importData.length > 0) {
                            importBtn.disabled = false;
                            importBtn.className = 'px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700';
                            importBtn.textContent = `‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (${importData.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)`;
                        } else {
                            importBtn.disabled = true;
                            importBtn.className = 'px-4 py-2 bg-gray-400 text-white rounded cursor-not-allowed';
                            importBtn.textContent = '‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•';
                        }
                    }
                    
                } catch (error) {
                    console.error('Error reading Excel file:', error);
                    alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå Excel: ' + error.message);
                }
            };
            
            reader.onerror = function(error) {
                console.error('FileReader error:', error);
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå');
            };
            
            reader.readAsArrayBuffer(file);
        }
        
        function downloadExcelTemplate() {
            try {
                // Create sample data for template
                const templateData = [
                    ['‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•', '‡∏£‡∏´‡∏±‡∏™‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á', '‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå', '‡∏≠‡∏µ‡πÄ‡∏°‡∏•', '‡∏£‡∏´‡∏±‡∏™‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô'],
                    ['‡∏ô‡∏≤‡∏¢‡∏™‡∏°‡∏ä‡∏≤‡∏¢ ‡πÉ‡∏à‡∏î‡∏µ', 'POS001', '081-234-5678', 'somchai@bma.go.th', 'ORG001'],
                    ['‡∏ô‡∏≤‡∏á‡∏™‡∏°‡πÉ‡∏™ ‡∏™‡∏∏‡∏Ç‡πÉ‡∏à', 'POS002', '082-345-6789', 'somsai@bma.go.th', 'ORG002'],
                    ['‡∏ô‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏±‡∏¢ ‡πÄ‡∏Å‡πà‡∏á‡∏î‡∏µ', 'POS001', '083-456-7890', 'wichai@bma.go.th', 'ORG001'],
                    ['', '', '', '', ''],
                    ['‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ (SRRT0001, SRRT0002, ...)'],
                ];
                
                // Add available positions as reference
                if (positions && Array.isArray(positions) && positions.length > 0) {
                    templateData.push([]);
                    templateData.push(['‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ó‡∏µ‡πà‡∏°‡∏µ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö:']);
                    positions.forEach(pos => {
                        if (pos && pos.id && pos.name) {
                            templateData.push([pos.id, pos.name]);
                        }
                    });
                }
                
                // Add available organizations as reference
                if (organizations && Array.isArray(organizations) && organizations.length > 0) {
                    templateData.push([]);
                    templateData.push(['‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏°‡∏µ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö:']);
                    organizations.forEach(org => {
                        if (org && org.id && org.name) {
                            templateData.push([org.id, org.name]);
                        }
                    });
                }
                
                // Create workbook and worksheet
                const workbook = XLSX.utils.book_new();
                const worksheet = XLSX.utils.aoa_to_sheet(templateData);
                
                // Style the header row
                const range = XLSX.utils.decode_range(worksheet['!ref']);
                for (let col = range.s.c; col <= range.e.c; col++) {
                    const cellAddress = XLSX.utils.encode_cell({ r: 0, c: col });
                    if (!worksheet[cellAddress]) continue;
                    worksheet[cellAddress].s = {
                        font: { bold: true },
                        fill: { fgColor: { rgb: "FFFFAA" } }
                    };
                }
                
                // Set column widths
                worksheet['!cols'] = [
                    { width: 25 }, // ‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•
                    { width: 15 }, // ‡∏£‡∏´‡∏±‡∏™‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á
                    { width: 15 }, // ‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå
                    { width: 30 }, // ‡∏≠‡∏µ‡πÄ‡∏°‡∏•
                    { width: 15 }  // ‡∏£‡∏´‡∏±‡∏™‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô
                ];
                
                XLSX.utils.book_append_sheet(workbook, worksheet, 'Officers Template');
                
                // Generate and download file
                const thaiYear = new Date().getFullYear() + 543;
                const filename = `SRRT_Officers_Template_${thaiYear}_` + new Date().toISOString().slice(5, 10).replace('-', '') + '.xlsx';
                XLSX.writeFile(workbook, filename);
                
                console.log('Template downloaded:', filename);
                
            } catch (error) {
                console.error('Error creating template:', error);
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á template');
            }
        }
        
        async function importOfficers() {
            if (importData.length === 0) {
                alert('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤');
                return;
            }
            
            if (!confirm(`‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà ${importData.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`)) {
                return;
            }
            
            const importBtn = document.getElementById('importOfficersBtn');
            
            try {
                // Update button state
                if (importBtn) {
                    importBtn.disabled = true;
                    importBtn.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤...';
                    importBtn.className = 'px-4 py-2 bg-gray-400 text-white rounded cursor-not-allowed';
                }
                
                let successCount = 0;
                let failCount = 0;
                
                for (const officer of importData) {
                    try {
                        // Add to local array
                        officers.push(officer);
                        
                        // Initialize training data for new officer
                        if (!trainingData[officer.id]) {
                            trainingData[officer.id] = {};
                        }
                        
                        // Initialize confirmation status for organization if needed
                        if (officer.orgId && !confirmationStatus[officer.orgId]) {
                            confirmationStatus[officer.orgId] = { teamConfirmed: false, orgConfirmed: false };
                        }
                        
                        successCount++;
                    } catch (error) {
                        console.error(`Error processing officer ${officer.id}:`, error);
                        failCount++;
                    }
                }
                
                // Save all data to Firebase in one batch
                try {
                    await saveToFirebase('officers', officers);
                    await saveToFirebase('trainingData', trainingData);
                    await saveToFirebase('confirmationStatus', confirmationStatus);
                    
                    await logActivity('‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤', `‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏à‡∏≤‡∏Å Excel: ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ${successCount} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£${failCount > 0 ? `, ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ${failCount} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£` : ''}`);
                } catch (firebaseError) {
                    console.error('Error saving to Firebase:', firebaseError);
                    throw firebaseError;
                }
                
                // ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ß‡πâ
                importData = [];
                resetOfficerIdGenerator(); // Reset generator ‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å import ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
                
                hideModal();
                
                // ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                loadAllOfficersData(); // Refresh officers data
                refreshAllTabsData(); // Refresh all tabs
                
                // Show success message
                if (failCount === 0) {
                    alert(`‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ ${successCount} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`);
                } else {
                    alert(`‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ${successCount} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ${failCount} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`);
                }
                
            } catch (error) {
                console.error('Error importing officers:', error);
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: ' + (error.message || '‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏'));
            } finally {
                // Reset button state
                if (importBtn) {
                    importBtn.disabled = false;
                    importBtn.textContent = '‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•';
                    importBtn.className = 'px-4 py-2 bg-medium-green text-white rounded hover:bg-dark-green';
                }
            }
        }
        
        function showAddOfficerModal() {
            const content = `
                <h3 class="text-lg font-bold text-dark-green mb-4">‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡πÉ‡∏´‡∏°‡πà</h3>
                <form id="addOfficerForm">
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà</label>
                            <div class="px-3 py-2 border border-gray-300 rounded bg-gray-50">
                                <span class="text-gray-600 text-sm">‡∏£‡∏´‡∏±‡∏™‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥: </span>
                                <span class="font-semibold text-blue-600" id="nextOfficerId">${generateOfficerId()}</span>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</label>
                            <input type="text" id="officerName" class="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-medium-green" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</label>
                            <select id="officerPositionId" class="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-medium-green" required>
                                <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå</label>
                            <input type="tel" id="officerPhone" placeholder="081-234-5678" class="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-medium-green" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">‡∏≠‡∏µ‡πÄ‡∏°‡∏•</label>
                            <input type="email" id="officerEmail" placeholder="example@bma.go.th" class="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-medium-green" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô</label>
                            <select id="officerOrgId" class="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-medium-green" required>
                                <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô</option>
                            </select>
                        </div>
                    </div>
                    <div class="flex justify-end space-x-2 mt-6">
                        <button type="button" onclick="hideModal()" class="px-4 py-2 bg-gray-300 text-gray-700 rounded hover:bg-gray-400">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                        <button type="submit" class="px-4 py-2 bg-medium-green text-white rounded hover:bg-dark-green">‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà</button>
                    </div>
                </form>
            `;
            showModal(content);
            
            // Populate position dropdown
            const positionSelect = document.getElementById('officerPositionId');
            if (positions && Array.isArray(positions)) {
                positions.forEach(pos => {
                    if (pos && pos.id && pos.name) {
                        const option = document.createElement('option');
                        option.value = pos.id;
                        option.textContent = pos.name;
                        positionSelect.appendChild(option);
                    }
                });
            }
            
            // Populate organization dropdown using centralized function
            populateOrganizationDropdowns();
            
            // Add form submit handler
            document.getElementById('addOfficerForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                await addNewOfficer();
            });
        }
        
        async function addNewOfficer() {
            try {
                // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
                const officerId = generateOfficerId();
                const name = document.getElementById('officerName').value.trim();
                const positionId = document.getElementById('officerPositionId').value;
                const phone = document.getElementById('officerPhone').value.trim();
                const email = document.getElementById('officerEmail').value.trim();
                const orgId = document.getElementById('officerOrgId').value;
                
                // Validation
                if (!name || !positionId || !phone || !email || !orgId) {
                    alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô');
                    return;
                }
                
                // ‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô‡∏à‡∏≤‡∏Å‡∏£‡∏´‡∏±‡∏™
                const selectedOrg = organizations.find(org => org.id === orgId);
                
                const newOfficer = {
                    id: officerId,
                    name: name,
                    position_id: positionId,
                    phone: phone,
                    email: email,
                    orgId: orgId,
                    organization: selectedOrg.name,
                    createdAt: new Date().toISOString()
                };
                
                // Add to local array
                officers.push(newOfficer);
                
                // Save to Firebase
                const officerRef = window.firebasePush(window.firebaseRef(window.firebaseDatabase, 'officers'));
                await window.firebaseSet(officerRef, newOfficer);
                
                // Initialize training data for new officer
                if (!trainingData[officerId]) {
                    trainingData[officerId] = {};
                    await saveToFirebase('trainingData', trainingData);
                }
                
                // Initialize confirmation status for new organization if needed
                if (!confirmationStatus[orgId]) {
                    confirmationStatus[orgId] = { teamConfirmed: false, orgConfirmed: false };
                    await saveToFirebase('confirmationStatus', confirmationStatus);
                }
                
                await logActivity('‡πÄ‡∏û‡∏¥‡πà‡∏°', `‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡πÉ‡∏´‡∏°‡πà: ${name} (${officerId})`);
                
                resetOfficerIdGenerator(); // Reset generator ‡∏´‡∏•‡∏±‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
                hideModal();
                loadAllOfficersData(); // Refresh officers data
                alert('‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
                
            } catch (error) {
                console.error('Error adding officer:', error);
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà');
            }
        }
        // Import organizations from Excel function
        function showImportOrganizationsModal() {
            const content = `
                <h3 class="text-lg font-bold text-dark-green mb-4">‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå Excel</h3>
                <div class="space-y-4">
                    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                        <div class="flex justify-between items-start mb-2">
                            <h4 class="font-medium text-yellow-800">‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÑ‡∏ü‡∏•‡πå Excel ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£:</h4>
                            <button onclick="downloadOrganizationTemplate()" class="bg-yellow-600 text-white px-3 py-1 rounded text-sm hover:bg-yellow-700">‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î Template</button>
                        </div>
                        <ul class="text-sm text-yellow-700 space-y-1">
                            <li>‚Ä¢ ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå A: ‡∏£‡∏´‡∏±‡∏™‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô (‡πÄ‡∏ä‡πà‡∏ô ORG001)</li>
                            <li>‚Ä¢ ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå B: ‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô</li>
                            <li>‚Ä¢ ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå C: ‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå</li>
                            <li>‚Ä¢ ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå D: ‡πÇ‡∏ó‡∏£‡∏™‡∏≤‡∏£</li>
                            <li>‚Ä¢ ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå E: ‡∏≠‡∏µ‡πÄ‡∏°‡∏•</li>
                            <li>‚Ä¢ ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå F: ‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà</li>
                            <li>‚Ä¢ ‡πÅ‡∏ñ‡∏ß‡πÅ‡∏£‡∏Å‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á (‡∏à‡∏∞‡∏Ç‡πâ‡∏≤‡∏°‡πÑ‡∏õ)</li>
                        </ul>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå Excel</label>
                        <input type="file" id="orgExcelFile" accept=".xlsx,.xls" class="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-medium-green">
                    </div>
                    <div id="orgImportPreview" class="hidden">
                        <h4 class="font-medium text-gray-800 mb-2">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤:</h4>
                        <div class="max-h-60 overflow-y-auto border border-gray-200 rounded">
                            <table class="min-w-full text-sm">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-2 py-1 text-left">‡∏£‡∏´‡∏±‡∏™</th>
                                        <th class="px-2 py-1 text-left">‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô</th>
                                        <th class="px-2 py-1 text-left">‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå</th>
                                        <th class="px-2 py-1 text-left">‡πÇ‡∏ó‡∏£‡∏™‡∏≤‡∏£</th>
                                        <th class="px-2 py-1 text-left">‡∏≠‡∏µ‡πÄ‡∏°‡∏•</th>
                                        <th class="px-2 py-1 text-left">‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà</th>
                                    </tr>
                                </thead>
                                <tbody id="orgPreviewTableBody">
                                </tbody>
                            </table>
                        </div>
                        <div class="mt-2 text-sm text-gray-600">
                            <span id="orgPreviewCount"></span>
                        </div>
                    </div>
                    <div id="orgImportErrors" class="hidden bg-red-50 border border-red-200 rounded-lg p-4">
                        <h4 class="font-medium text-red-800 mb-2">‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏ó‡∏µ‡πà‡∏û‡∏ö:</h4>
                        <ul id="orgErrorList" class="text-sm text-red-700 space-y-1">
                        </ul>
                    </div>
                </div>
                <div class="flex justify-end space-x-2 mt-6">
                    <button type="button" onclick="hideModal()" class="px-4 py-2 bg-gray-300 text-gray-700 rounded hover:bg-gray-400">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                    <button type="button" id="orgImportBtn" onclick="importOrganizations()" class="px-4 py-2 bg-medium-green text-white rounded hover:bg-dark-green" disabled>‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
                </div>
            `;
            showModal(content);
            
            // Add file change listener
            document.getElementById('orgExcelFile').addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå
                    previewOrganizationImport();
                } else {
                    document.getElementById('orgImportBtn').disabled = true;
                    document.getElementById('orgImportPreview').classList.add('hidden');
                    document.getElementById('orgImportErrors').classList.add('hidden');
                }
            });
        }
        
        let orgImportData = [];
        
        function downloadOrganizationTemplate() {
            try {
                // Create sample data for template
                const templateData = [
                    ['‡∏£‡∏´‡∏±‡∏™‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô', '‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô', '‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå', '‡πÇ‡∏ó‡∏£‡∏™‡∏≤‡∏£', '‡∏≠‡∏µ‡πÄ‡∏°‡∏•', '‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà'],
                    ['ORG001', '‡∏™‡∏≥‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏™‡∏≤‡∏ò‡∏≤‡∏£‡∏ì‡∏™‡∏∏‡∏Ç ‡πÄ‡∏Ç‡∏ï‡∏à‡∏ï‡∏∏‡∏à‡∏±‡∏Å‡∏£', '02-123-4567', '02-123-4568', 'health1@bma.go.th', '123 ‡∏ñ.‡∏£‡∏≤‡∏ä‡∏ß‡∏¥‡∏ñ‡∏µ ‡πÄ‡∏Ç‡∏ï‡∏à‡∏ï‡∏∏‡∏à‡∏±‡∏Å‡∏£'],
                    ['ORG002', '‡∏™‡∏≥‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏™‡∏≤‡∏ò‡∏≤‡∏£‡∏ì‡∏™‡∏∏‡∏Ç ‡πÄ‡∏Ç‡∏ï‡∏î‡∏¥‡∏ô‡πÅ‡∏î‡∏á', '02-234-5678', '02-234-5679', 'health2@bma.go.th', '456 ‡∏ñ.‡∏î‡∏¥‡∏ô‡πÅ‡∏î‡∏á ‡πÄ‡∏Ç‡∏ï‡∏î‡∏¥‡∏ô‡πÅ‡∏î‡∏á'],
                    ['ORG003', '‡∏™‡∏≥‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏™‡∏≤‡∏ò‡∏≤‡∏£‡∏ì‡∏™‡∏∏‡∏Ç ‡πÄ‡∏Ç‡∏ï‡∏ö‡∏≤‡∏á‡∏Å‡∏∞‡∏õ‡∏¥', '02-345-6789', '02-345-6790', 'health3@bma.go.th', '789 ‡∏ñ.‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏£‡∏≤‡∏©‡∏é‡∏£‡πå ‡πÄ‡∏Ç‡∏ï‡∏ö‡∏≤‡∏á‡∏Å‡∏∞‡∏õ‡∏¥']
                ];
                
                // Create workbook and worksheet
                const workbook = XLSX.utils.book_new();
                const worksheet = XLSX.utils.aoa_to_sheet(templateData);
                
                // Style the header row
                const range = XLSX.utils.decode_range(worksheet['!ref']);
                for (let col = range.s.c; col <= range.e.c; col++) {
                    const cellAddress = XLSX.utils.encode_cell({ r: 0, c: col });
                    if (!worksheet[cellAddress]) continue;
                    worksheet[cellAddress].s = {
                        font: { bold: true },
                        fill: { fgColor: { rgb: "FFFFAA" } }
                    };
                }
                
                // Set column widths
                worksheet['!cols'] = [
                    { width: 12 }, // ‡∏£‡∏´‡∏±‡∏™‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô
                    { width: 35 }, // ‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô
                    { width: 15 }, // ‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå
                    { width: 15 }, // ‡πÇ‡∏ó‡∏£‡∏™‡∏≤‡∏£
                    { width: 25 }, // ‡∏≠‡∏µ‡πÄ‡∏°‡∏•
                    { width: 40 }  // ‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà
                ];
                
                XLSX.utils.book_append_sheet(workbook, worksheet, 'Organizations Template');
                
                // Generate and download file
                const thaiYear = new Date().getFullYear() + 543;
                const filename = `SRRT_Organizations_Template_${thaiYear}_` + new Date().toISOString().slice(5, 10).replace('-', '') + '.xlsx';
                XLSX.writeFile(workbook, filename);
                
                console.log('Organization template downloaded:', filename);
                
            } catch (error) {
                console.error('Error creating organization template:', error);
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á template');
            }
        }
        
        function previewOrganizationImport() {
            console.log('Starting previewOrganizationImport function');
            const fileInput = document.getElementById('orgExcelFile');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå Excel');
                return;
            }
            
            console.log('Organization file selected:', file.name, file.type, file.size);
            
            // Check if XLSX library is loaded
            if (typeof XLSX === 'undefined') {
                alert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏•‡∏ö‡∏£‡∏≤‡∏£‡∏µ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏≠‡πà‡∏≤‡∏ô Excel ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏´‡∏ô‡πâ‡∏≤');
                console.error('XLSX library not loaded');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                console.log('Organization file read successfully');
                try {
                    const data = new Uint8Array(e.target.result);
                    console.log('Data length:', data.length);
                    
                    const workbook = XLSX.read(data, { type: 'array' });
                    console.log('Workbook sheets:', workbook.SheetNames);
                    
                    if (workbook.SheetNames.length === 0) {
                        alert('‡πÑ‡∏°‡πà‡∏û‡∏ö sheet ‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå Excel');
                        return;
                    }
                    
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                    console.log('Raw JSON data:', jsonData);
                    
                    // Skip header row and process data
                    const dataRows = jsonData.slice(1).filter(row => {
                        return row && row.length > 0 && row[0] != null && row[0] !== ''; // At least org ID must exist
                    });
                    
                    console.log('Filtered organization data rows:', dataRows.length);
                    
                    if (dataRows.length === 0) {
                        alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå Excel ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÑ‡∏ü‡∏•‡πå');
                        return;
                    }
                    
                    orgImportData = [];
                    const errors = [];
                    const existingOrgIds = new Set(organizations.map(o => o.id));
                    
                    console.log('Existing organization IDs:', Array.from(existingOrgIds));
                    
                    dataRows.forEach((row, index) => {
                        const rowNum = index + 2; // +2 because we skipped header and arrays are 0-indexed
                        console.log(`Processing organization row ${rowNum}:`, row);
                        
                        const [orgId, name, phone, fax, email, address] = row;
                        
                        // Validation
                        const rowErrors = [];
                        
                        // Convert values to strings and handle empty cells
                        const cleanOrgId = orgId ? String(orgId).trim() : '';
                        const cleanName = name ? String(name).trim() : '';
                        const cleanPhone = phone ? String(phone).trim() : '';
                        const cleanFax = fax ? String(fax).trim() : '';
                        const cleanEmail = email ? String(email).trim() : '';
                        const cleanAddress = address ? String(address).trim() : '';
                        
                        if (!cleanOrgId) {
                            rowErrors.push(`‡πÅ‡∏ñ‡∏ß ${rowNum}: ‡∏£‡∏´‡∏±‡∏™‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á`);
                        } else {
                            const upperOrgId = cleanOrgId.toUpperCase();
                            if (existingOrgIds.has(upperOrgId)) {
                                rowErrors.push(`‡πÅ‡∏ñ‡∏ß ${rowNum}: ‡∏£‡∏´‡∏±‡∏™‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô ${upperOrgId} ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö`);
                            }
                        }
                        
                        if (!cleanName) {
                            rowErrors.push(`‡πÅ‡∏ñ‡∏ß ${rowNum}: ‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á`);
                        }
                        
                        if (cleanEmail && !cleanEmail.includes('@')) {
                            rowErrors.push(`‡πÅ‡∏ñ‡∏ß ${rowNum}: ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á`);
                        }
                        
                        if (rowErrors.length > 0) {
                            errors.push(...rowErrors);
                        } else {
                            orgImportData.push({
                                id: cleanOrgId.toUpperCase(),
                                name: cleanName,
                                phone: cleanPhone,
                                fax: cleanFax,
                                email: cleanEmail,
                                address: cleanAddress,
                                createdAt: new Date().toISOString()
                            });
                        }
                    });
                    
                    console.log('Organization import data created:', orgImportData.length, 'items');
                    console.log('Errors found:', errors.length);
                    
                    // Show preview
                    console.log('Showing organization preview for', orgImportData.length, 'items');
                    const previewDiv = document.getElementById('orgImportPreview');
                    const previewTableBody = document.getElementById('orgPreviewTableBody');
                    const previewCount = document.getElementById('orgPreviewCount');
                    
                    if (!previewDiv || !previewTableBody || !previewCount) {
                        console.error('Organization preview elements not found');
                        alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á');
                        return;
                    }
                    
                    previewTableBody.innerHTML = '';
                    orgImportData.forEach((org, index) => {
                        console.log(`Creating organization preview row ${index + 1}:`, org);
                        const row = document.createElement('tr');
                        row.className = 'border-b';
                        row.innerHTML = `
                            <td class="px-2 py-1">${org.id}</td>
                            <td class="px-2 py-1">${org.name}</td>
                            <td class="px-2 py-1">${org.phone}</td>
                            <td class="px-2 py-1">${org.fax}</td>
                            <td class="px-2 py-1">${org.email}</td>
                            <td class="px-2 py-1">${org.address}</td>
                        `;
                        previewTableBody.appendChild(row);
                    });
                    
                    previewCount.textContent = `‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ${orgImportData.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`;
                    console.log('Making organization preview visible');
                    previewDiv.classList.remove('hidden');
                    
                    // Show errors if any
                    const errorsDiv = document.getElementById('orgImportErrors');
                    const errorList = document.getElementById('orgErrorList');
                    
                    if (errors.length > 0) {
                        errorList.innerHTML = '';
                        errors.forEach(error => {
                            const li = document.createElement('li');
                            li.textContent = `‚Ä¢ ${error}`;
                            errorList.appendChild(li);
                        });
                        errorsDiv.classList.remove('hidden');
                    } else {
                        errorsDiv.classList.add('hidden');
                    }
                    
                    // Enable import button if there's valid data
                    document.getElementById('orgImportBtn').disabled = orgImportData.length === 0;
                    
                } catch (error) {
                    console.error('Error reading organization Excel file:', error);
                    alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå Excel: ' + error.message);
                }
            };
            
            reader.onerror = function(error) {
                console.error('FileReader error:', error);
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå');
            };
            
            reader.readAsArrayBuffer(file);
        }
        
        async function importOrganizations() {
            if (orgImportData.length === 0) {
                alert('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤');
                return;
            }
            
            if (!confirm(`‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô ${orgImportData.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`)) {
                return;
            }
            
            const importBtn = document.getElementById('orgImportBtn');
            
            try {
                // Update button state
                if (importBtn) {
                    importBtn.disabled = true;
                    importBtn.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤...';
                    importBtn.className = 'px-4 py-2 bg-gray-400 text-white rounded cursor-not-allowed';
                }
                
                let successCount = 0;
                let failCount = 0;
                
                for (const org of orgImportData) {
                    try {
                        // Add to local array
                        organizations.push(org);
                        
                        // Initialize confirmation status for new organization
                        if (!confirmationStatus[org.id]) {
                            confirmationStatus[org.id] = { teamConfirmed: false, orgConfirmed: false };
                        }
                        
                        successCount++;
                    } catch (error) {
                        console.error(`Error processing organization ${org.id}:`, error);
                        failCount++;
                    }
                }
                
                // Save all data to Firebase in one batch
                try {
                    await saveToFirebase('organizations', organizations);
                    await saveToFirebase('confirmationStatus', confirmationStatus);
                    
                    await logActivity('‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤', `‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô‡∏à‡∏≤‡∏Å Excel: ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ${successCount} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£${failCount > 0 ? `, ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ${failCount} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£` : ''}`);
                } catch (firebaseError) {
                    console.error('Error saving to Firebase:', firebaseError);
                    throw firebaseError;
                }
                
                // ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ß‡πâ
                orgImportData = [];
                
                hideModal();
                
                // ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                loadOrganizationsData(); // Refresh organizations data
                refreshAllTabsData(); // Refresh all tabs
                
                // Show success message
                if (failCount === 0) {
                    alert(`‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ ${successCount} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`);
                } else {
                    alert(`‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ${successCount} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ${failCount} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`);
                }
                
            } catch (error) {
                console.error('Error importing organizations:', error);
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: ' + (error.message || '‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏'));
            } finally {
                // Reset button state
                if (importBtn) {
                    importBtn.disabled = false;
                    importBtn.textContent = '‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•';
                    importBtn.className = 'px-4 py-2 bg-medium-green text-white rounded hover:bg-dark-green';
                }
            }
        }
        
        // Other placeholder functions (to be implemented later)
        // Training Years Management Functions
        function showAddYearModal() {
            const content = `
                <h3 class="text-lg font-bold text-dark-green mb-4">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏õ‡∏µ‡∏Å‡∏≤‡∏£‡∏≠‡∏ö‡∏£‡∏°‡πÉ‡∏´‡∏°‡πà</h3>
                <form id="addYearForm">
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">‡∏õ‡∏µ ‡∏û.‡∏®.</label>
                            <input type="number" id="yearInput" min="2500" max="2600" placeholder="‡πÄ‡∏ä‡πà‡∏ô 2568" class="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-medium-green" required>
                            <p class="text-sm text-gray-500 mt-1">‡∏õ‡∏µ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß: ${trainingYears.join(', ')}</p>
                        </div>
                    </div>
                    <div class="flex justify-end space-x-2 mt-6">
                        <button type="button" onclick="hideModal()" class="px-4 py-2 bg-gray-300 text-gray-700 rounded hover:bg-gray-400">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                        <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏õ‡∏µ</button>
                    </div>
                </form>
            `;
            showModal(content);
            
            document.getElementById('addYearForm').addEventListener('submit', function(e) {
                e.preventDefault();
                addTrainingYear();
            });
        }
        
        function showDeleteYearModal() {
            if (trainingYears.length <= 1) {
                alert('‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏õ‡∏µ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏õ‡∏µ');
                return;
            }
            
            const yearOptions = trainingYears.map(year => 
                `<option value="${year}">${year}</option>`
            ).join('');
            
            const content = `
                <h3 class="text-lg font-bold text-dark-green mb-4">‡∏•‡∏ö‡∏õ‡∏µ‡∏Å‡∏≤‡∏£‡∏≠‡∏ö‡∏£‡∏°</h3>
                <div class="space-y-4">
                    <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                        <p class="text-red-800 text-sm">
                            <strong>‚ö†Ô∏è ‡∏Ñ‡∏≥‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô:</strong> ‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏õ‡∏µ‡∏à‡∏∞‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏≠‡∏ö‡∏£‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Ç‡∏≠‡∏á‡∏õ‡∏µ‡∏ô‡∏µ‡πâ‡∏´‡∏≤‡∏¢‡πÑ‡∏õ
                        </p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏µ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö</label>
                        <select id="deleteYearSelect" class="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-medium-green">
                            ${yearOptions}
                        </select>
                    </div>
                </div>
                <div class="flex justify-end space-x-2 mt-6">
                    <button type="button" onclick="hideModal()" class="px-4 py-2 bg-gray-300 text-gray-700 rounded hover:bg-gray-400">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                    <button type="button" onclick="deleteTrainingYear()" class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700">‡∏•‡∏ö‡∏õ‡∏µ</button>
                </div>
            `;
            showModal(content);
        }
        
        async function addTrainingYear() {
            const yearInput = document.getElementById('yearInput');
            const year = yearInput.value.trim();
            
            if (!year) {
                alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏õ‡∏µ');
                return;
            }
            
            if (trainingYears.includes(year)) {
                alert('‡∏õ‡∏µ‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö');
                return;
            }
            
            try {
                // Add year to local array
                trainingYears.push(year);
                trainingYears.sort(); // Sort years
                
                // Save to Firebase
                await saveToFirebase('trainingYears', trainingYears);
                await logActivity('‡πÄ‡∏û‡∏¥‡πà‡∏°', `‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏õ‡∏µ‡∏Å‡∏≤‡∏£‡∏≠‡∏ö‡∏£‡∏°: ${year}`);
                
                hideModal();
                loadTrainingData(); // Refresh the table
                alert(`‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏õ‡∏µ ${year} ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß`);
                
            } catch (error) {
                console.error('Error adding training year:', error);
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏õ‡∏µ');
            }
        }
        
        async function deleteTrainingYear() {
            const yearSelect = document.getElementById('deleteYearSelect');
            const year = yearSelect.value;
            
            if (!year) {
                alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏µ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö');
                return;
            }
            
            if (!confirm(`‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏õ‡∏µ ${year} ‡πÅ‡∏•‡∏∞‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏≠‡∏ö‡∏£‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Ç‡∏≠‡∏á‡∏õ‡∏µ‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?\n\n‚ö†Ô∏è ‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏î‡πâ`)) {
                return;
            }
            
            try {
                // Remove year from local array
                trainingYears = trainingYears.filter(y => y !== year);
                
                // Remove training data for this year from all officers
                Object.keys(trainingData).forEach(officerId => {
                    if (trainingData[officerId] && trainingData[officerId][year]) {
                        delete trainingData[officerId][year];
                    }
                });
                
                // Save to Firebase
                await saveToFirebase('trainingYears', trainingYears);
                await saveToFirebase('trainingData', trainingData);
                await logActivity('‡∏•‡∏ö', `‡∏•‡∏ö‡∏õ‡∏µ‡∏Å‡∏≤‡∏£‡∏≠‡∏ö‡∏£‡∏°: ${year} ‡πÅ‡∏•‡∏∞‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏≠‡∏ö‡∏£‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Ç‡∏≠‡∏á‡∏õ‡∏µ‡∏ô‡∏µ‡πâ`);
                
                hideModal();
                loadTrainingData(); // Refresh the table
                alert(`‡∏•‡∏ö‡∏õ‡∏µ ${year} ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß`);
                
            } catch (error) {
                console.error('Error deleting training year:', error);
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏õ‡∏µ');
            }
        }
        
        // Training Data Import Functions
        function showImportTrainingModal() {
            const content = `
                <h3 class="text-lg font-bold text-dark-green mb-4">‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏≠‡∏ö‡∏£‡∏°‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå Excel</h3>
                
                <div class="mb-4 p-4 bg-blue-50 border border-blue-200 rounded">
                    <h4 class="font-semibold text-blue-800 mb-2">‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÑ‡∏ü‡∏•‡πå Excel ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£:</h4>
                    <ul class="text-sm text-blue-700 list-disc list-inside space-y-1">
                        <li>‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå A: ‡∏õ‡∏µ ‡∏û.‡∏®. (‡πÄ‡∏ä‡πà‡∏ô 2567)</li>
                        <li>‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå B: ‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà (‡πÄ‡∏ä‡πà‡∏ô EMP001)</li>
                        <li>‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå C: ‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£‡∏ó‡∏µ‡πà‡∏≠‡∏ö‡∏£‡∏°</li>
                    </ul>
                    <p class="text-sm text-blue-600 mt-2">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ‡πÅ‡∏ñ‡∏ß‡πÅ‡∏£‡∏Å‡∏Ñ‡∏ß‡∏£‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á</p>
                </div>
                
                <div class="mb-4">
                    <div class="flex justify-between items-center mb-2">
                        <label class="block text-sm font-medium text-gray-700">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå Excel</label>
                        <button type="button" onclick="downloadTrainingTemplate()" class="text-sm bg-green-600 text-white px-3 py-1 rounded hover:bg-green-700">
                            <i class="fas fa-download mr-1"></i>‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î Template
                        </button>
                    </div>
                    <input type="file" id="trainingExcelFile" accept=".xlsx,.xls" onchange="previewTrainingData()"
                           class="w-full border border-gray-300 rounded px-3 py-2">
                </div>
                
                <div id="dataPreview" class="mb-4 hidden">
                    <h4 class="font-semibold text-gray-800 mb-2">‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤:</h4>
                    <div class="max-h-64 overflow-y-auto border border-gray-300 rounded">
                        <table class="w-full text-sm">
                            <thead class="bg-gray-50 sticky top-0">
                                <tr>
                                    <th class="px-3 py-2 text-left border-b">‡∏õ‡∏µ ‡∏û.‡∏®.</th>
                                    <th class="px-3 py-2 text-left border-b">‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà</th>
                                    <th class="px-3 py-2 text-left border-b">‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£‡∏ó‡∏µ‡πà‡∏≠‡∏ö‡∏£‡∏°</th>
                                    <th class="px-3 py-2 text-left border-b">‡∏ä‡∏∑‡πà‡∏≠‡∏ï‡∏≤‡∏°‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á</th>
                                    <th class="px-3 py-2 text-center border-b">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                                </tr>
                            </thead>
                            <tbody id="previewTableBody">
                            </tbody>
                        </table>
                    </div>
                    <div class="mt-2 p-3 bg-blue-50 border border-blue-200 rounded">
                        <p id="previewSummary" class="text-sm text-blue-700"></p>
                    </div>
                </div>
                
                <div id="importProgress" class="mb-4 hidden">
                    <div class="bg-gray-200 rounded-full h-2">
                        <div id="importProgressBar" class="bg-blue-600 h-2 rounded-full" style="width: 0%"></div>
                    </div>
                    <p id="importStatus" class="text-sm text-gray-600 mt-1">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...</p>
                </div>
                
                <div class="flex justify-end space-x-2">
                    <button type="button" onclick="hideModal()" class="px-4 py-2 bg-gray-300 text-gray-700 rounded hover:bg-gray-400">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                    <button type="button" onclick="importTrainingData()" id="importBtn" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700" disabled>‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
                </div>
            `;
            showModal(content);
        }
        
        async function previewTrainingData() {
            const fileInput = document.getElementById('trainingExcelFile');
            const dataPreview = document.getElementById('dataPreview');
            const previewTableBody = document.getElementById('previewTableBody');
            const previewSummary = document.getElementById('previewSummary');
            const importBtn = document.getElementById('importBtn');
            
            if (!fileInput.files.length) {
                dataPreview.classList.add('hidden');
                importBtn.disabled = true;
                return;
            }
            
            const file = fileInput.files[0];
            
            try {
                // Read Excel file
                const data = await file.arrayBuffer();
                const workbook = XLSX.read(data, { type: 'array' });
                const sheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[sheetName];
                const jsonData = XLSX.utils.sheet_to_json(worksheet, { 
                    header: ['year', 'officerId', 'course', 'officialName'],
                    range: 1 // Skip header row
                });
                
                let validCount = 0;
                let invalidCount = 0;
                const errors = [];
                const duplicateCheck = new Set();
                const missingOfficers = new Set();
                
                // Create preview table rows
                const previewRows = jsonData.slice(0, 20).map((row, index) => {
                    const actualRowNum = index + 2; // +2 because we skip header and arrays are 0-indexed
                    
                    // Validate data
                    let status = '';
                    let statusClass = '';
                    let isValid = true;
                    
                    if (!row.year || !row.officerId || !row.course) {
                        status = '‚ùå ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö';
                        statusClass = 'text-red-600';
                        isValid = false;
                        invalidCount++;
                        errors.push(`‡πÅ‡∏ñ‡∏ß ${actualRowNum}: ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô`);
                    } else {
                        const year = row.year.toString();
                        const officerId = row.officerId.toString().trim();
                        const course = row.course.toString().trim();
                        const officialName = row.officialName ? row.officialName.toString().trim() : '';
                        
                        // Check if officer exists in system
                        const officerExists = officers.find(officer => officer.id === officerId);
                        
                        if (!officerExists) {
                            status = '‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà';
                            statusClass = 'text-red-600';
                            invalidCount++;
                            missingOfficers.add(officerId);
                            errors.push(`‡πÅ‡∏ñ‡∏ß ${actualRowNum}: ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà "${officerId}" ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö`);
                        } else {
                            const duplicateKey = `${year}-${officerId}-${course}`;
                            
                            if (duplicateCheck.has(duplicateKey)) {
                                status = '‚ö†Ô∏è ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ã‡πâ‡∏≥';
                                statusClass = 'text-orange-600';
                                invalidCount++;
                                errors.push(`‡πÅ‡∏ñ‡∏ß ${actualRowNum}: ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ã‡πâ‡∏≥‡∏Å‡∏±‡∏ô (${year}-${officerId}-${course})`);
                            } else {
                                duplicateCheck.add(duplicateKey);
                                status = '‚úÖ ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á';
                                statusClass = 'text-green-600';
                                validCount++;
                            }
                        }
                    }
                    
                    return `
                        <tr class="border-b hover:bg-gray-50">
                            <td class="px-3 py-2">${row.year || '-'}</td>
                            <td class="px-3 py-2">${row.officerId || '-'}</td>
                            <td class="px-3 py-2">${row.course || '-'}</td>
                            <td class="px-3 py-2">${row.officialName || '-'}</td>
                            <td class="px-3 py-2 text-center ${statusClass}">${status}</td>
                        </tr>
                    `;
                }).join('');
                
                // Check remaining rows for validation summary
                for (let i = 20; i < jsonData.length; i++) {
                    const row = jsonData[i];
                    const actualRowNum = i + 2;
                    
                    if (!row.year || !row.officerId || !row.course) {
                        invalidCount++;
                        errors.push(`‡πÅ‡∏ñ‡∏ß ${actualRowNum}: ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô`);
                    } else {
                        const year = row.year.toString();
                        const officerId = row.officerId.toString().trim();
                        const course = row.course.toString().trim();
                        
                        // Check if officer exists in system
                        const officerExists = officers.find(officer => officer.id === officerId);
                        
                        if (!officerExists) {
                            invalidCount++;
                            missingOfficers.add(officerId);
                            errors.push(`‡πÅ‡∏ñ‡∏ß ${actualRowNum}: ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà "${officerId}" ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö`);
                        } else {
                            const duplicateKey = `${year}-${officerId}-${course}`;
                            
                            if (duplicateCheck.has(duplicateKey)) {
                                invalidCount++;
                                errors.push(`‡πÅ‡∏ñ‡∏ß ${actualRowNum}: ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ã‡πâ‡∏≥‡∏Å‡∏±‡∏ô (${year}-${officerId}-${course})`);
                            } else {
                                duplicateCheck.add(duplicateKey);
                                validCount++;
                            }
                        }
                    }
                }
                
                // Show preview
                previewTableBody.innerHTML = previewRows;
                
                if (jsonData.length > 20) {
                    previewTableBody.innerHTML += `
                        <tr class="bg-gray-100">
                            <td colspan="4" class="px-3 py-2 text-center text-gray-600 italic">
                                ... ‡πÅ‡∏•‡∏∞‡∏≠‡∏µ‡∏Å ${jsonData.length - 20} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
                            </td>
                        </tr>
                    `;
                }
                
                // Show summary
                const totalCount = jsonData.length;
                let summaryText = `‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ${totalCount} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ | `;
                summaryText += `‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ${validCount} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`;
                if (invalidCount > 0) {
                    summaryText += ` | ‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤ ${invalidCount} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`;
                }
                if (missingOfficers.size > 0) {
                    summaryText += ` | ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà: ${Array.from(missingOfficers).join(', ')}`;
                }
                
                previewSummary.textContent = summaryText;
                
                // Show preview section
                dataPreview.classList.remove('hidden');
                
                // Enable import button only if there are valid records
                importBtn.disabled = validCount === 0;
                if (validCount === 0) {
                    importBtn.textContent = '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏î‡πâ (‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á)';
                    importBtn.className = 'px-4 py-2 bg-gray-400 text-white rounded cursor-not-allowed';
                } else {
                    importBtn.textContent = `‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (${validCount} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)`;
                    importBtn.className = 'px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700';
                }
                
            } catch (error) {
                console.error('Error previewing data:', error);
                previewTableBody.innerHTML = `
                    <tr>
                        <td colspan="4" class="px-3 py-2 text-center text-red-600">
                            ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå: ${error.message}
                        </td>
                    </tr>
                `;
                previewSummary.textContent = '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏î‡πâ';
                dataPreview.classList.remove('hidden');
                importBtn.disabled = true;
            }
        }
        
        async function importTrainingData() {
            const fileInput = document.getElementById('trainingExcelFile');
            const importBtn = document.getElementById('importBtn');
            const importProgress = document.getElementById('importProgress');
            const importProgressBar = document.getElementById('importProgressBar');
            const importStatus = document.getElementById('importStatus');
            
            if (!fileInput.files.length) {
                alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå Excel');
                return;
            }
            
            const file = fileInput.files[0];
            
            // Show progress
            importProgress.classList.remove('hidden');
            importBtn.disabled = true;
            importBtn.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...';
            
            try {
                // Read Excel file
                const data = await file.arrayBuffer();
                const workbook = XLSX.read(data, { type: 'array' });
                const sheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[sheetName];
                const jsonData = XLSX.utils.sheet_to_json(worksheet, { 
                    header: ['year', 'officerId', 'course', 'officialName'],
                    range: 1 // Skip header row
                });
                
                importStatus.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...';
                importProgressBar.style.width = '25%';
                
                let processedCount = 0;
                let errorCount = 0;
                const errors = [];
                
                // Process each row
                for (let i = 0; i < jsonData.length; i++) {
                    const row = jsonData[i];
                    const progress = Math.round(((i + 1) / jsonData.length) * 75) + 25;
                    importProgressBar.style.width = progress + '%';
                    importStatus.textContent = `‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏• ${i + 1} ‡∏à‡∏≤‡∏Å ${jsonData.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£...`;
                    
                    // Validate data
                    if (!row.year || !row.officerId || !row.course) {
                        errors.push(`‡πÅ‡∏ñ‡∏ß ${i + 2}: ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô`);
                        errorCount++;
                        continue;
                    }
                    
                    const year = row.year.toString();
                    const officerId = row.officerId.toString().trim();
                    const officialName = row.officialName ? row.officialName.toString().trim() : '';
                    const course = row.course.toString().trim();
                    
                    // Check if officer exists in system
                    const officerExists = officers.find(officer => officer.id === officerId);
                    if (!officerExists) {
                        errors.push(`‡πÅ‡∏ñ‡∏ß ${i + 2}: ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà "${officerId}" ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö`);
                        errorCount++;
                        continue;
                    }
                    
                    // Add year if not exists
                    if (!trainingYears.includes(year)) {
                        trainingYears.push(year);
                        trainingYears.sort();
                    }
                    
                    // Initialize training data structure if not exists
                    if (!trainingData[officerId]) {
                        trainingData[officerId] = {};
                    }
                    if (!trainingData[officerId][year]) {
                        trainingData[officerId][year] = [];
                    }
                    
                    // Add course if not already exists
                    const existingCourse = trainingData[officerId][year].find(c => 
                        (typeof c === 'object' ? c.course : c) === course
                    );
                    
                    if (!existingCourse) {
                        const currentTimestamp = new Date().toISOString();
                        const officer = officers.find(o => o.id === officerId);
                        
                        trainingData[officerId][year].push({
                            course: course,
                            timestamp: currentTimestamp,
                            officerNameAtTime: officer ? officer.name : '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•',
                            officialName: officialName || (officer ? officer.name : ''),
                            updatedBy: currentUser.username,
                            importedFrom: 'Excel'
                        });
                        processedCount++;
                    }
                    
                    // Small delay to show progress
                    if (i % 10 === 0) {
                        await new Promise(resolve => setTimeout(resolve, 10));
                    }
                }
                
                importStatus.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...';
                importProgressBar.style.width = '90%';
                
                // Save to Firebase
                console.log('Saving training years to Firebase:', trainingYears);
                console.log('Saving training data to Firebase:', Object.keys(trainingData).length, 'officers');
                
                await saveToFirebase('trainingYears', trainingYears);
                await saveToFirebase('trainingData', trainingData);
                await logActivity('‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤', `‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏≠‡∏ö‡∏£‡∏°: ‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏• ${processedCount} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£, ‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î ${errorCount} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`);
                
                importProgressBar.style.width = '100%';
                importStatus.textContent = '‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô!';
                
                setTimeout(async () => {
                    try {
                        hideModal();
                        
                        // Reload data from Firebase to ensure consistency
                        console.log('Reloading data from Firebase after import...');
                        await loadDataFromFirebase();
                        
                        console.log('After reload - Training years:', trainingYears);
                        console.log('After reload - Training data keys:', Object.keys(trainingData));
                        
                        // Refresh the table
                        loadTrainingData();
                        
                        console.log('Training data loaded and displayed');
                    } catch (error) {
                        console.error('Error during post-import refresh:', error);
                    }
                    
                    // Create detailed summary message
                    let message = `‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß!\n\n‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${processedCount} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`;
                    
                    if (errorCount > 0) {
                        message += `\n‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${errorCount} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`;
                        
                        // Group errors by type
                        const missingOfficerErrors = errors.filter(err => err.includes('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà'));
                        const incompleteDataErrors = errors.filter(err => err.includes('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô'));
                        const duplicateErrors = errors.filter(err => err.includes('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ã‡πâ‡∏≥‡∏Å‡∏±‡∏ô'));
                        
                        if (missingOfficerErrors.length > 0) {
                            const missingIds = [...new Set(missingOfficerErrors.map(err => {
                                const match = err.match(/"([^"]+)"/);
                                return match ? match[1] : '';
                            }).filter(Boolean))];
                            message += `\n\n‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö (${missingOfficerErrors.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£):`;
                            message += `\n${missingIds.join(', ')}`;
                        }
                        
                        if (incompleteDataErrors.length > 0) {
                            message += `\n\n‚ùå ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô: ${incompleteDataErrors.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`;
                        }
                        
                        if (duplicateErrors.length > 0) {
                            message += `\n\nüîÑ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ã‡πâ‡∏≥‡∏Å‡∏±‡∏ô: ${duplicateErrors.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`;
                        }
                        
                        if (errors.length > 10) {
                            message += `\n\n‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°‡πÉ‡∏ô Console (F12)`;
                            console.log('‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î:', errors);
                        }
                    }
                    
                    alert(message);
                }, 1000);
                
            } catch (error) {
                console.error('Error importing training data:', error);
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: ' + error.message);
            } finally {
                // Reset button state
                importBtn.disabled = false;
                importBtn.textContent = '‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•';
                importBtn.className = 'px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700';
            }
        }
        
        function downloadTrainingTemplate() {
            try {
                // Create sample data for template
                const templateData = [
                    ['‡∏õ‡∏µ ‡∏û.‡∏®.', '‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà', '‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£‡∏ó‡∏µ‡πà‡∏≠‡∏ö‡∏£‡∏°', '‡∏ä‡∏∑‡πà‡∏≠‡∏ï‡∏≤‡∏°‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á'],
                    ['2567', 'EMP001', '‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£‡∏Å‡∏≤‡∏£‡∏õ‡∏ê‡∏°‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô', '‡∏ô‡∏≤‡∏¢‡∏™‡∏°‡∏ä‡∏≤‡∏¢ ‡πÉ‡∏à‡∏î‡∏µ'],
                    ['2567', 'EMP001', '‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡πÅ‡∏û‡∏ó‡∏¢‡πå', '‡∏ô‡∏≤‡∏¢‡∏™‡∏°‡∏ä‡∏≤‡∏¢ ‡πÉ‡∏à‡∏î‡∏µ'],
                    ['2567', 'EMP002', '‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á', '‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß‡∏õ‡∏£‡∏∞‡πÄ‡∏™‡∏£‡∏¥‡∏ê ‡∏®‡∏£‡∏µ‡∏™‡∏∏‡∏Ç'],
                    ['2568', 'EMP001', '‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£‡∏Å‡∏≤‡∏£‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏ß‡∏¥‡∏Å‡∏§‡∏ï', '‡∏ô‡∏≤‡∏¢‡∏™‡∏°‡∏ä‡∏≤‡∏¢ ‡πÉ‡∏à‡∏î‡∏µ'],
                    ['2568', 'EMP003', '‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£‡∏Å‡∏≤‡∏£‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏Å‡∏≤‡∏£‡∏ï‡∏¥‡∏î‡πÄ‡∏ä‡∏∑‡πâ‡∏≠', '‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß‡∏à‡∏¥‡∏ï‡∏ï‡∏£‡∏≤ ‡∏™‡∏ß‡∏¢‡∏á‡∏≤‡∏°'],
                    ['', '', '', ''],
                    ['‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏:', '', '', ''],
                    ['1. ‡πÅ‡∏ñ‡∏ß‡πÅ‡∏£‡∏Å‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á ‡∏≠‡∏¢‡πà‡∏≤‡∏•‡∏ö‡∏´‡∏£‡∏∑‡∏≠‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç', '', '', ''],
                    ['2. ‡∏õ‡∏µ ‡∏û.‡∏®. ‡πÉ‡∏™‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç ‡πÄ‡∏ä‡πà‡∏ô 2567, 2568', '', '', ''],
                    ['3. ‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏ó‡∏µ‡πà‡∏°‡∏µ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö', '', '', ''],
                    ['4. ‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÉ‡∏™‡πà‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÑ‡∏î‡πâ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏≠‡∏¥‡∏™‡∏£‡∏∞', '', '', ''],
                    ['5. ‡∏ä‡∏∑‡πà‡∏≠‡∏ï‡∏≤‡∏°‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á ‡∏´‡∏≤‡∏Å‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏à‡∏∞‡πÉ‡∏ä‡πâ‡∏ä‡∏∑‡πà‡∏≠‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô', '', '', ''],
                    ['6. ‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà 1 ‡∏Ñ‡∏ô‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡∏ö‡∏£‡∏°‡∏´‡∏•‡∏≤‡∏¢‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£‡πÑ‡∏î‡πâ', '', '', ''],
                    ['7. ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡∏ö‡∏£‡∏°‡∏Ç‡πâ‡∏≤‡∏°‡∏õ‡∏µ‡πÑ‡∏î‡πâ', '', '', '']
                ];
                
                // Create workbook and worksheet
                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.aoa_to_sheet(templateData);
                
                // Set column widths
                ws['!cols'] = [
                    { wch: 12 }, // ‡∏õ‡∏µ ‡∏û.‡∏®.
                    { wch: 20 }, // ‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà
                    { wch: 40 }, // ‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£‡∏ó‡∏µ‡πà‡∏≠‡∏ö‡∏£‡∏°
                    { wch: 25 }  // ‡∏ä‡∏∑‡πà‡∏≠‡∏ï‡∏≤‡∏°‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á
                ];
                
                // Style header row
                const headerStyle = {
                    font: { bold: true, color: { rgb: "FFFFFF" } },
                    fill: { fgColor: { rgb: "4472C4" } },
                    alignment: { horizontal: "center" }
                };
                
                // Apply header style
                ['A1', 'B1', 'C1'].forEach(cell => {
                    if (!ws[cell]) ws[cell] = {};
                    ws[cell].s = headerStyle;
                });
                
                // Style example rows
                const exampleStyle = {
                    fill: { fgColor: { rgb: "E7F3FF" } }
                };
                
                // Apply example style to rows 2-6
                for (let row = 2; row <= 6; row++) {
                    ['A', 'B', 'C'].forEach(col => {
                        const cell = col + row;
                        if (!ws[cell]) ws[cell] = {};
                        ws[cell].s = exampleStyle;
                    });
                }
                
                // Style note section
                const noteStyle = {
                    font: { color: { rgb: "666666" }, italic: true },
                    fill: { fgColor: { rgb: "F8F9FA" } }
                };
                
                // Apply note style to rows 8-14
                for (let row = 8; row <= 14; row++) {
                    ['A', 'B', 'C'].forEach(col => {
                        const cell = col + row;
                        if (!ws[cell]) ws[cell] = {};
                        ws[cell].s = noteStyle;
                    });
                }
                
                // Add worksheet to workbook
                XLSX.utils.book_append_sheet(wb, ws, '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏≠‡∏ö‡∏£‡∏°');
                
                // Generate filename with current date
                const now = new Date();
                const thaiYear = now.getFullYear() + 543;
                const month = String(now.getMonth() + 1).padStart(2, '0');
                const day = String(now.getDate()).padStart(2, '0');
                const filename = `Template_‡∏Å‡∏≤‡∏£‡∏≠‡∏ö‡∏£‡∏°_${thaiYear}${month}${day}.xlsx`;
                
                // Download file
                XLSX.writeFile(wb, filename);
                
                // Show success message
                alert('‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î Template ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß!\n\n‡πÑ‡∏ü‡∏•‡πå: ' + filename + '\n\n‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏ä‡πâ‡πÑ‡∏ü‡∏•‡πå‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏°‡πà‡πÅ‡∏ö‡∏ö‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•');
                
            } catch (error) {
                console.error('Error creating template:', error);
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á Template: ' + error.message);
            }
        }

        // Handle organization transfer with popup notification
        async function handleOrganizationTransfer(officer, oldOrg, newOrg) {
            try {
                // ‡∏™‡∏£‡πâ‡∏≤‡∏á transfer notification
                const transferNotification = {
                    id: Date.now().toString(),
                    officerId: officer.id,
                    officerName: officer.name,
                    fromOrgId: oldOrg ? oldOrg.id : null,
                    fromOrgName: oldOrg ? oldOrg.name : '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏',
                    toOrgId: newOrg.id,
                    toOrgName: newOrg.name,
                    timestamp: new Date().toISOString(),
                    status: 'pending' // pending, accepted, rejected
                };

                // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å notification ‡πÑ‡∏õ‡∏¢‡∏±‡∏á Firebase
                let transferNotifications = {};
                try {
                    const notificationsSnap = await window.firebaseGet(window.firebaseRef(window.firebaseDatabase, 'transferNotifications'));
                    if (notificationsSnap.val()) {
                        transferNotifications = notificationsSnap.val();
                    }
                } catch (error) {
                    console.log('Creating new transfer notifications collection');
                }

                transferNotifications[transferNotification.id] = transferNotification;
                await window.firebaseSet(window.firebaseRef(window.firebaseDatabase, 'transferNotifications'), transferNotifications);

                console.log('Transfer notification created:', transferNotification);

                // ‡∏ñ‡πâ‡∏≤‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏ô‡∏Ç‡∏≠‡∏á‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á ‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á popup ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
                if (currentUser.orgId === newOrg.id) {
                    await showTransferConfirmationPopup(transferNotification);
                }

            } catch (error) {
                console.error('Error handling organization transfer:', error);
            }
        }

        // Show transfer confirmation popup
        async function showTransferConfirmationPopup(transferNotification) {
            const modalContent = `
                <div class="max-w-md mx-auto bg-white rounded-xl shadow-lg overflow-hidden">
                    <div class="bg-gradient-to-r from-blue-500 to-blue-600 px-6 py-4">
                        <h3 class="text-xl font-bold text-white text-center">‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏Å‡∏≤‡∏£‡∏¢‡πâ‡∏≤‡∏¢‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà</h3>
                    </div>
                    <div class="p-6">
                        <div class="text-center mb-4">
                            <div class="mx-auto w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mb-3">
                                <svg class="w-8 h-8 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                                </svg>
                            </div>
                            <h2 class="text-2xl font-bold text-gray-800 mb-2">${transferNotification.officerName}</h2>
                            <p class="text-gray-600">‡∏ñ‡∏π‡∏Å‡∏¢‡πâ‡∏≤‡∏¢‡∏à‡∏≤‡∏Å <span class="font-semibold text-blue-600">${transferNotification.fromOrgName}</span></p>
                            <p class="text-gray-600">‡∏°‡∏≤‡∏¢‡∏±‡∏á <span class="font-semibold text-green-600">‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏ó‡πà‡∏≤‡∏ô</span></p>
                        </div>
                        <hr class="my-4">
                        <p class="text-center text-gray-700 mb-6">
                            ‡∏ó‡πà‡∏≤‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏Ñ‡∏ô‡∏î‡∏±‡∏á‡∏Å‡∏•‡πà‡∏≤‡∏ß<br>
                            ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡πÉ‡∏ô‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏ó‡πà‡∏≤‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?
                        </p>
                        <div class="flex space-x-3">
                            <button id="acceptTransfer" class="flex-1 bg-green-500 hover:bg-green-600 text-white font-semibold py-3 px-4 rounded-lg transition duration-200">
                                ‚úì ‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô
                            </button>
                            <button id="rejectTransfer" class="flex-1 bg-red-500 hover:bg-red-600 text-white font-semibold py-3 px-4 rounded-lg transition duration-200">
                                ‚úó ‡πÑ‡∏°‡πà‡∏£‡∏±‡∏ö
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            showModal(modalContent);
            
            // Handle accept button
            document.getElementById('acceptTransfer').addEventListener('click', async () => {
                await processTransferDecision(transferNotification, true);
                hideModal();
            });
            
            // Handle reject button  
            document.getElementById('rejectTransfer').addEventListener('click', async () => {
                await processTransferDecision(transferNotification, false);
                hideModal();
            });
        }
        
        // Process transfer decision
        async function processTransferDecision(transferNotification, accepted) {

            try {
                // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ notification
                const transferNotifications = {};
                const notificationsSnap = await window.firebaseGet(window.firebaseRef(window.firebaseDatabase, 'transferNotifications'));
                if (notificationsSnap.val()) {
                    Object.assign(transferNotifications, notificationsSnap.val());
                }

                if (accepted) {
                    // ‡∏¢‡∏≠‡∏°‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏¢‡πâ‡∏≤‡∏¢ - ‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà
                    transferNotifications[transferNotification.id].status = 'accepted';
                    
                    // ‡∏•‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ SRRT ‡∏Ç‡∏≠‡∏á‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏¢‡πâ‡∏≤‡∏¢ (‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á)
                    const officer = officers.find(o => o.id === transferNotification.officerId);
                    if (officer) {
                        officer.isSRRTMember = false;
                        await saveToFirebase('officers', officers);
                    }
                    
                    await logActivity('‡∏¢‡∏≠‡∏°‡∏£‡∏±‡∏ö', `‡∏¢‡∏≠‡∏°‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏¢‡πâ‡∏≤‡∏¢‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà ${transferNotification.officerName} ‡∏à‡∏≤‡∏Å ${transferNotification.fromOrgName} ‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤‡∏¢‡∏±‡∏á‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô`);
                    
                    // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÅ‡∏ö‡∏ö‡∏™‡∏ß‡∏¢
                    const successModal = `
                        <div class="max-w-sm mx-auto bg-white rounded-xl shadow-lg overflow-hidden">
                            <div class="bg-green-500 px-6 py-4">
                                <h3 class="text-lg font-bold text-white text-center">‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!</h3>
                            </div>
                            <div class="p-6 text-center">
                                <div class="mx-auto w-12 h-12 bg-green-100 rounded-full flex items-center justify-center mb-4">
                                    <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                    </svg>
                                </div>
                                <p class="text-gray-700">‡∏¢‡∏≠‡∏°‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏¢‡πâ‡∏≤‡∏¢ <span class="font-bold">${transferNotification.officerName}</span><br>‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤‡∏¢‡∏±‡∏á‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß</p>
                            </div>
                        </div>
                    `;
                    showModal(successModal);
                    setTimeout(hideModal, 2000);
                } else {
                    // ‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò‡∏Å‡∏≤‡∏£‡∏¢‡πâ‡∏≤‡∏¢ - ‡∏¢‡πâ‡∏≤‡∏¢‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡πÑ‡∏õ‡πÄ‡∏õ‡πá‡∏ô "‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏"
                    transferNotifications[transferNotification.id].status = 'rejected';
                    
                    // ‡∏´‡∏≤‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡πÅ‡∏•‡∏∞‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô‡πÄ‡∏õ‡πá‡∏ô "‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏"
                    const officer = officers.find(o => o.id === transferNotification.officerId);
                    if (officer) {
                        officer.orgId = null;
                        officer.organization = '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
                        officer.isSRRTMember = false;
                        await saveToFirebase('officers', officers);
                    }
                    
                    await logActivity('‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò', `‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò‡∏Å‡∏≤‡∏£‡∏¢‡πâ‡∏≤‡∏¢‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà ${transferNotification.officerName} - ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏õ‡πá‡∏ô "‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠`);
                    
                    // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÅ‡∏ö‡∏ö‡∏™‡∏ß‡∏¢
                    const rejectModal = `
                        <div class="max-w-sm mx-auto bg-white rounded-xl shadow-lg overflow-hidden">
                            <div class="bg-red-500 px-6 py-4">
                                <h3 class="text-lg font-bold text-white text-center">‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò‡∏Å‡∏≤‡∏£‡∏¢‡πâ‡∏≤‡∏¢</h3>
                            </div>
                            <div class="p-6 text-center">
                                <div class="mx-auto w-12 h-12 bg-red-100 rounded-full flex items-center justify-center mb-4">
                                    <svg class="w-6 h-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                    </svg>
                                </div>
                                <p class="text-gray-700">‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò‡∏Å‡∏≤‡∏£‡∏¢‡πâ‡∏≤‡∏¢ <span class="font-bold">${transferNotification.officerName}</span><br>‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏õ‡πá‡∏ô "‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏"<br>‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠</p>
                            </div>
                        </div>
                    `;
                    showModal(rejectModal);
                    setTimeout(hideModal, 3000);
                }

                // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ notification
                await window.firebaseSet(window.firebaseRef(window.firebaseDatabase, 'transferNotifications'), transferNotifications);

                // ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                await loadDataFromFirebase();
                loadTeamData();
                if (document.getElementById('allOfficersTableBody')) {
                    loadAllOfficersData();
                }

            } catch (error) {
                console.error('Error processing transfer confirmation:', error);
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏¢‡πâ‡∏≤‡∏¢');
            }
        }

        // Check for pending transfer notifications on page load
        async function checkPendingTransferNotifications() {
            try {
                const notificationsSnap = await window.firebaseGet(window.firebaseRef(window.firebaseDatabase, 'transferNotifications'));
                if (notificationsSnap.val()) {
                    const notifications = notificationsSnap.val();
                    const pendingNotifications = Object.values(notifications).filter(n => 
                        n.status === 'pending' && n.toOrgId === currentUser.orgId
                    );

                    // ‡πÅ‡∏™‡∏î‡∏á popup ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£
                    for (const notification of pendingNotifications) {
                        await showTransferConfirmationPopup(notification);
                    }
                }
            } catch (error) {
                console.error('Error checking pending transfer notifications:', error);
            }
        }

        // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•
        async function recordNameChange(officerId, oldName, newName) {
            try {
                // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ä‡∏∑‡πà‡∏≠
                if (!nameHistory[officerId]) {
                    nameHistory[officerId] = [];
                }
                
                const nameChangeRecord = {
                    oldName: oldName,
                    newName: newName,
                    timestamp: new Date().toISOString(),
                    changedBy: currentUser.username
                };
                
                nameHistory[officerId].push(nameChangeRecord);
                
                // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á Firebase
                await window.firebaseSet(window.firebaseRef(window.firebaseDatabase, 'nameHistory'), nameHistory);
                
                console.log('üìù Name change recorded:', nameChangeRecord);
                
                await logActivity('‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ä‡∏∑‡πà‡∏≠', `‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏• ${officerId} ‡∏à‡∏≤‡∏Å "${oldName}" ‡πÄ‡∏õ‡πá‡∏ô "${newName}"`);
                
            } catch (error) {
                console.error('Error recording name change:', error);
            }
        }
        
        // ‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà ‡∏ì ‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏≠‡∏ö‡∏£‡∏°
        function getOfficerNameAtTime(officerId, timestamp) {
            const currentOfficer = officers.find(o => o.id === officerId);
            if (!currentOfficer) return '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•';
            
            const history = nameHistory[officerId];
            if (!history || history.length === 0) {
                return currentOfficer.name; // ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ä‡∏∑‡πà‡∏≠
            }
            
            // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡∏ï‡∏≤‡∏°‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà
            const sortedHistory = [...history].sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
            
            // ‡∏´‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡∏∂‡πâ‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡∏´‡∏•‡∏±‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏≠‡∏ö‡∏£‡∏°
            const trainingTime = new Date(timestamp);
            
            let nameAtTime = currentOfficer.name;
            
            // ‡∏î‡∏π‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏à‡∏≤‡∏Å‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡πÑ‡∏õ‡πÄ‡∏Å‡πà‡∏≤‡∏™‡∏∏‡∏î ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ ‡∏ì ‡πÄ‡∏ß‡∏•‡∏≤‡∏ô‡∏±‡πâ‡∏ô
            for (let i = sortedHistory.length - 1; i >= 0; i--) {
                const change = sortedHistory[i];
                if (new Date(change.timestamp) <= trainingTime) {
                    // ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏µ‡πâ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡∏∂‡πâ‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡πÉ‡∏ô‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏≠‡∏ö‡∏£‡∏°
                    nameAtTime = change.newName;
                    break;
                } else {
                    // ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏µ‡πâ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡∏∂‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏≠‡∏ö‡∏£‡∏°
                    nameAtTime = change.oldName;
                }
            }
            
            return nameAtTime;
        }
        
        // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏≠‡∏ö‡∏£‡∏°
        function formatTrainingWithNameHistory(trainingRecord, officerId) {
            const currentOfficer = officers.find(o => o.id === officerId);
            if (!currentOfficer) return trainingRecord;
            
            const nameAtTrainingTime = getOfficerNameAtTime(officerId, trainingRecord.timestamp || new Date().toISOString());
            
            // ‡∏ñ‡πâ‡∏≤‡∏ä‡∏∑‡πà‡∏≠ ‡∏ì ‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏≠‡∏ö‡∏£‡∏°‡πÑ‡∏°‡πà‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô ‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Å‡πà‡∏≤‡∏î‡πâ‡∏ß‡∏¢
            if (nameAtTrainingTime !== currentOfficer.name) {
                return `${trainingRecord.course} (${nameAtTrainingTime} ‡∏Å‡πà‡∏≠‡∏ô‡∏à‡∏∞‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏ö‡∏ö‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô)`;
            }
            
            return trainingRecord.course;
        }

        // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°‡∏Ç‡∏≠‡∏á‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà
        function showOfficerDetailsModal(officerId) {
            const officer = officers.find(o => o.id === officerId);
            if (!officer) {
                alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà');
                return;
            }
            
            const org = organizations.find(o => o.id === officer.orgId || o.name === officer.organization);
            const position = positions.find(p => p.id === officer.position_id);
            
            document.getElementById('officerDetailsModal').innerHTML = `
                <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-semibold">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà</h3>
                            <button onclick="closeOfficerDetailsModal()" class="text-gray-500 hover:text-gray-700">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                        </div>
                        <div class="space-y-3">
                            <div><strong>‡∏£‡∏´‡∏±‡∏™:</strong> ${officer.id}</div>
                            <div><strong>‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•:</strong> ${officer.name}</div>
                            <div><strong>‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á:</strong> ${position ? position.name : '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}</div>
                            <div><strong>‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô:</strong> ${org ? org.name : '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}</div>
                            <div><strong>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå:</strong> ${officer.phone || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}</div>
                            <div><strong>‡∏≠‡∏µ‡πÄ‡∏°‡∏•:</strong> ${officer.email || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}</div>
                        </div>
                        <div class="mt-6 flex justify-end">
                            <button onclick="closeOfficerDetailsModal()" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">‡∏õ‡∏¥‡∏î</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('officerDetailsModal').classList.remove('hidden');
        }
        
        // ‡∏õ‡∏¥‡∏î‡πÇ‡∏°‡∏î‡∏≠‡∏•‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà
        function closeOfficerDetailsModal() {
            document.getElementById('officerDetailsModal').classList.add('hidden');
            document.getElementById('officerDetailsModal').innerHTML = '';
        }

        // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°‡∏Ç‡∏≠‡∏á‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà
        function showOfficerDetailsModal(officerId) {
            const officer = officers.find(o => o.id === officerId);
            if (!officer) {
                alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà');
                return;
            }
            
            const org = organizations.find(o => o.id === officer.orgId || o.name === officer.organization);
            const position = positions.find(p => p.id === officer.position_id);
            
            document.getElementById('officerDetailsModal').innerHTML = `
                <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-semibold">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà</h3>
                            <button onclick="closeOfficerDetailsModal()" class="text-gray-500 hover:text-gray-700">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                        </div>
                        <div class="space-y-3">
                            <div><strong>‡∏£‡∏´‡∏±‡∏™:</strong> ${officer.id}</div>
                            <div><strong>‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•:</strong> ${officer.name}</div>
                            <div><strong>‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á:</strong> ${position ? position.name : '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}</div>
                            <div><strong>‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô:</strong> ${org ? org.name : '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}</div>
                            <div><strong>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå:</strong> ${officer.phone || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}</div>
                            <div><strong>‡∏≠‡∏µ‡πÄ‡∏°‡∏•:</strong> ${officer.email || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}</div>
                        </div>
                        <div class="mt-6 flex justify-end">
                            <button onclick="closeOfficerDetailsModal()" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">‡∏õ‡∏¥‡∏î</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('officerDetailsModal').classList.remove('hidden');
        }
        
        // ‡∏õ‡∏¥‡∏î‡πÇ‡∏°‡∏î‡∏≠‡∏•‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà
        function closeOfficerDetailsModal() {
            document.getElementById('officerDetailsModal').classList.add('hidden');
            document.getElementById('officerDetailsModal').innerHTML = '';
        }

        // ‡πÅ‡∏™‡∏î‡∏á‡∏õ‡πá‡∏≠‡∏õ‡∏≠‡∏±‡∏û‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ä‡∏∑‡πà‡∏≠
        function showNameHistoryModal(officerId) {
            const officer = officers.find(o => o.id === officerId);
            const history = nameHistory[officerId] || [];
            
            if (!officer) {
                alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà');
                return;
            }
            
            if (history.length === 0) {
                alert('‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏ó‡πà‡∏≤‡∏ô‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•');
                return;
            }
            
            // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏à‡∏≤‡∏Å‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏õ‡πÄ‡∏Å‡πà‡∏≤
            const sortedHistory = [...history].sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            
            const historyRows = sortedHistory.map((record, index) => {
                const changeDate = new Date(record.timestamp);
                const formattedDate = changeDate.toLocaleString('th-TH', {
                    year: 'numeric',
                    month: 'long', 
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                return `
                    <tr class="border-b hover:bg-gray-50">
                        <td class="px-4 py-3 text-center">${index + 1}</td>
                        <td class="px-4 py-3">${record.oldName}</td>
                        <td class="px-4 py-3">${record.newName}</td>
                        <td class="px-4 py-3 text-center">${formattedDate}</td>
                        <td class="px-4 py-3 text-center">${record.changedBy}</td>
                    </tr>
                `;
            }).join('');
            
            const content = `
                <div class="max-w-4xl mx-auto">
                    <h3 class="text-xl font-bold text-dark-green mb-4 flex items-center">
                        <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                        ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•
                    </h3>
                    
                    <div class="mb-4 p-4 bg-blue-50 rounded-lg border border-blue-200">
                        <h4 class="font-semibold text-blue-800 mb-2">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà</h4>
                        <div class="grid grid-cols-2 gap-4 text-sm">
                            <div><strong>‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà:</strong> ${officer.id}</div>
                            <div><strong>‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô:</strong> ${officer.name}</div>
                            <div><strong>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô:</strong> ${history.length} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á</div>
                            <div><strong>‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î:</strong> ${new Date(sortedHistory[0].timestamp).toLocaleDateString('th-TH')}</div>
                        </div>
                    </div>
                    
                    <div class="overflow-x-auto">
                        <table class="min-w-full bg-white border border-gray-200 rounded-lg">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-4 py-3 text-center text-sm font-medium text-gray-700">‡∏•‡∏≥‡∏î‡∏±‡∏ö</th>
                                    <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•‡πÄ‡∏î‡∏¥‡∏°</th>
                                    <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•‡πÉ‡∏´‡∏°‡πà</th>
                                    <th class="px-4 py-3 text-center text-sm font-medium text-gray-700">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô</th>
                                    <th class="px-4 py-3 text-center text-sm font-medium text-gray-700">‡∏ú‡∏π‡πâ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${historyRows}
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="mt-6 p-3 bg-yellow-50 border border-yellow-200 rounded-lg">
                        <p class="text-sm text-yellow-800">
                            <strong>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏:</strong> ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•‡∏à‡∏∞‡∏°‡∏µ‡∏ú‡∏•‡∏ï‡πà‡∏≠‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡πÉ‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏≠‡∏ö‡∏£‡∏° 
                            ‡πÇ‡∏î‡∏¢‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏ä‡∏∑‡πà‡∏≠ ‡∏ì ‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏≠‡∏ö‡∏£‡∏°‡∏ô‡∏±‡πâ‡∏ô ‡πÜ
                        </p>
                    </div>
                    
                    <div class="flex justify-end mt-6">
                        <button onclick="hideModal()" class="px-6 py-2 bg-gray-300 text-gray-700 rounded hover:bg-gray-400 transition-colors">‡∏õ‡∏¥‡∏î</button>
                    </div>
                </div>
            `;
            
            showModal(content);
        }

        function showAddOrgModal() { alert('‡∏ü‡∏µ‡πÄ‡∏à‡∏≠‡∏£‡πå‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà - ‡∏à‡∏∞‡∏û‡∏±‡∏í‡∏ô‡∏≤‡πÉ‡∏ô‡∏≠‡∏ô‡∏≤‡∏Ñ‡∏ï'); }
        function showAddUserModal() {
            const content = `
                <h3 class="text-lg font-bold text-dark-green mb-4">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà</h3>
                <form id="addUserForm">
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</label>
                            <input type="text" id="addUserUsername" placeholder="‡πÄ‡∏ä‡πà‡∏ô admin01, officer001" class="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-medium-green" required>
                            <p class="text-xs text-gray-500 mt-1">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏à‡∏∞‡πÉ‡∏ä‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</label>
                            <input type="text" id="addUserName" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ô‡∏≤‡∏¢‡∏™‡∏°‡∏ä‡∏≤‡∏¢ ‡πÉ‡∏à‡∏î‡∏µ" class="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-medium-green" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</label>
                            <input type="password" id="addUserPassword" placeholder="‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 6 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£" class="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-medium-green" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</label>
                            <input type="password" id="addUserConfirmPassword" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á" class="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-medium-green" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</label>
                            <select id="addUserRole" class="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-medium-green" required>
                                <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</option>
                                <option value="officer">‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà</option>
                                <option value="admin">‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô</label>
                            <select id="addUserOrgId" class="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-medium-green" required>
                                <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô</option>
                            </select>
                        </div>
                    </div>
                    <div class="flex justify-end space-x-2 mt-6">
                        <button type="button" onclick="hideModal()" class="px-4 py-2 bg-gray-300 text-gray-700 rounded hover:bg-gray-400">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                        <button type="submit" class="px-4 py-2 bg-medium-green text-white rounded hover:bg-dark-green">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</button>
                    </div>
                </form>
            `;
            showModal(content);
            
            // Populate organization dropdown using centralized function
            populateOrganizationDropdowns();
            
            document.getElementById('addUserForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                await addNewUser();
            });
        }
        
        async function addNewUser() {
            try {
                const username = document.getElementById('addUserUsername').value.trim();
                const name = document.getElementById('addUserName').value.trim();
                const password = document.getElementById('addUserPassword').value;
                const confirmPassword = document.getElementById('addUserConfirmPassword').value;
                const role = document.getElementById('addUserRole').value;
                const orgId = document.getElementById('addUserOrgId').value;
                
                // Validation
                if (!username || !name || !password || !confirmPassword || !role || !orgId) {
                    alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô');
                    return;
                }
                
                if (password.length < 6) {
                    alert('‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 6 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£');
                    return;
                }
                
                if (password !== confirmPassword) {
                    alert('‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô');
                    return;
                }
                
                // Check if username already exists
                const existingUser = users.find(u => u.username === username);
                if (existingUser) {
                    alert('‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö');
                    return;
                }
                
                // ‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô‡∏à‡∏≤‡∏Å‡∏£‡∏´‡∏±‡∏™
                const selectedOrg = organizations.find(org => org.id === orgId);
                
                const newUser = {
                    username: username,
                    name: name,
                    password: password,
                    role: role,
                    orgId: orgId,
                    organization: selectedOrg.name,
                    createdAt: new Date().toISOString()
                };
                
                // Add to local array
                users.push(newUser);
                
                // Save to Firebase
                const userRef = window.firebasePush(window.firebaseRef(window.firebaseDatabase, 'users'));
                await window.firebaseSet(userRef, newUser);
                
                const org = organizations.find(o => o.id === orgId);
                await logActivity('‡πÄ‡∏û‡∏¥‡πà‡∏°', `‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà: ${name} (${username}) - ${role === 'admin' ? '‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö' : '‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà'} - ${org ? org.name : orgId}`);
                
                hideModal();
                loadUserAccountsData(); // Refresh user accounts data
                alert('‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
                
            } catch (error) {
                console.error('Error adding user:', error);
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô');
            }
        }
        // Edit and Delete functions
        function editMember(id) {
            const officer = officers.find(o => o.id === id);
            if (!officer) {
                alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà');
                return;
            }
            
            const content = `
                <h3 class="text-lg font-bold text-dark-green mb-4">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</h3>
                <div id="viewMode">
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà</label>
                            <div class="w-full px-3 py-2 text-gray-800 bg-gray-50 rounded border border-gray-200">
                                ${officer.id}
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</label>
                            <div class="w-full px-3 py-2 text-gray-800 bg-gray-50 rounded border border-gray-200">
                                ${officer.name || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</label>
                            <div class="w-full px-3 py-2 text-gray-800 bg-gray-50 rounded border border-gray-200">
                                ${positions && positions.find ? (positions.find(pos => pos && pos.id === officer.position_id)?.name || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏') : '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå</label>
                            <div class="w-full px-3 py-2 text-gray-800 bg-gray-50 rounded border border-gray-200">
                                ${officer.phone || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">‡∏≠‡∏µ‡πÄ‡∏°‡∏•</label>
                            <div class="w-full px-3 py-2 text-gray-800 bg-gray-50 rounded border border-gray-200">
                                ${officer.email || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô</label>
                            <div class="w-full px-3 py-2 text-gray-800 bg-gray-50 rounded border border-gray-200">
                                ${officer.organization || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}
                            </div>
                        </div>
                    </div>
                    <div class="flex justify-end space-x-2 mt-6">
                        <button type="button" onclick="hideModal()" class="px-4 py-2 bg-gray-300 text-gray-700 rounded hover:bg-gray-400">‡∏õ‡∏¥‡∏î</button>
                        <button type="button" onclick="toggleEditMode()" class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                    </div>
                </div>
                
                <div id="editMode" style="display: none;">
                    <form id="editMemberForm">
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà</label>
                                <input type="text" id="editMemberOfficerId" value="${officer.id}" class="w-full px-3 py-2 border border-gray-300 rounded bg-gray-100" readonly>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</label>
                                <input type="text" id="editMemberName" value="${officer.name}" class="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-medium-green" required>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</label>
                                <select id="editMemberPositionId" class="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-medium-green" required>
                                    <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå</label>
                                <input type="tel" id="editMemberPhone" value="${officer.phone}" class="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-medium-green" required>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">‡∏≠‡∏µ‡πÄ‡∏°‡∏•</label>
                                <input type="email" id="editMemberEmail" value="${officer.email}" class="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-medium-green" required>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô</label>
                                <select id="editMemberOrgId" class="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-medium-green" required>
                                    <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô</option>
                                </select>
                            </div>
                        </div>
                        <div class="flex justify-end space-x-2 mt-6">
                            <button type="button" onclick="toggleEditMode()" class="px-4 py-2 bg-gray-300 text-gray-700 rounded hover:bg-gray-400">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                            <button type="submit" class="px-4 py-2 bg-medium-green text-white rounded hover:bg-dark-green">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                        </div>
                    </form>
                </div>
            `;
            showModal(content);
            
            // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏•‡∏±‡∏ö‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á view ‡πÅ‡∏•‡∏∞ edit mode
            window.toggleEditMode = function() {
                const viewMode = document.getElementById('viewMode');
                const editMode = document.getElementById('editMode');
                const isEditMode = editMode.style.display !== 'none';
                
                if (isEditMode) {
                    // ‡∏™‡∏•‡∏±‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ view mode
                    viewMode.style.display = 'block';
                    editMode.style.display = 'none';
                } else {
                    // ‡∏™‡∏•‡∏±‡∏ö‡πÑ‡∏õ edit mode
                    viewMode.style.display = 'none';
                    editMode.style.display = 'block';
                    
                    // Populate position dropdown
                    const positionSelect = document.getElementById('editMemberPositionId');
                    if (positionSelect && positionSelect.options.length <= 1) { // ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ populate
                        console.log('üë§ Populating position dropdown. Current officer.position_id:', officer.position_id);
                        console.log('üìã Available positions:', positions && positions.map ? positions.map(p => ({ id: p.id, name: p.name })) : 'positions not available');
                        
                        if (positions && Array.isArray(positions)) {
                            positions.forEach(pos => {
                                if (pos && pos.id && pos.name) {
                                    const option = document.createElement('option');
                                    option.value = pos.id;
                                    option.textContent = pos.name;
                                    
                                    if (pos.id === officer.position_id) {
                                        option.selected = true;
                                        console.log('‚úÖ Selected position:', pos.name, '(ID:', pos.id, ')');
                                    }
                                    positionSelect.appendChild(option);
                                }
                            });
                        }
                    }
                    
                    // Populate organization dropdown (‡∏ó‡∏±‡πâ‡∏á admin ‡πÅ‡∏•‡∏∞ officer ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ)
                    if (userRole === 'admin' || userRole === 'officer') {
                        const orgSelect = document.getElementById('editMemberOrgId');
                        if (orgSelect) {
                            console.log('üè¢ Populating org dropdown. Current officer.orgId:', officer.orgId, 'officer.organization:', officer.organization);
                            
                            // Use centralized function to populate
                            populateOrganizationDropdowns();
                            
                            // Set selected value after populating
                            setTimeout(() => {
                                if (officer.orgId) {
                                    orgSelect.value = officer.orgId;
                                } else {
                                    // Try to find by organization name if orgId is not available
                                    const orgByName = organizations.find(org => org.name === officer.organization);
                                    if (orgByName) {
                                        orgSelect.value = orgByName.id;
                                    }
                                }
                                console.log('‚úÖ Selected organization value:', orgSelect.value);
                            }, 0);
                        }
                    }
                }
            };
            
            // Event listener ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö form submit
            const editForm = document.getElementById('editMemberForm');
            if (editForm) {
                editForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    await updateMember(id);
                });
            }
        }
        
        async function updateMember(id) {
            try {
                const name = document.getElementById('editMemberName').value.trim();
                const positionId = document.getElementById('editMemberPositionId').value;
                const phone = document.getElementById('editMemberPhone').value.trim();
                const email = document.getElementById('editMemberEmail').value.trim();
                const orgId = document.getElementById('editMemberOrgId').value;
                
                // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö officer ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö orgId ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏î‡πâ
                if (userRole === 'admin') {
                    if (!name || !positionId || !phone || !email || !orgId) {
                        alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô');
                        return;
                    }
                } else {
                    if (!name || !positionId || !phone || !email) {
                        alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô');
                        return;
                    }
                }
                
                const officer = officers.find(o => o.id === id);
                if (officer) {
                    const oldOrgId = officer.orgId; // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ñ‡πà‡∏≤‡πÄ‡∏Å‡πà‡∏≤‡πÑ‡∏ß‡πâ‡∏Å‡πà‡∏≠‡∏ô
                    const oldOrg = organizations.find(o => o.id === oldOrgId);
                    const newOrg = organizations.find(o => o.id === orgId);
                    const oldData = `${officer.name}, ${officer.phone}, ${officer.email}, ${oldOrg ? oldOrg.name : oldOrgId}`;
                    
                    console.log('üîÑ Updating officer:', { id, oldOrgId, newOrgId: orgId, newOrgName: newOrg?.name });
                    
                    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•
                    if (officer.name !== name) {
                        console.log('üìù Name change detected:', { oldName: officer.name, newName: name });
                        await recordNameChange(officer.id, officer.name, name);
                    }
                    
                    officer.name = name;
                    officer.position_id = positionId;
                    officer.phone = phone;
                    officer.email = email;
                    
                    // ‡∏ó‡∏±‡πâ‡∏á admin ‡πÅ‡∏•‡∏∞ officer ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ
                    if (orgId !== oldOrgId) {
                        officer.orgId = orgId;
                        officer.organization = newOrg ? newOrg.name : orgId;
                        console.log('üîÑ Organization changed:', { oldOrgId, newOrgId: orgId, newOrgName: newOrg?.name });
                        
                        // ‡∏´‡∏≤‡∏Å‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏¢‡πâ‡∏≤‡∏¢‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô ‡πÉ‡∏´‡πâ‡∏™‡πà‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á
                        if (orgId && newOrg) {
                            await handleOrganizationTransfer(officer, oldOrg, newOrg);
                        }
                    }
                    
                    officer.updatedAt = new Date().toISOString();
                    
                    console.log('‚úÖ Officer updated successfully:', officer);
                    
                    console.log('üíæ Saving to Firebase...');
                    await saveToFirebase('officers', officers);
                    console.log('‚úÖ Officers data saved to Firebase');
                    
                    // Initialize confirmation status for new organization if needed (only if org changed)
                    if (userRole === 'admin' && orgId !== oldOrgId && !confirmationStatus[orgId]) {
                        console.log('üÜï Creating confirmation status for new org:', orgId);
                        confirmationStatus[orgId] = { teamConfirmed: false, orgConfirmed: false };
                        await saveToFirebase('confirmationStatus', confirmationStatus);
                        console.log('‚úÖ Initialized confirmation status for new org:', orgId);
                    }
                    
                    const newData = `${name}, ${phone}, ${email}, ${newOrg ? newOrg.name : orgId}`;
                    console.log('üìù Logging activity...');
                    await logActivity('‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç', `‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å ${id}`, oldData, newData);
                    console.log('‚úÖ Activity logged successfully');
                    
                    console.log('‚úÖ Member updated successfully, refreshing displays immediately...');
                    
                    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô view mode
                    const viewName = document.querySelector('#viewMode .space-y-4 > div:nth-child(2) > div');
                    const viewPhone = document.querySelector('#viewMode .space-y-4 > div:nth-child(3) > div');
                    const viewEmail = document.querySelector('#viewMode .space-y-4 > div:nth-child(4) > div');
                    
                    if (viewName) viewName.textContent = name;
                    if (viewPhone) viewPhone.textContent = phone;
                    if (viewEmail) viewEmail.textContent = email;
                    
                    // ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ view mode
                    toggleEditMode();
                    
                    // Force immediate table update without any delays
                    console.log('üîÑ IMMEDIATE table refresh with updated officer data...');
                    console.log('Updated officer:', officer);
                    
                    // ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡πÇ‡∏î‡∏¢‡πÑ‡∏°‡πà‡∏û‡∏∂‡πà‡∏á‡∏û‡∏≤ filter ‡∏´‡∏£‡∏∑‡∏≠ delay
                    refreshOfficerTableImmediate();
                    
                    alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
                    
                    // ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Firebase ‡πÉ‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å alert
                    setTimeout(() => {
                        loadTeamData();
                    }, 500);
                }
                
            } catch (error) {
                console.error('Error updating member:', error);
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•');
            }
        }
        
        async function deleteMember(id) {
            const officer = officers.find(o => o.id === id);
            if (!officer) {
                alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å');
                return;
            }
            
            // ‡πÅ‡∏¢‡∏Å‡∏û‡∏§‡∏ï‡∏¥‡∏Å‡∏£‡∏£‡∏°‡∏ï‡∏≤‡∏° role ‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ
            if (userRole === 'admin') {
                // Admin: ‡∏•‡∏ö‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                
                // ‡∏Ç‡∏≠‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö
                const reason = prompt(`‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö "${officer.name}" ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö\n\n‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö:`);
                if (!reason || reason.trim() === '') {
                    alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö');
                    return;
                }
                
                if (!confirm(`‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö "${officer.name}" ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö\n\n‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•: ${reason.trim()}\n\n‚ö†Ô∏è ‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏à‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î`)) {
                    return;
                }
                
                try {
                    const currentOrg = organizations.find(o => o.id === officer.orgId);
                    const orgName = currentOrg ? currentOrg.name : officer.organization || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
                    
                    // Remove from local array
                    const index = officers.findIndex(o => o.id === id);
                    officers.splice(index, 1);
                    
                    // Remove training data
                    if (trainingData[id]) {
                        delete trainingData[id];
                        await saveToFirebase('trainingData', trainingData);
                    }
                    
                    await saveToFirebase('officers', officers);
                    await logActivity('‡∏•‡∏ö', `‡∏•‡∏ö‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö: ${officer.name} (${id}) ‡∏à‡∏≤‡∏Å‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô: ${orgName} | ‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏•‡∏ö: ${reason.trim()}`);
                    
                    loadTeamData();
                    alert(`‡∏•‡∏ö "${officer.name}" ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß\n\n‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•: ${reason.trim()}`);
                    
                } catch (error) {
                    console.error('Error deleting member:', error);
                    alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å');
                }
                
            } else {
                // Officer: ‡∏•‡∏ö‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô (‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏)
                const currentOrg = organizations.find(o => o.id === officer.orgId);
                const orgName = currentOrg ? currentOrg.name : officer.organization || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
                
                // ‡∏Ç‡∏≠‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö
                const reason = prompt(`‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö "${officer.name}" ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô "${orgName}" \n\n‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö:`);
                if (!reason || reason.trim() === '') {
                    alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö');
                    return;
                }
                
                if (!confirm(`‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö "${officer.name}" ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô "${orgName}"\n\n‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•: ${reason.trim()}\n\n‚Ä¢ ‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô\n‚Ä¢ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏∞‡∏¢‡∏±‡∏á‡∏Ñ‡∏á‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö ‡πÅ‡∏ï‡πà‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô‡∏à‡∏∞‡πÄ‡∏õ‡πá‡∏ô "‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏"\n‚Ä¢ Admin ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏°‡∏≠‡∏ö‡∏´‡∏°‡∏≤‡∏¢‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏î‡πâ`)) {
                    return;
                }
                
                try {
                    // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠ log
                    const oldData = `${officer.name}, ${officer.phone}, ${officer.email}, ${orgName}`;
                    
                    // ‡∏•‡∏ö‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô
                    officer.orgId = null;
                    officer.organization = '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
                    officer.removedFromOrgAt = new Date().toISOString();
                    officer.removedBy = currentUser?.name || '‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà';
                    officer.removedReason = reason.trim();
                    officer.updatedAt = new Date().toISOString();
                    
                    await saveToFirebase('officers', officers);
                    
                    const newData = `${officer.name}, ${officer.phone}, ${officer.email}, ‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏`;
                    await logActivity('‡∏•‡∏ö', `‡∏•‡∏ö‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô: ${officer.name} (${id}) ‡∏à‡∏≤‡∏Å‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô: ${orgName} | ‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏•‡∏ö: ${reason.trim()} | ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏õ‡πá‡∏ô: ‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏`, oldData, newData);
                    
                    // ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                    refreshOfficerTableImmediate();
                    
                    alert(`‡∏•‡∏ö "${officer.name}" ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô "${orgName}" ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß\n\n‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•: ${reason.trim()}\n‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏¢‡∏±‡∏á‡∏Ñ‡∏á‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö ‡πÅ‡∏ï‡πà‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô‡∏à‡∏∞‡πÄ‡∏õ‡πá‡∏ô "‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏"`);
                    
                } catch (error) {
                    console.error('Error removing member from organization:', error);
                    alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô');
                }
            }
        }
        
        function editOfficer(id) {
            editMember(id); // Use the same function as editMember
        }
        
        function deleteOfficer(id) {
            deleteMember(id); // Use the same function as deleteMember
        }
        // Organization management functions
        function editOrganization(id) {
            const organization = organizations.find(o => o.id === id);
            if (!organization) {
                alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô');
                return;
            }
            
            const content = `
                <h3 class="text-lg font-bold text-dark-green mb-4">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô</h3>
                <div id="orgViewMode">
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">‡∏£‡∏´‡∏±‡∏™‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô</label>
                            <div class="w-full px-3 py-2 text-gray-800 bg-gray-50 rounded border border-gray-200">
                                ${organization.id}
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô</label>
                            <div class="w-full px-3 py-2 text-gray-800 bg-gray-50 rounded border border-gray-200">
                                ${organization.name || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå</label>
                            <div class="w-full px-3 py-2 text-gray-800 bg-gray-50 rounded border border-gray-200">
                                ${organization.phone || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">‡πÇ‡∏ó‡∏£‡∏™‡∏≤‡∏£</label>
                            <div class="w-full px-3 py-2 text-gray-800 bg-gray-50 rounded border border-gray-200">
                                ${organization.fax || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">‡∏≠‡∏µ‡πÄ‡∏°‡∏•</label>
                            <div class="w-full px-3 py-2 text-gray-800 bg-gray-50 rounded border border-gray-200">
                                ${organization.email || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà</label>
                            <div class="w-full px-3 py-2 text-gray-800 bg-gray-50 rounded border border-gray-200 min-h-[80px]">
                                ${organization.address || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}
                            </div>
                        </div>
                    </div>
                    <div class="flex justify-end space-x-2 mt-6">
                        <button type="button" onclick="hideModal()" class="px-4 py-2 bg-gray-300 text-gray-700 rounded hover:bg-gray-400">‡∏õ‡∏¥‡∏î</button>
                        <button type="button" onclick="toggleOrgEditMode()" class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                    </div>
                </div>
                
                <div id="orgEditMode" style="display: none;">
                    <form id="editOrgForm">
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">‡∏£‡∏´‡∏±‡∏™‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô</label>
                                <input type="text" id="editOrgId" value="${organization.id}" class="w-full px-3 py-2 border border-gray-300 rounded bg-gray-100" readonly>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô</label>
                                <input type="text" id="editOrgName" value="${organization.name}" class="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-medium-green" required>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå</label>
                                <input type="tel" id="editOrgPhone" value="${organization.phone || ''}" class="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-medium-green">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">‡πÇ‡∏ó‡∏£‡∏™‡∏≤‡∏£</label>
                                <input type="tel" id="editOrgFax" value="${organization.fax || ''}" class="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-medium-green">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">‡∏≠‡∏µ‡πÄ‡∏°‡∏•</label>
                                <input type="email" id="editOrgEmail" value="${organization.email || ''}" class="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-medium-green">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà</label>
                                <textarea id="editOrgAddress" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-medium-green">${organization.address || ''}</textarea>
                            </div>
                        </div>
                        <div class="flex justify-end space-x-2 mt-6">
                            <button type="button" onclick="toggleOrgEditMode()" class="px-4 py-2 bg-gray-300 text-gray-700 rounded hover:bg-gray-400">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                            <button type="submit" class="px-4 py-2 bg-medium-green text-white rounded hover:bg-dark-green">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                        </div>
                    </form>
                </div>
            `;
            showModal(content);
            
            // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏•‡∏±‡∏ö‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á view ‡πÅ‡∏•‡∏∞ edit mode ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô
            window.toggleOrgEditMode = function() {
                const viewMode = document.getElementById('orgViewMode');
                const editMode = document.getElementById('orgEditMode');
                const isEditMode = editMode.style.display !== 'none';
                
                if (isEditMode) {
                    // ‡∏™‡∏•‡∏±‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ view mode
                    viewMode.style.display = 'block';
                    editMode.style.display = 'none';
                } else {
                    // ‡∏™‡∏•‡∏±‡∏ö‡πÑ‡∏õ edit mode
                    viewMode.style.display = 'none';
                    editMode.style.display = 'block';
                }
            };
            
            // Event listener ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö form submit
            const editOrgForm = document.getElementById('editOrgForm');
            if (editOrgForm) {
                editOrgForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    await updateOrganization(id);
                });
            }
        }
        
        async function updateOrganization(id) {
            try {
                const name = document.getElementById('editOrgName').value.trim();
                const phone = document.getElementById('editOrgPhone').value.trim();
                const fax = document.getElementById('editOrgFax').value.trim();
                const email = document.getElementById('editOrgEmail').value.trim();
                const address = document.getElementById('editOrgAddress').value.trim();
                
                if (!name) {
                    alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô');
                    return;
                }
                
                if (email && !email.includes('@')) {
                    alert('‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
                    return;
                }
                
                const organization = organizations.find(o => o.id === id);
                if (organization) {
                    const oldData = `${organization.name}, ${organization.phone || ''}, ${organization.fax || ''}, ${organization.email || ''}, ${organization.address || ''}`;
                    
                    organization.name = name;
                    organization.phone = phone;
                    organization.fax = fax;
                    organization.email = email;
                    organization.address = address;
                    organization.updatedAt = new Date().toISOString();
                    
                    await saveToFirebase('organizations', organizations);
                    
                    const newData = `${name}, ${phone}, ${fax}, ${email}, ${address}`;
                    await logActivity('‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç', `‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô ${id}`, oldData, newData);
                    
                    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô view mode
                    const viewName = document.querySelector('#orgViewMode .space-y-4 > div:nth-child(2) > div');
                    const viewPhone = document.querySelector('#orgViewMode .space-y-4 > div:nth-child(3) > div');
                    const viewFax = document.querySelector('#orgViewMode .space-y-4 > div:nth-child(4) > div');
                    const viewEmail = document.querySelector('#orgViewMode .space-y-4 > div:nth-child(5) > div');
                    const viewAddress = document.querySelector('#orgViewMode .space-y-4 > div:nth-child(6) > div');
                    
                    if (viewName) viewName.textContent = name || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
                    if (viewPhone) viewPhone.textContent = phone || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
                    if (viewFax) viewFax.textContent = fax || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
                    if (viewEmail) viewEmail.textContent = email || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
                    if (viewAddress) viewAddress.textContent = address || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
                    
                    // ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ view mode
                    toggleOrgEditMode();
                    
                    loadOrganizationsData();
                    loadTeamData(); // Refresh team data too in case organization name changed
                    loadAllOfficersData(); // Refresh officers data
                    alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
                }
                
            } catch (error) {
                console.error('Error updating organization:', error);
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô');
            }
        }
        
        // Reset confirmation status for organization
        async function resetConfirmationStatus(orgId) {
            try {
                // ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô
                const org = organizations.find(o => o.id === orgId);
                if (!org) {
                    alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô');
                    return;
                }
                
                // ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï
                const confirmMessage = `‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Ç‡∏≠‡∏á‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô "${org.name}" ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?\n\n‡∏Å‡∏≤‡∏£‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏à‡∏∞‡∏ó‡∏≥‡πÉ‡∏´‡πâ:\n‚Ä¢ ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô‡πÄ‡∏õ‡πá‡∏ô "‡∏£‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô"\n‚Ä¢ ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ó‡∏µ‡∏°‡πÄ‡∏õ‡πá‡∏ô "‡∏£‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô"\n‚Ä¢ ‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á`;
                
                if (!confirm(confirmMessage)) {
                    return;
                }
                
                console.log('üîÑ Resetting confirmation status for org:', orgId);
                
                // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô
                confirmationStatus[orgId] = {
                    teamConfirmed: false,
                    orgConfirmed: false,
                    resetAt: new Date().toISOString(),
                    resetBy: currentUser?.name || 'Admin'
                };
                
                // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á Firebase
                await saveToFirebase('confirmationStatus', confirmationStatus);
                
                // Log activity
                await logActivity('‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï', `‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô ${org.name} (${orgId})`);
                
                console.log('‚úÖ Confirmation status reset successfully for:', orgId);
                
                // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
                loadOrganizationsData();
                
                alert(`‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Ç‡∏≠‡∏á‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô "${org.name}" ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß\n\n‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡∏∞‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏î‡πâ`);
                
            } catch (error) {
                console.error('Error resetting confirmation status:', error);
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô');
            }
        }
        
        // Reset confirmation status for all organizations
        async function resetAllConfirmationStatus() {
            try {
                // ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                const confirmMessage = `‚ö†Ô∏è ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Ç‡∏≠‡∏á‡∏ó‡∏∏‡∏Å‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?\n\n‡∏Å‡∏≤‡∏£‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏à‡∏∞‡∏ó‡∏≥‡πÉ‡∏´‡πâ:\n‚Ä¢ ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏∏‡∏Å‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô‡πÄ‡∏õ‡πá‡∏ô "‡∏£‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô"\n‚Ä¢ ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ó‡∏µ‡∏°‡∏ó‡∏∏‡∏Å‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô‡πÄ‡∏õ‡πá‡∏ô "‡∏£‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô"\n‚Ä¢ ‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á\n\n‚ö†Ô∏è ‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏î‡πâ!`;
                
                if (!confirm(confirmMessage)) {
                    return;
                }
                
                // ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢
                if (!confirm('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á: ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ó‡∏∏‡∏Å‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) {
                    return;
                }
                
                console.log('üîÑ Resetting confirmation status for all organizations...');
                
                // ‡∏ô‡∏±‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï
                const orgCount = organizations.length;
                const resetTime = new Date().toISOString();
                const resetBy = currentUser?.name || 'Admin';
                
                // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ó‡∏∏‡∏Å‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô
                organizations.forEach(org => {
                    confirmationStatus[org.id] = {
                        teamConfirmed: false,
                        orgConfirmed: false,
                        resetAt: resetTime,
                        resetBy: resetBy
                    };
                });
                
                // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á Firebase
                await saveToFirebase('confirmationStatus', confirmationStatus);
                
                // Log activity
                await logActivity('‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î', `‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ó‡∏∏‡∏Å‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô (${orgCount} ‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô)`);
                
                console.log(`‚úÖ Reset confirmation status for ${orgCount} organizations`);
                
                // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
                loadOrganizationsData();
                
                alert(`‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß\n\n‚Ä¢ ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô: ${orgCount} ‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô\n‚Ä¢ ‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡∏∞‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏î‡πâ`);
                
            } catch (error) {
                console.error('Error resetting all confirmation status:', error);
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô');
            }
        }
        
        async function deleteOrganization(id) {
            if (!confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà? (‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡πÉ‡∏ô‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏¢‡∏±‡∏á‡∏Ñ‡∏á‡∏≠‡∏¢‡∏π‡πà)')) {
                return;
            }
            
            // Check if any officers belong to this organization
            const officersInOrg = officers.filter(o => o.orgId === id);
            if (officersInOrg.length > 0) {
                alert(`‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏ö‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ‡πÑ‡∏î‡πâ ‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡∏°‡∏µ‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà ${officersInOrg.length} ‡∏Ñ‡∏ô‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ`);
                return;
            }
            
            try {
                const organization = organizations.find(o => o.id === id);
                if (organization) {
                    // Remove from local array
                    const index = organizations.findIndex(o => o.id === id);
                    organizations.splice(index, 1);
                    
                    // Remove confirmation status
                    if (confirmationStatus[id]) {
                        delete confirmationStatus[id];
                        await saveToFirebase('confirmationStatus', confirmationStatus);
                    }
                    
                    await saveToFirebase('organizations', organizations);
                    await logActivity('‡∏•‡∏ö', `‡∏•‡∏ö‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô: ${organization.name} (${id})`);
                    
                    // Refresh dropdowns after organization change
                    populateOrganizationDropdowns();
                    loadOrganizationsData();
                    alert('‡∏•‡∏ö‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
                }
                
            } catch (error) {
                console.error('Error deleting organization:', error);
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô');
            }
        }
        
        // User management functions
        function editUser(username) {
            const user = users.find(u => u.username === username);
            if (!user) {
                alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô');
                return;
            }
            
            const content = `
                <h3 class="text-lg font-bold text-dark-green mb-4">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</h3>
                <form id="editUserForm">
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</label>
                            <input type="text" id="editUserUsername" value="${user.username}" class="w-full px-3 py-2 border border-gray-300 rounded bg-gray-100" readonly>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</label>
                            <input type="text" id="editUserName" value="${user.name}" class="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-medium-green" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</label>
                            <input type="password" id="editUserPassword" value="${user.password}" class="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-medium-green" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</label>
                            <select id="editUserRole" class="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-medium-green" required>
                                <option value="officer" ${user.role === 'officer' ? 'selected' : ''}>‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà</option>
                                <option value="admin" ${user.role === 'admin' ? 'selected' : ''}>‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô</label>
                            <select id="editUserOrgId" class="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-medium-green" required>
                                <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô</option>
                            </select>
                        </div>
                    </div>
                    <div class="flex justify-end space-x-2 mt-6">
                        <button type="button" onclick="hideModal()" class="px-4 py-2 bg-gray-300 text-gray-700 rounded hover:bg-gray-400">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                        <button type="submit" class="px-4 py-2 bg-medium-green text-white rounded hover:bg-dark-green">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                    </div>
                </form>
            `;
            showModal(content);
            
            // Populate organization dropdown
            const orgSelect = document.getElementById('editUserOrgId');
            organizations.forEach(org => {
                const option = document.createElement('option');
                option.value = org.id;
                option.textContent = org.name;
                if (org.id === user.orgId) {
                    option.selected = true;
                }
                orgSelect.appendChild(option);
            });
            
            document.getElementById('editUserForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                await updateUser(username);
            });
        }
        
        async function updateUser(username) {
            try {
                const name = document.getElementById('editUserName').value.trim();
                const password = document.getElementById('editUserPassword').value;
                const role = document.getElementById('editUserRole').value;
                const orgId = document.getElementById('editUserOrgId').value;
                
                if (!name || !password || !role || !orgId) {
                    alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô');
                    return;
                }
                
                if (password.length < 6) {
                    alert('‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 6 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£');
                    return;
                }
                
                const user = users.find(u => u.username === username);
                if (user) {
                    const oldOrg = organizations.find(o => o.id === user.orgId);
                    const newOrg = organizations.find(o => o.id === orgId);
                    const oldData = `${user.name}, ${user.role}, ${oldOrg ? oldOrg.name : user.orgId}`;
                    
                    user.name = name;
                    user.password = password;
                    user.role = role;
                    user.orgId = orgId;
                    user.updatedAt = new Date().toISOString();
                    
                    await saveToFirebase('users', users);
                    
                    const newData = `${name}, ${role}, ${newOrg ? newOrg.name : orgId}`;
                    await logActivity('‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç', `‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô ${username}`, oldData, newData);
                    
                    hideModal();
                    loadUserAccountsData();
                    alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
                }
                
            } catch (error) {
                console.error('Error updating user:', error);
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô');
            }
        }
        
        async function deleteUser(username) {
            // ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö admin ‡∏Ñ‡∏ô‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢
            const adminUsers = users.filter(u => u.role === 'admin');
            const userToDelete = users.find(u => u.username === username);
            
            if (userToDelete && userToDelete.role === 'admin' && adminUsers.length <= 1) {
                alert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏ö‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏ô‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢‡πÑ‡∏î‡πâ');
                return;
            }
            
            // ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á
            if (currentUser && currentUser.username === username) {
                alert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏ö‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏Ç‡∏≠‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á‡πÑ‡∏î‡πâ');
                return;
            }
            
            if (!confirm(`‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô "${username}" ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?\\n\\n‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏î‡πâ`)) {
                return;
            }
            
            try {
                const user = users.find(u => u.username === username);
                if (user) {
                    // Remove from local array
                    const index = users.findIndex(u => u.username === username);
                    users.splice(index, 1);
                    
                    await saveToFirebase('users', users);
                    await logActivity('‡∏•‡∏ö', `‡∏•‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô: ${user.name} (${username})`);
                    
                    loadUserAccountsData();
                    alert('‡∏•‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
                }
                
            } catch (error) {
                console.error('Error deleting user:', error);
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô');
            }
        }
        
        // Test Firebase connection
        async function testFirebaseConnection() {
            try {
                console.log('Testing Firebase connection...');
                
                // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ Firebase services ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô
                if (!window.firebaseDatabase || !window.firebaseRef || !window.firebaseSet) {
                    throw new Error('Firebase services not available');
                }
                
                const testRef = window.firebaseRef(window.firebaseDatabase, 'connectionTest');
                await window.firebaseSet(testRef, { 
                    timestamp: Date.now(), 
                    message: 'Connection test successful',
                    userAgent: navigator.userAgent.substring(0, 50)
                });
                
                console.log('‚úÖ Firebase connection successful');
                return true;
            } catch (error) {
                console.error('‚ùå Firebase connection failed:', error);
                console.error('Error details:', {
                    message: error.message,
                    code: error.code,
                    stack: error.stack
                });
                
                // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÉ‡∏ô UI ‡πÅ‡∏ó‡∏ô alert
                showError(`‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Firebase: ${error.message}`);
                return false;
            }
        }

        // Update connection status display
        function updateConnectionStatus(isConnected, message = '') {
            const statusEl = document.getElementById('connectionStatus');
            if (statusEl) {
                if (isConnected) {
                    statusEl.innerHTML = '<span class="text-green-600">‚úÖ ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Firebase ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</span>';
                } else {
                    statusEl.innerHTML = `<span class="text-red-600">‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Firebase: ${message}</span>`;
                }
            }
        }

        // ==================== POSITION MANAGEMENT FUNCTIONS ====================
        
        // Show add position modal
        function showAddPositionModal() {
            const content = `
                <h3 class="text-lg font-bold text-dark-green mb-4">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÉ‡∏´‡∏°‡πà</h3>
                <form id="addPositionForm">
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">‡∏£‡∏´‡∏±‡∏™‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</label>
                            <input type="text" id="newPositionId" class="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-medium-green" placeholder="‡πÄ‡∏ä‡πà‡∏ô POS001" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">‡∏ä‡∏∑‡πà‡∏≠‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</label>
                            <input type="text" id="newPositionName" class="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-medium-green" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ô‡∏±‡∏Å‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏ô‡πÇ‡∏¢‡∏ö‡∏≤‡∏¢‡πÅ‡∏•‡∏∞‡πÅ‡∏ú‡∏ô" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢</label>
                            <textarea id="newPositionDescription" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-medium-green" placeholder="‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á (‡πÑ‡∏°‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô)"></textarea>
                        </div>
                    </div>
                    <div class="flex justify-end space-x-2 mt-6">
                        <button type="button" onclick="hideModal()" class="px-4 py-2 bg-gray-300 text-gray-700 rounded hover:bg-gray-400">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                        <button type="submit" class="px-4 py-2 bg-medium-green text-white rounded hover:bg-dark-green">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</button>
                    </div>
                </form>
            `;
            showModal(content);
            
            document.getElementById('addPositionForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                await addPosition();
            });
        }

        // Add new position
        async function addPosition() {
            try {
                const id = document.getElementById('newPositionId').value.trim();
                const name = document.getElementById('newPositionName').value.trim();
                const description = document.getElementById('newPositionDescription').value.trim();
                
                if (!id || !name) {
                    alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÅ‡∏•‡∏∞‡∏ä‡∏∑‡πà‡∏≠‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á');
                    return;
                }
                
                // Check if position ID already exists
                if (positions.find(pos => pos.id === id)) {
                    alert('‡∏£‡∏´‡∏±‡∏™‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏ä‡πâ‡∏£‡∏´‡∏±‡∏™‡∏≠‡∏∑‡πà‡∏ô');
                    return;
                }
                
                const newPosition = {
                    id: id,
                    name: name,
                    description: description,
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                };
                
                positions.push(newPosition);
                await saveToFirebase('positions', positions);
                await logActivity('‡πÄ‡∏û‡∏¥‡πà‡∏°', `‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÉ‡∏´‡∏°‡πà: ${name} (${id})`);
                
                hideModal();
                loadPositionsData();
                alert('‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
                
            } catch (error) {
                console.error('Error adding position:', error);
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á');
            }
        }

        // Load positions data
        function loadPositionsData() {
            displayFilteredPositions(positions);
        }

        // Display positions in table
        function displayFilteredPositions(filteredPositions) {
            const tbody = document.getElementById('positionsTableBody');
            if (!tbody) {
                console.error('‚ùå Positions table body not found');
                return;
            }
            
            if (filteredPositions.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="px-4 py-8 text-center text-gray-500">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</td></tr>';
                return;
            }
            
            console.log('üè∑Ô∏è Displaying positions:', filteredPositions.length);
            
            const rows = filteredPositions.map(position => {
                const positionId = position.id || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
                const positionName = position.name || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
                const positionDescription = position.description || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
                
                return `
                    <tr class="hover:bg-gray-50">
                        <td class="px-4 py-2">${positionId}</td>
                        <td class="px-4 py-2">${positionName}</td>
                        <td class="px-4 py-2">${positionDescription}</td>
                        <td class="px-4 py-2">
                            <div class="flex gap-2">
                                <button onclick="editPosition('${positionId}')" class="bg-blue-500 text-white px-2 py-1 rounded text-sm hover:bg-blue-600">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                                <button onclick="deletePosition('${positionId}')" class="bg-red-500 text-white px-2 py-1 rounded text-sm hover:bg-red-600">‡∏•‡∏ö</button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
            
            tbody.innerHTML = rows;
            console.log(`‚úÖ Displayed ${filteredPositions.length} positions`);
        }

        // Apply position filters
        function applyPositionFilters() {
            const searchTerm = document.getElementById('positionSearchInput').value.toLowerCase();
            
            console.log('üîç Applying position filters:', { searchTerm });
            
            const filteredPositions = positions.filter(position => {
                const searchMatch = !searchTerm || 
                    position.name.toLowerCase().includes(searchTerm) ||
                    position.id.toLowerCase().includes(searchTerm) ||
                    (position.description && position.description.toLowerCase().includes(searchTerm));
                
                return searchMatch;
            });
            
            displayFilteredPositions(filteredPositions);
        }

        // Clear position filters
        function clearPositionFilters() {
            document.getElementById('positionSearchInput').value = '';
            loadPositionsData();
        }

        // Edit position
        function editPosition(id) {
            const position = positions.find(p => p.id === id);
            if (!position) {
                alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á');
                return;
            }
            
            const content = `
                <h3 class="text-lg font-bold text-dark-green mb-4">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</h3>
                <div id="positionViewMode">
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">‡∏£‡∏´‡∏±‡∏™‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</label>
                            <div class="w-full px-3 py-2 text-gray-800 bg-gray-50 rounded border border-gray-200">
                                ${position.id}
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">‡∏ä‡∏∑‡πà‡∏≠‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</label>
                            <div class="w-full px-3 py-2 text-gray-800 bg-gray-50 rounded border border-gray-200">
                                ${position.name || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢</label>
                            <div class="w-full px-3 py-2 text-gray-800 bg-gray-50 rounded border border-gray-200 min-h-[80px]">
                                ${position.description || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}
                            </div>
                        </div>
                    </div>
                    <div class="flex justify-end space-x-2 mt-6">
                        <button type="button" onclick="hideModal()" class="px-4 py-2 bg-gray-300 text-gray-700 rounded hover:bg-gray-400">‡∏õ‡∏¥‡∏î</button>
                        <button type="button" onclick="togglePositionEditMode()" class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                    </div>
                </div>
                
                <div id="positionEditMode" style="display: none;">
                    <form id="editPositionForm">
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">‡∏£‡∏´‡∏±‡∏™‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</label>
                                <input type="text" id="editPositionId" value="${position.id}" class="w-full px-3 py-2 border border-gray-300 rounded bg-gray-100" readonly>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">‡∏ä‡∏∑‡πà‡∏≠‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</label>
                                <input type="text" id="editPositionName" value="${position.name}" class="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-medium-green" required>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢</label>
                                <textarea id="editPositionDescription" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-medium-green">${position.description || ''}</textarea>
                            </div>
                        </div>
                        <div class="flex justify-end space-x-2 mt-6">
                            <button type="button" onclick="togglePositionEditMode()" class="px-4 py-2 bg-gray-300 text-gray-700 rounded hover:bg-gray-400">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                            <button type="submit" class="px-4 py-2 bg-medium-green text-white rounded hover:bg-dark-green">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                        </div>
                    </form>
                </div>
            `;
            showModal(content);
            
            // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏•‡∏±‡∏ö‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á view ‡πÅ‡∏•‡∏∞ edit mode ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á
            window.togglePositionEditMode = function() {
                const viewMode = document.getElementById('positionViewMode');
                const editMode = document.getElementById('positionEditMode');
                const isEditMode = editMode.style.display !== 'none';
                
                if (isEditMode) {
                    // ‡∏™‡∏•‡∏±‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ view mode
                    viewMode.style.display = 'block';
                    editMode.style.display = 'none';
                } else {
                    // ‡∏™‡∏•‡∏±‡∏ö‡πÑ‡∏õ edit mode
                    viewMode.style.display = 'none';
                    editMode.style.display = 'block';
                }
            };
            
            // Event listener ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö form submit
            const editPositionForm = document.getElementById('editPositionForm');
            if (editPositionForm) {
                editPositionForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    await updatePosition(id);
                });
            }
        }

        // Update position
        async function updatePosition(id) {
            try {
                const name = document.getElementById('editPositionName').value.trim();
                const description = document.getElementById('editPositionDescription').value.trim();
                
                if (!name) {
                    alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á');
                    return;
                }
                
                const position = positions.find(p => p.id === id);
                if (position) {
                    const oldData = `${position.name}, ${position.description || ''}`;
                    
                    position.name = name;
                    position.description = description;
                    position.updatedAt = new Date().toISOString();
                    
                    await saveToFirebase('positions', positions);
                    
                    const newData = `${name}, ${description}`;
                    await logActivity('‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç', `‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á ${id}`, oldData, newData);
                    
                    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô view mode
                    const viewName = document.querySelector('#positionViewMode .space-y-4 > div:nth-child(2) > div');
                    const viewDescription = document.querySelector('#positionViewMode .space-y-4 > div:nth-child(3) > div');
                    
                    if (viewName) viewName.textContent = name || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
                    if (viewDescription) viewDescription.textContent = description || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
                    
                    // ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ view mode
                    togglePositionEditMode();
                    
                    loadPositionsData();
                    alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
                }
                
            } catch (error) {
                console.error('Error updating position:', error);
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á');
            }
        }

        // Delete position
        async function deletePosition(id) {
            if (!confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) {
                return;
            }
            
            // Check if any officers have this position
            const officersWithPosition = officers.filter(o => o.positionId === id);
            if (officersWithPosition.length > 0) {
                alert(`‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏ö‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ô‡∏µ‡πâ‡πÑ‡∏î‡πâ ‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡∏°‡∏µ‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà ${officersWithPosition.length} ‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ô‡∏µ‡πâ`);
                return;
            }
            
            try {
                const position = positions.find(p => p.id === id);
                if (position) {
                    // Remove from local array
                    const index = positions.findIndex(p => p.id === id);
                    positions.splice(index, 1);
                    
                    await saveToFirebase('positions', positions);
                    await logActivity('‡∏•‡∏ö', `‡∏•‡∏ö‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á: ${position.name} (${id})`);
                    
                    loadPositionsData();
                    alert('‡∏•‡∏ö‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
                }
                
            } catch (error) {
                console.error('Error deleting position:', error);
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á');
            }
        }

        // Initialize Firebase data when page loads
        window.addEventListener('load', async function() {
            // ‡∏£‡∏≠‡πÉ‡∏´‡πâ Firebase SDK ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            const connectionOk = await testFirebaseConnection();
            if (connectionOk) {
                updateConnectionStatus(true);
                await initializeFirebaseData();
            } else {
                updateConnectionStatus(false, '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤');
            }
        });
    </script>

    <!-- Modal containers -->
    <div id="officerDetailsModal" class="hidden"></div>

<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9840a241618b45b3',t:'MTc1ODY5OTYyOC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
